(function(){"use strict";const Vt={sand:1,water:2,dirt:3,stone:4,plant:5,fire:6,gas:7,fluff:8,bug:9,plasma:10,nitro:11,glass:12,lightning:13,slime:14,ant:15,alien:16,quark:17,crystal:18,ember:19,static:20,bird:21,gunpowder:22,tap:23,anthill:24,bee:25,flower:26,hive:27,honey:28,nest:29,gun:30,cloud:40,acid:41,lava:42,snow:43,volcano:44,mold:45,mercury:46,void:47,seed:48,rust:49,spore:50,algae:51,poison:52,dust:53,firework:54,bubble:55,glitter:56,star:57,comet:58,blackhole:60,firefly:61,worm:62,fairy:63,fish:64,moth:65,vent:66},wt=1600,pt=1e3,Ut=4;function $(t,n,e){n/=100,e/=100;const T=n*Math.min(e,1-e),c=M=>{const i=(M+t/30)%12;return e-T*Math.max(Math.min(i-3,9-i,1),-1)};return 255<<24|Math.round(c(4)*255)<<16|Math.round(c(8)*255)<<8|Math.round(c(0)*255)}const Y=new Uint32Array([4279900698,4285450470,4292448330,4281031307,4284900966,4280453922,0,4287137928,4292077301,4290013695,0,4279566137,4293580968,0,4281519514,4279904875,4278255360,4294902015,4294955136,4280303871,4294967108,4293454056,4281348144,4290822336,4281368752,4278245631,4294919372,4282431720,4281377023,4286611616,4283453520,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282703359,4292399304,4278255551,4279506140,4294963424,4278190182,4293814395,4291346616,4283697198,4285834708,4279124407,4289376800,4282216485,4287299723,4287084766,4278216447,4293643911,4290822336,4278247423,4294965629,4294938654,4278190080,4278255551,4286615744,4294936831,4278232575,4287411410,4284512352]),Ft=new Uint32Array(32),Bt=new Uint32Array(64),_t=new Uint32Array(32),Ct=new Uint32Array(32);for(let t=0;t<32;t++)Ft[t]=$(10+t,100,50+t/32*20),_t[t]=$(50+t/32*20,100,80+t/32*20),Ct[t]=$(200+t/32*20,100,50+t/32*30);for(let t=0;t<64;t++)Bt[t]=$(t<32?280+t:320+(t-32),100,60+t/64*25);const g=4279900698,Kt=12,qt=6,jt=8,Xt=7,Qt=15,zt=10,Zt=16,Wt=1,Dt=2,rt=4,Jt=8,$t=16,gt=32,te=64,ee=128,ie=256,bt=512,ne=1024,oe=2048,fe=4096,tt=8192,et=16384,Tt=32768,lt=65536,it=1<<17,nt=1<<18,dt=1<<19,Ee=1<<20,se=1<<21,ce=1<<22,h=[];h[0]=null,h[1]={gravity:.95,density:5,color:Y[1]},h[3]={gravity:.95,density:4,color:Y[3]},h[22]={gravity:.95,density:4,explosive:[6,0],flammable:!0,color:Y[22]},h[43]={gravity:.25,meltOnHeat:2,color:Y[43]},h[49]={gravity:.1,volatile:[.005,3],infectiousHandler:!0,color:Y[49]},h[8]={gravity:.3,flammable:!0,color:Y[8]},h[53]={gravity:.3,flammable:!0,explosive:[2,0],volatile:[.003,1],color:Y[53]},h[56]={gravity:.3,volatile:[.03,0],color:Y[56]},h[2]={gravity:.95,liquid:.5,density:2,color:Y[2]},h[28]={gravity:.15,liquid:.3,density:3,color:Y[28]},h[11]={gravity:.95,liquid:.5,density:3,explosive:[12,1],color:Y[11]},h[14]={gravity:.4,liquid:.3,density:2,spawnRate:.25,meltOnHeat:7,color:Y[14]},h[52]={gravity:.3,liquid:.5,density:2,killsCreatures:!0,corrosiveHandler:!0,color:Y[52]},h[41]={gravity:.95,liquid:.5,density:3,killsCreatures:!0,corrosiveHandler:!0,color:Y[41]},h[42]={gravity:.15,liquid:.3,density:6,heatSource:!0,corrosiveHandler:!0,color:Y[42]},h[46]={gravity:1,liquid:.5,density:8,killsCreatures:!0,corrosiveHandler:!0,color:Y[46]},h[6]={buoyancy:.5,volatile:[.1,0],heatSource:!0,color:Y[6],palette:1},h[7]={buoyancy:1,volatile:[.02,0],flammable:!0,color:Y[7]},h[10]={buoyancy:1,volatile:[.08,0],heatSource:!0,color:Y[10],palette:2},h[59]={buoyancy:.5,volatile:[.08,0],heatSource:!0,color:Y[59],palette:4},h[50]={buoyancy:.4,spawnRate:.35,volatile:[.01,0],infectiousHandler:!0,color:Y[50]},h[40]={buoyancy:.3,spawnerHandler:!0,color:Y[40]},h[54]={buoyancy:.95,fireworkHandler:!0,color:Y[54]},h[55]={buoyancy:.6,bubbleHandler:!0,color:Y[55]},h[58]={buoyancy:1,heatSource:!0,cometHandler:!0,color:Y[58]},h[13]={volatile:[.2,20],heatSource:!0,lightningHandler:!0,color:Y[13],palette:3},h[19]={gravity:.5,volatile:[.05,0],heatSource:!0,color:Y[19]},h[20]={randomWalk:.5,volatile:[.08,0],color:Y[20]},h[17]={randomWalk:.5,spawnRate:.08,volatile:[.03,18],color:Y[17]},h[18]={immobile:!0,volatile:[2e-4,1],color:Y[18]},h[4]={immobile:!0,color:Y[4]},h[12]={immobile:!0,color:Y[12]},h[26]={immobile:!0,flammable:!0,color:Y[26]},h[23]={immobile:!0,spawnerHandler:!0,color:Y[23]},h[24]={immobile:!0,spawnerHandler:!0,color:Y[24]},h[27]={immobile:!0,flammable:!0,spawnerHandler:!0,color:Y[27]},h[29]={immobile:!0,flammable:!0,spawnerHandler:!0,color:Y[29]},h[30]={immobile:!0,spawnerHandler:!0,color:Y[30]},h[44]={immobile:!0,spawnerHandler:!0,color:Y[44]},h[57]={immobile:!0,spawnerHandler:!0,color:Y[57]},h[60]={immobile:!0,spawnerHandler:!0,color:Y[60]},h[66]={immobile:!0,spawnerHandler:!0,color:Y[66]},h[9]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[9]},h[15]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[15]},h[21]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[21]},h[25]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[25]},h[61]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[61]},h[16]={living:!0,spawnRate:.08,creatureHandler:!0,color:Y[16]},h[62]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[62]},h[63]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[63]},h[64]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[64]},h[65]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[65]},h[5]={immobile:!0,flammable:!0,growthHandler:!0,color:Y[5]},h[48]={gravity:1,flammable:!0,growthHandler:!0,color:Y[48]},h[51]={flammable:!0,growthHandler:!0,color:Y[51]},h[45]={immobile:!0,spawnRate:.35,volatile:[.008,0],infectiousHandler:!0,color:Y[45]},h[47]={immobile:!0,volatile:[.003,0],killsCreatures:!0,corrosiveHandler:!0,color:Y[47]},h[31]={projectileHandler:!0,color:Y[31]},h[32]={projectileHandler:!0,color:Y[32]},h[33]={projectileHandler:!0,color:Y[33]},h[34]={projectileHandler:!0,color:Y[34]},h[35]={projectileHandler:!0,color:Y[35]},h[36]={projectileHandler:!0,color:Y[36]},h[37]={projectileHandler:!0,color:Y[37]},h[38]={projectileHandler:!0,color:Y[38]},h[39]={projectileHandler:!0,volatile:[.3,0],color:Y[39]};const z=new Uint32Array(67);for(let t=0;t<67;t++){const n=h[t];if(!n)continue;let e=0;n.gravity!==void 0&&(e|=Wt),n.buoyancy!==void 0&&(e|=Dt),n.liquid!==void 0&&(e|=rt),n.density!==void 0&&(e|=Jt),n.randomWalk!==void 0&&(e|=$t),n.volatile&&(e|=gt),n.meltOnHeat!==void 0&&(e|=te),n.flammable&&(e|=ee),n.heatSource&&(e|=ie),n.immobile&&(e|=bt),n.living&&(e|=ne),n.killsCreatures&&(e|=oe),n.explosive&&(e|=fe),n.spawnerHandler&&(e|=tt),n.creatureHandler&&(e|=et),n.growthHandler&&(e|=Tt),n.corrosiveHandler&&(e|=lt),n.infectiousHandler&&(e|=it),n.projectileHandler&&(e|=nt),n.lightningHandler&&(e|=dt),n.fireworkHandler&&(e|=Ee),n.bubbleHandler&&(e|=se),n.cometHandler&&(e|=ce),z[t]=e}const Ht=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],re=[35,36,37,38,31,32,33,34];function Gt(t,n,e,T,c,M,i,r,u,s,o){const E=(l,L)=>L*u+l,f=t[T];if(f===22||f===11)return t[T]=6,t[n]=39,!0;if(f===9||f===15||f===21||f===25||f===14)return t[T]=e,t[n]=39,!0;if(f===2)return o()<.15?t[n]=39:o()<.5||(t[T]=e,t[n]=39),!0;if(f===30){const l=c+i,L=M+r;return l>=0&&l<u&&L>=0&&L<s&&t[E(l,L)]===0&&(t[E(l,L)]=e),t[n]=39,!0}return f===46?(t[n]=re[e-31],!0):f===5||f===26||f===12||f===8||f===7||f>=31&&f<=38||f===39?(t[T]=e,t[n]=39,!0):f===4||f===3||f===1?(o()<.2||(t[T]=e),t[n]=39,!0):f===0?(t[T]=e,t[n]=39,!0):(t[n]=39,!0)}function Te(t,n,e,T,c,M,i,r,u){const s=c-31,[o,E]=Ht[s];if(E>0||o!==0&&o>0===r)return;const f=n+o,l=e+E;if(f<0||f>=M||l<0||l>=i){t[T]=39;return}const L=l*M+f;Gt(t,T,c,L,f,l,o,E,M,i,u)}function le(t,n,e,T,c,M,i,r,u){const s=c-31,[o,E]=Ht[s];if(o!==0&&o>0===r)return;const f=n+o,l=e+E;if(f<0||f>=M||l<0||l>=i){t[T]=39;return}const L=l*M+f;Gt(t,T,c,L,f,l,o,E,M,i,u)}function ue(t,n,e){e()<.3&&(t[n]=0)}function H(t,n,e,T){return t>=0&&t<e&&n>=0&&n<T}function ot(t,n,e,T,c,M,i,r,u,s,o){for(let E=0;E<r;E++){const f=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(f===0&&l===0)continue;const L=n+f,A=e+l;if(!H(L,A,c,M))continue;const R=t[A*c+L];for(let S=0;S<u.length;S++)if(R===u[S])return t[T]=s,!0;if(o){const S=o(R);if(S!==!1)return t[T]=S,!0}}return!1}function ut(t,n){const e=Math.floor(t()*3)-1,T=t()<n?1:Math.floor(t()*3)-1;return[e,T]}const Mt=[6,10,13,19];function Me(t,n,e,T,c,M,i){if(ot(t,n,e,T,c,M,i,2,Mt,6,A=>A===16||A===17?0:!1)){if(t[T]===6)for(let A=0;A<4;A++){const R=n+Math.floor(i()*3)-1,S=e+Math.floor(i()*3)-1;H(R,S,c,M)&&t[S*c+R]===0&&i()<.5&&(t[S*c+R]=6)}return}if(i()<.003){t[T]=8;return}if(i()<.4)return;const r=i(),u=i();let s=0,o=0;if(r<.5?(o=-1,s=u<.35?-1:u<.7?1:0):r<.75?(s=u<.5?-2:2,o=u<.4?-1:0):r<.9&&(o=1,s=u<.5?-1:1),s===0&&o===0)return;const E=n+s,f=e+o;if(!H(E,f,c,M))return;const l=f*c+E,L=t[l];L===15||L===9||L===25?(t[l]=21,t[T]=i()<.6?21:5):(L===0||L===8)&&(t[l]=21,t[T]=0)}function Le(t,n,e,T,c,M,i){if(ot(t,n,e,T,c,M,i,2,Mt,6))return;const r=i(),u=i();let s=0,o=0;if(r<.3?(o=-1,s=u<.4?-1:u<.8?1:0):r<.5?(o=1,s=u<.4?-1:u<.8?1:0):r<.8&&(s=u<.5?-1:1,o=u<.3?-1:u<.6?1:0),s===0&&o===0)return;const E=n+s,f=e+o;if(!H(E,f,c,M))return;const l=f*c+E,L=t[l];if(L===5){if(i()<.08)for(let A=-1;A<=1;A++)for(let R=-1;R<=1;R++){if(A===0&&R===0)continue;const S=E+R,I=f+A;if(H(S,I,c,M)&&t[I*c+S]===0){t[I*c+S]=26;break}}}else L===0?(t[l]=25,t[T]=0):L===26&&(t[l]=25,t[T]=i()<.1?28:i()<.15?0:26)}function Ae(t,n,e,T,c,M,i){if(ot(t,n,e,T,c,M,i,2,[6,10,42],6,l=>l===2||l===41||l===21?0:!1))return;if(i()<.15){const l=n+Math.floor(i()*3)-1,L=e+Math.floor(i()*3)-1;H(l,L,c,M)&&t[L*c+l]===0&&(t[L*c+l]=i()<.7?56:20)}if(i()<.5)return;let r=0,u=0;for(let l=0;l<3;l++){const L=Math.floor(i()*9)-4,A=Math.floor(i()*9)-4,R=n+L,S=e+A;if(H(R,S,c,M)&&t[S*c+R]===26){r=Math.sign(L),u=Math.sign(A);break}}if(r===0&&u===0){const l=i();l<.25?(u=-1,r=i()<.5?-1:1):l<.4?(u=1,r=i()<.5?-1:1):l<.7&&(r=i()<.5?-1:1)}if(r===0&&u===0)return;const s=n+r,o=e+u;if(!H(s,o,c,M))return;const E=o*c+s,f=t[E];if(f===0)t[E]=61,t[T]=0;else if(f===26&&i()<.03){const l=n+Math.floor(i()*3)-1,L=e+Math.floor(i()*3)-1;H(l,L,c,M)&&t[L*c+l]===0&&(t[L*c+l]=61)}}function Re(t,n,e,T,c,M,i){if(ot(t,n,e,T,c,M,i,1,Mt,6)||i()<.5)return;const[r,u]=ut(i,.7);if(r===0&&u===0)return;const s=n+r,o=e+u;if(!H(s,o,c,M))return;const E=o*c+s,f=t[E];f===5?(t[E]=9,t[T]=i()<.3?0:3):f===0?(t[E]=9,t[T]=0):f===2&&(t[E]=9,t[T]=2)}function ae(t,n,e,T,c,M,i){if(i()<.5)return;const r=e>0?t[(e-1)*c+n]:0,u=r===5||r===26||r===3,s=Math.floor(i()*3)-1,o=u?-1:i()<.7?1:Math.floor(i()*3)-1;if(s===0&&o===0)return;const E=n+s,f=e+o;if(!H(E,f,c,M))return;const l=f*c+E,L=t[l];if(L===6||L===10||L===42){t[T]=6;return}if(L===41){t[T]=0;return}if(L===2){t[l]=15,t[T]=2;return}(L===3||L===1||L===5||L===26||L===0)&&(t[l]=15,t[T]=0)}function Pe(t,n,e,T,c,M,i){if(i()<.4)return;const[r,u]=ut(i,.3);if(r===0&&u===0)return;const s=n+r,o=e+u;if(!H(s,o,c,M))return;const E=o*c+s,f=t[E];f===0?(t[E]=16,t[T]=i()<.1?14:0):f===9||f===15||f===21||f===25||f===14||f===5||f===26?(t[E]=16,t[T]=14):(f===6||f===10||f===13)&&(t[T]=14)}function Ie(t,n,e,T,c,M,i){if(i()<.4)return;const[r,u]=ut(i,.6);if(r===0&&u===0)return;const s=n+r,o=e+u;if(!H(s,o,c,M))return;const E=o*c+s,f=t[E];if(f===6||f===42||f===41||f===21){t[T]=0;return}f===3||f===1||f===0?(t[E]=62,t[T]=0):f===2&&(t[E]=62,t[T]=2)}function Se(t,n,e,T,c,M,i){if(i()<.3)return;const r=Math.floor(i()*3)-1,u=i()<.6?-1:Math.floor(i()*3)-1;if(r===0&&u===0)return;const s=n+r,o=e+u;if(!H(s,o,c,M))return;const E=o*c+s,f=t[E];if(f===6||f===42||f===10){t[T]=56;return}f===0?(t[E]=63,t[T]=i()<.15?56:0):f===3||f===1?(t[E]=63,t[T]=26):f===2?(t[E]=63,t[T]=56):f===5?(t[E]=63,t[T]=26):f===4&&(t[T]=i()<.1?56:0)}function he(t,n,e,T,c,M,i){let r=!1;if((e<M-1&&t[(e+1)*c+n]===2||e>0&&t[(e-1)*c+n]===2||n>0&&t[e*c+n-1]===2||n<c-1&&t[e*c+n+1]===2)&&(r=!0),!r){t[T]=0;return}if(i()<.4)return;const u=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1;if(u===0&&s===0)return;const o=n+u,E=e+s;if(!H(o,E,c,M))return;const f=E*c+o,l=t[f];(l===2||l===9||l===51||l===62)&&(t[f]=64,t[T]=2)}function Ye(t,n,e,T,c,M,i){if(i()<.3)return;let r=0,u=0;for(let A=0;A<2;A++){const R=Math.floor(i()*9)-4,S=Math.floor(i()*9)-4,I=n+R,P=e+S;if(H(I,P,c,M)){const a=t[P*c+I];if(a===6||a===19||a===61||a===13){r=Math.sign(R),u=Math.sign(S);break}}}const s=r!==0?r:Math.floor(i()*3)-1,o=u!==0?u:i()<.4?-1:Math.floor(i()*3)-1;if(s===0&&o===0)return;const E=n+s,f=e+o;if(!H(E,f,c,M))return;const l=f*c+E,L=t[l];if(L===6||L===19||L===42||L===10){t[T]=6;return}L===0?(t[l]=65,t[T]=0):(L===5||L===26)&&(t[l]=65,t[T]=i()<.3?0:5)}const v=64,x=6,Ne=60;class Oe{chunkCols=0;chunkRows=0;cols=0;rows=0;active;sleepCounter;checksum;renderDirty;stampGrid;tickParity=0;init(n,e){this.cols=n,this.rows=e,this.chunkCols=Math.ceil(n/v),this.chunkRows=Math.ceil(e/v);const T=this.chunkCols*this.chunkRows;this.active=new Uint8Array(T).fill(1),this.sleepCounter=new Uint8Array(T),this.checksum=new Int32Array(T),this.renderDirty=new Uint8Array(T).fill(1),this.stampGrid=new Uint8Array(n*e),this.tickParity=0}wakeChunk(n,e){if(n<0||n>=this.chunkCols||e<0||e>=this.chunkRows)return;const T=e*this.chunkCols+n;this.active[T]=1,this.sleepCounter[T]=0}flipTick(){this.tickParity=this.tickParity?0:1}wakeRadius(n,e,T){const c=Math.max(0,n-T>>x),M=Math.min(this.chunkCols-1,n+T>>x),i=Math.max(0,e-T>>x),r=Math.min(this.chunkRows-1,e+T>>x);for(let u=i;u<=r;u++)for(let s=c;s<=M;s++){const o=u*this.chunkCols+s;this.renderDirty[o]=1,this.wakeChunk(s,u)}}wakeNeighbors(n,e){for(let T=-1;T<=1;T++)for(let c=-1;c<=1;c++)this.wakeChunk(n+c,e+T)}updateActivity(n,e){const{chunkCols:T,chunkRows:c,cols:M,rows:i}=this;for(let r=0;r<c;r++)for(let u=0;u<T;u++){const s=r*T+u;if(!this.active[s])continue;const o=this.computeChecksum(n,u,r,M,i);if(o!==this.checksum[s])this.checksum[s]=o,this.sleepCounter[s]=0,this.renderDirty[s]=1,this.wakeNeighbors(u,r);else{const E=this.sleepCounter[s]+1;this.sleepCounter[s]=E>255?255:E,E>=Ne&&(e&&this.chunkHasMatch(n,u,r,e)?this.sleepCounter[s]=0:this.active[s]=0)}}}wakeAll(){this.active.fill(1),this.sleepCounter.fill(0),this.renderDirty.fill(1)}computeChecksum(n,e,T,c,M){const i=e<<x,r=T<<x,u=Math.min(i+v,c),s=Math.min(r+v,M);let o=0;for(let E=r;E<s;E++){const f=E*c,l=E*137+1|0;for(let L=i;L<u;L++)o=o+n[f+L]*(L+l)|0}return o}chunkHasMatch(n,e,T,c){const M=e<<x,i=T<<x,r=Math.min(M+v,this.cols),u=Math.min(i+v,this.rows);for(let s=i;s<u;s++){const o=s*this.cols;for(let E=M;E<r;E++)if(c(n[o+E]))return!0}return!1}}function Ue(t,n,e,T,c,M,i,r,u,s){const o=(f,l)=>l*M+f;if(e===0){t[T]=0;return}if(r()<.1){t[T]=r()<.25?7:r()<.15?19:0;return}for(let f=0;f<3;f++){const l=Math.floor(r()*3)-1,L=Math.floor(r()*3)-1;if(l===0&&L===0)continue;const A=n+l,R=e+L;if(A>=0&&A<M&&R>=0&&R<i){const S=o(A,R),I=t[S];(I===5||I===8||I===9||I===7||I===22||I===26||I===27||I===29)&&r()<.5&&(t[S]=6)}}const E=o(n,e-1);if(e>0&&t[E]===0)t[E]=c,t[T]=0,u[E]=s;else{const f=r()<.5?-1:1;if(e>0&&n+f>=0&&n+f<M&&t[o(n+f,e-1)]===0){const l=o(n+f,e-1);t[l]=c,t[T]=0,u[l]=s}}}function Fe(t,n,e,T,c,M,i,r,u){const s=(E,f)=>f*c+E;if(e===0){t[T]=0;return}if(i()<.08){const E=i()<.5?-1:1;if(n+E>=0&&n+E<c&&t[s(n+E,e)]===0){const f=s(n+E,e);t[f]=7,t[T]=0,r[f]=u;return}}if(i()<.3)return;const o=s(n,e-1);if(e>0&&t[o]===0)t[o]=7,t[T]=0,r[o]=u;else{const E=i()<.5?-1:1;if(e>0&&n+E>=0&&n+E<c&&t[s(n+E,e-1)]===0){const f=s(n+E,e-1);t[f]=7,t[T]=0,r[f]=u}else if(n+E>=0&&n+E<c&&t[s(n+E,e)]===0){const f=s(n+E,e);t[f]=7,t[T]=0,r[f]=u}}}function Be(t,n,e,T,c,M,i,r,u){const s=(E,f)=>f*c+E;if(e===0){t[T]=0;return}if(i()<.08){t[T]=0;return}for(let E=0;E<3;E++){const f=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(f===0&&l===0)continue;const L=n+f,A=e+l;if(L>=0&&L<c&&A>=0&&A<M){const R=t[s(L,A)];R===1&&i()<.5?t[s(L,A)]=10:(R===5||R===8||R===7||R===26)&&i()<.5&&(t[s(L,A)]=6)}}const o=s(n,e-1);if(e>0&&t[o]===0)t[o]=10,t[T]=0,r[o]=u;else{const E=i()<.5?-1:1;if(e>0&&n+E>=0&&n+E<c&&t[s(n+E,e-1)]===0){const f=s(n+E,e-1);t[f]=10,t[T]=0,r[f]=u}}}function _e(t,n,e,T,c,M,i,r,u){const s=(o,E)=>E*c+o;if(i()<.01){t[T]=0;return}for(let o=0;o<3;o++){const E=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(E===0&&f===0)continue;const l=n+E,L=e+f;if(l>=0&&l<c&&L>=0&&L<M){const A=t[s(l,L)];if((A===5||A===26||A===8||A===28||A===3||A===51)&&i()<.35){t[s(l,L)]=45,t[T]=0;break}}}if(t[T]===50&&i()<.4){const o=Math.floor(i()*3)-1,E=i()<.6?-1:i()<.5?0:1,f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M&&t[s(f,l)]===0){const L=s(f,l);t[L]=50,t[T]=0,r[L]=u}}}function Ce(t,n,e,T,c,M,i,r,u){const s=(o,E)=>E*c+o;if(e<M-1&&t[s(n,e+1)]===0&&i()<.04&&(t[s(n,e+1)]=2),i()<.3){const o=i()<.5?-1:1,E=i()<.3?-1:i()<.5?1:0,f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M&&t[s(f,l)]===0){const L=s(f,l);t[L]=40,t[T]=0,r[L]=u}}}function We(t,n,e,T,c,M,i,r,u){const s=(E,f)=>f*c+E,o=[6,19,20,10,56,59];if(e>0&&i()<.95){const E=s(n,e-1);if(t[E]===0)t[E]=54,t[T]=0,r[E]=u;else{t[T]=0;const f=jt;for(let l=-f;l<=f;l++)for(let L=-f;L<=f;L++)if(L*L+l*l<=f*f&&i()<.5){const A=n+L,R=e+l;A>=0&&A<c&&R>=0&&R<M&&t[s(A,R)]===0&&(t[s(A,R)]=o[Math.floor(i()*o.length)])}}}else{t[T]=0;const E=Xt;for(let f=-E;f<=E;f++)for(let l=-E;l<=E;l++)if(l*l+f*f<=E*E&&i()<.45){const L=n+l,A=e+f;L>=0&&L<c&&A>=0&&A<M&&t[s(L,A)]===0&&(t[s(L,A)]=o[Math.floor(i()*o.length)])}}}function De(t,n,e,T,c,M,i,r,u){const s=(E,f)=>f*c+E;let o=!1;for(let E=0;E<3;E++){const f=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1,L=n+f,A=e+l;if(L>=0&&L<c&&A>=0&&A<M){const R=t[s(L,A)];if(R===2||R===41||R===28||R===52){o=!0;break}}}if(o){if(e>0&&i()<.6){const E=s(n,e-1),f=t[E];if(f===2||f===41||f===28||f===52)t[E]=55,t[T]=f,r[E]=u;else if(f===0){t[T]=0;for(let l=0;l<3;l++){const L=n+Math.floor(i()*3)-1,A=e-1-Math.floor(i()*2);L>=0&&L<c&&A>=0&&A<M&&t[s(L,A)]===0&&(t[s(L,A)]=2)}}}if(i()<.2){const E=i()<.5?-1:1;if(n+E>=0&&n+E<c){const f=s(n+E,e),l=t[f];(l===2||l===41||l===28||l===52)&&(t[f]=55,t[T]=l,r[f]=u)}}}else t[T]=7}function be(t,n,e,T,c,M,i,r,u){const s=(l,L)=>L*c+l,o=i()<.8?-2:-1,E=Math.floor(i()*3)-1;let f=!1;for(let l=Math.abs(o);l>0;l--){const L=e-l,A=n+(l===Math.abs(o)?E:0);if(L>=0&&L<M&&A>=0&&A<c){const R=s(A,L),S=t[R];if(S===0){t[R]=58,t[T]=59,r[R]=u,f=!0;break}else if(S===2){t[R]=7,t[T]=59,f=!0;break}else if(S===5||S===8||S===26){t[R]=59,t[T]=59,f=!0;break}else if(S===1){t[R]=12,t[T]=59,f=!0;break}else{t[T]=0;for(let I=-2;I<=2;I++)for(let P=-2;P<=2;P++){const a=n+P,N=e+I;a>=0&&a<c&&N>=0&&N<M&&t[s(a,N)]===0&&(t[s(a,N)]=i()<.6?59:19)}f=!0;break}}}(!f||i()<.05)&&(t[T]=59)}function de(t,n,e,T,c,M,i,r,u){const s=(E,f)=>f*c+E;if(i()<.2){t[T]=i()<.2?20:0;return}let o=!1;for(let E=1;E<=3&&!o;E++){const f=e+E;if(f>=M)break;const l=s(n,f),L=t[l];if(L===1){t[l]=12,t[T]=0,o=!0;for(let A=0;A<3;A++){let R=n,S=f,I=i()<.5?-1:1;for(let P=0;P<8&&(i()<.3&&(I=i()<.5?-1:1),R+=I,S+=i()<.8?1:0,!(R<0||R>=c||S>=M));P++){const a=s(R,S);if(t[a]===1)t[a]=12;else if(t[a]!==0&&t[a]!==12)break}}}else if(L===2){t[l]=13,t[T]=0,o=!0;for(let A=-3;A<=3;A++){const R=n+A;R>=0&&R<c&&t[s(R,f)]===2&&i()<.7&&(t[s(R,f)]=13)}}else if(L===5||L===8||L===9)t[l]=6,t[T]=0,o=!0;else if(L===11){t[T]=0;const A=Qt;for(let R=-A;R<=A;R++)for(let S=-A;S<=A;S++)if(S*S+R*R<=A*A){const I=n+S,P=f+R;if(I>=0&&I<c&&P>=0&&P<M){const a=s(I,P),N=t[a];N===2?t[a]=i()<.7?4:0:N!==4&&N!==12&&(t[a]=6)}}o=!0}else if(L===4||L===12)t[T]=0,o=!0;else if(L===3)i()<.4&&(t[l]=12),t[T]=0,o=!0;else{if(L===0)continue;t[T]=0,o=!0}}if(!o&&e+1<M&&t[s(n,e+1)]===0){const E=s(n,e+1);if(t[E]=13,t[T]=0,r[E]=u,i()<.15){const f=n+(i()<.5?-1:1);f>=0&&f<c&&t[s(f,e)]===0&&(t[s(f,e)]=13)}}else o||(t[T]=0)}function He(t,n,e,T,c){const{chunkCols:M,active:i,stampGrid:r,tickParity:u}=T;for(let s=0;s<e;s++){const o=s>>x,E=c()<.5;for(let f=0;f<M;f++){const l=E?f:M-1-f;if(!i[o*M+l])continue;const L=l<<x,A=Math.min(L+v,n),R=A-L;for(let S=0;S<R;S++){const I=E?L+S:A-1-S,P=s*n+I,a=t[P];if(a===0||r[P]===u)continue;const N=z[a];if(N&nt){a>=31&&a<=38&&a!==35&&a!==34&&a!==36&&a!==39&&Te(t,I,s,P,a,n,e,E,c);continue}if(N&et){switch(a){case 21:Me(t,I,s,P,n,e,c);break;case 25:Le(t,I,s,P,n,e,c);break;case 61:Ae(t,I,s,P,n,e,c);break}continue}if(a===6||a===59){Ue(t,I,s,P,a,n,e,c,r,u);continue}if(a===7){Fe(t,I,s,P,n,e,c,r,u);continue}if(a===10){Be(t,I,s,P,n,e,c,r,u);continue}if(N&it){a===50&&_e(t,I,s,P,n,e,c,r,u);continue}if(a===40){Ce(t,I,s,P,n,e,c,r,u);continue}if(a===54){We(t,I,s,P,n,e,c,r,u);continue}if(a===55){De(t,I,s,P,n,e,c,r,u);continue}if(a===58){be(t,I,s,P,n,e,c,r,u);continue}if(a===13){de(t,I,s,P,n,e,c,r,u);continue}}}}}function Ge(t,n,e,T,c,M,i){const r=(o,E)=>E*c+o,u=e<M-1?t[r(n,e+1)]:0;let s=!1;for(let o=0;o<3;o++){const E=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(E===0&&f===0)continue;const l=n+E,L=e+f;if(l>=0&&l<c&&L>=0&&L<M){const A=r(l,L),R=t[A];if((R===5||R===3||R===1||R===8||R===26||R===14)&&i()<.3){t[A]=i()<.7?0:7,i()<.4&&(t[T]=0,s=!0);break}if((R===4||R===12||R===18)&&i()<.08){t[A]=0,t[T]=0,s=!0;break}if((R===9||R===15||R===21||R===25)&&i()<.5){t[A]=41;break}}}if(!s)if(u===0)t[r(n,e+1)]=41,t[T]=0;else{const o=i()<.5?-1:1,E=n+o,f=n-o;E>=0&&E<c&&t[r(E,e+1)]===0?(t[r(E,e+1)]=41,t[T]=0):f>=0&&f<c&&t[r(f,e+1)]===0?(t[r(f,e+1)]=41,t[T]=0):E>=0&&E<c&&t[r(E,e)]===0?(t[r(E,e)]=41,t[T]=0):f>=0&&f<c&&t[r(f,e)]===0&&(t[r(f,e)]=41,t[T]=0)}}function me(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s,u=e<M-1?t[r(n,e+1)]:0;for(let s=0;s<3;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=r(f,l),A=t[L];if(A===2){if(t[L]=i()<.5?4:7,i()<.15){t[T]=4;break}}else A===43?t[L]=2:A===1&&i()<.4?t[L]=12:((A===5||A===8||A===7||A===26||A===22||A===27||A===29)&&i()<.7||(A===9||A===15||A===21||A===25)&&i()<.8)&&(t[L]=6)}}if(i()<.001){t[T]=4;return}if(!(i()>.15))if(u===0)t[r(n,e+1)]=42,t[T]=0;else{const s=i()<.5?-1:1,o=n+s,E=n-s;o>=0&&o<c&&t[r(o,e+1)]===0?(t[r(o,e+1)]=42,t[T]=0):E>=0&&E<c&&t[r(E,e+1)]===0?(t[r(E,e+1)]=42,t[T]=0):o>=0&&o<c&&t[r(o,e)]===0&&i()<.3?(t[r(o,e)]=42,t[T]=0):E>=0&&E<c&&t[r(E,e)]===0&&i()<.3&&(t[r(E,e)]=42,t[T]=0)}}function ve(t,n,e,T,c,M,i){const r=(u,s)=>s*c+u;if(i()<.008){t[T]=0;return}for(let u=0;u<2;u++){const s=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(s===0&&o===0)continue;const E=n+s,f=e+o;if(E>=0&&E<c&&f>=0&&f<M){const l=t[r(E,f)];if(l===6||l===10||l===42||l===41){t[T]=l===41?0:6;break}}}if(!(t[T]===6||t[T]===0)&&i()<.08){const u=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1,o=n+u,E=e+s;if(o>=0&&o<c&&E>=0&&E<M){const f=r(o,E),l=t[f];l===5||l===26||l===8||l===28||l===3?(t[f]=45,i()<.2&&(t[T]=i()<.4?50:7)):(l===9||l===15||l===14)&&i()<.3?t[f]=45:l===0&&i()<.1&&(t[f]=45,t[T]=i()<.3?7:0)}}}function xe(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s,u=e<M-1?t[r(n,e+1)]:0;for(let s=0;s<2;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=t[r(f,l)];(L===9||L===15||L===21||L===25||L===14)&&i()<.5&&(t[r(f,l)]=0)}}if(u===0)t[r(n,e+1)]=46,t[T]=0;else if(u===2||u===41||u===28||u===1||u===3)i()<.7&&(t[r(n,e+1)]=46,t[T]=u);else{const s=i()<.5?-1:1,o=n+s,E=n-s;o>=0&&o<c&&t[r(o,e+1)]===0?(t[r(o,e+1)]=46,t[T]=0):E>=0&&E<c&&t[r(E,e+1)]===0?(t[r(E,e+1)]=46,t[T]=0):o>=0&&o<c&&t[r(o,e)]===0?(t[r(o,e)]=46,t[T]=0):E>=0&&E<c&&t[r(E,e)]===0&&(t[r(E,e)]=46,t[T]=0)}}function ke(t,n,e,T,c,M,i){const r=(u,s)=>s*c+u;if(i()<.003){t[T]=0;return}for(let u=0;u<2;u++){const s=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(s===0&&o===0)continue;const E=n+s,f=e+o;if(E>=0&&E<c&&f>=0&&f<M&&t[r(E,f)]===13){t[T]=20;break}}if(t[T]!==20&&i()<.1){const u=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1,o=n+u,E=e+s;if(o>=0&&o<c&&E>=0&&E<M){const f=r(o,E),l=t[f];if(l!==0&&l!==4&&l!==12&&l!==18&&l!==47&&l!==23&&l!==44&&(t[f]=0,i()<.02)){const L=n+Math.floor(i()*3)-1,A=e+Math.floor(i()*3)-1;L>=0&&L<c&&A>=0&&A<M&&t[r(L,A)]===0&&(t[r(L,A)]=47)}}}}function ye(t,n,e,T,c,M,i){const r=(o,E)=>E*c+o,u=e<M-1?t[r(n,e+1)]:0;if(i()<.005){t[T]=3;return}let s=!1;for(let o=0;o<2;o++){const E=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1,l=n+E,L=e+f;if(l>=0&&l<c&&L>=0&&L<M&&t[r(l,L)]===2){s=!0;break}}if(s&&i()<.03){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1,f=n+o,l=e+E;f>=0&&f<c&&l>=0&&l<M&&t[r(f,l)]===4&&(t[r(f,l)]=49)}u===0&&i()<.1&&(t[r(n,e+1)]=49,t[T]=0)}function Ve(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s,u=e<M-1?t[r(n,e+1)]:0;for(let s=0;s<3;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=t[r(f,l)];(L===9||L===15||L===21||L===25||L===14)&&i()<.5||L===51&&i()<.08||L===5&&i()<.05?t[r(f,l)]=52:L===2&&i()<.15&&(t[r(f,l)]=0,i()<.5&&(t[T]=2))}}if(t[T]===52&&!(i()>.3))if(u===0)t[r(n,e+1)]=52,t[T]=0;else{const s=i()<.5?-1:1,o=n+s,E=n-s;o>=0&&o<c&&t[r(o,e+1)]===0?(t[r(o,e+1)]=52,t[T]=0):E>=0&&E<c&&t[r(E,e+1)]===0?(t[r(E,e+1)]=52,t[T]=0):o>=0&&o<c&&t[r(o,e)]===0?(t[r(o,e)]=52,t[T]=0):E>=0&&E<c&&t[r(E,e)]===0&&(t[r(E,e)]=52,t[T]=0)}}function we(t,n,e,T,c,M,i){const r=(f,l)=>l*c+f;if(i()<.92)return;const u=Math.floor(i()*3)-1,s=i()<.7?-1:Math.floor(i()*3)-1,o=n+u,E=e+s;o>=0&&o<c&&E>=0&&E<M&&t[r(o,E)]===2&&(t[r(o,E)]=i()<.1?26:5)}function pe(t,n,e,T,c,M,i){const r=(O,U)=>U*c+O,u=e<M-1?t[r(n,e+1)]:0,s=e>0?r(n,e-1):-1,o=s>=0?t[s]:0;if(!(u===2&&o!==2&&i()<.7)){if(u===2&&o===2){t[s]=48,t[T]=2;return}else if(u===0){t[r(n,e+1)]=48,t[T]=0;return}}const E=Math.floor(i()*8),f=[0,1,1,1,0,-1,-1,-1][E],l=[-1,-1,0,1,1,1,0,-1][E],L=n+f,A=e+l;if(L>=0&&L<c&&A>=0&&A<M){const O=t[r(L,A)];if(O===6||O===10||O===42){t[T]=6;return}if((O===9||O===15||O===21)&&i()<.3){t[T]=0;return}}if(i()>.35||!(e<M-1&&(t[r(n,e+1)]===3||t[r(n,e+1)]===2)||o===3||o===2||o===5))return;let S=!1,I=!1;for(let O=0;O<6;O++){const U=Math.floor(i()*13)-6,y=Math.floor(i()*13)-6,Q=n+U,D=e+y;if(Q>=0&&Q<c&&D>=0&&D<M){const B=t[r(Q,D)];B===2&&(S=!0),B===57&&(I=!0)}}const P=I?.7:S?.5:.25;if(i()>P)return;const a=I?50:S?30:20;let N=-1;for(let O=1;O<=a&&!(e-O<0);O++){const U=t[r(n,e-O)];if(U===0||U===2){N=e-O;break}if(U!==5&&U!==26&&U!==3&&U!==48)break}if(N>=0){const O=I?.3:S?.15:.1;t[r(n,N)]=i()<O?26:5}const W=e-(N>=0?N:e);if(W>10&&i()<(I?.2:.1)){const O=n+(i()<.5?-1:1),U=e-Math.floor(i()*Math.min(W,15))-5,y=O>=0&&O<c&&U>=0?t[r(O,U)]:-1;(y===0||y===2)&&(t[r(O,U)]=i()<.4?26:5)}}function Ke(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s;let u=!1;if((e>0&&t[r(n,e-1)]===2||e<M-1&&t[r(n,e+1)]===2||n>0&&t[r(n-1,e)]===2||n<c-1&&t[r(n+1,e)]===2)&&(u=!0),!u&&i()<.001){t[T]=5;return}if(u&&i()<.015&&e>0){const s=r(n,e-1);t[s]===2&&(t[s]=7)}if(u&&i()<.06){const s=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1,E=n+s,f=e+o;E>=0&&E<c&&f>=0&&f<M&&t[r(E,f)]===2&&(t[r(E,f)]=51)}for(let s=0;s<2;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=t[r(f,l)];if((L===9||L===14)&&i()<.25){t[T]=0;break}}}}function qe(t,n,e,T,c,M,i){const r=(f,l)=>l*c+f;if(i()<.03){t[T]=i()<.33?18:i()<.5?19:20;return}const u=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1;if(u===0&&s===0)return;const o=n+u,E=e+s;o>=0&&o<c&&E>=0&&E<M&&t[r(o,E)]===0&&(t[r(o,E)]=17,t[T]=0)}function je(t,n,e,T,c,M,i){i()<.002&&(t[T]=1)}function Xe(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s,u=e<M-1?t[r(n,e+1)]:0;if(i()<.05){t[T]=i()<.3?6:0;return}for(let s=0;s<2;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=t[r(f,l)];(L===5||L===8||L===7||L===26)&&i()<.4&&(t[r(f,l)]=6)}}if(u===0)t[r(n,e+1)]=19,t[T]=0;else{const s=i()<.5?-1:1;n+s>=0&&n+s<c&&t[r(n+s,e+1)]===0&&(t[r(n+s,e+1)]=19,t[T]=0)}}function Qe(t,n,e,T,c,M,i){const r=(o,E)=>E*c+o;if(i()<.08){t[T]=0;return}const u=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1;if(u!==0||s!==0){const o=n+u,E=e+s;o>=0&&o<c&&E>=0&&E<M&&t[r(o,E)]===0&&(t[r(o,E)]=20,t[T]=0)}}function ze(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s;let u=!1;for(let s=0;s<2;s++){const o=Math.floor(i()*3)-1,E=Math.floor(i()*3)-1;if(o===0&&E===0)continue;const f=n+o,l=e+E;if(f>=0&&f<c&&l>=0&&l<M){const L=t[r(f,l)];if(L===6||L===10||L===19||L===42){t[T]=6;for(let A=0;A<10;A++){const R=Math.floor(i()*5)-2,S=Math.floor(i()*5)-2,I=n+R,P=e+S;I>=0&&I<c&&P>=0&&P<M&&t[r(I,P)]===53&&i()<.8&&(t[r(I,P)]=6)}u=!0;break}}}if(!u){if(i()<.003){t[T]=1;return}if(i()<.3){const s=Math.floor(i()*3)-1,o=i()<.6?1:i()<.5?0:-1,E=n+s,f=e+o;E>=0&&E<c&&f>=0&&f<M&&t[r(E,f)]===0&&(t[r(E,f)]=53,t[T]=0)}}}function Ze(t,n,e,T,c,M,i){const r=(E,f)=>f*c+E,u=e<M-1?t[r(n,e+1)]:0;let s=0;for(let E=0;E<3;E++){const f=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(f===0&&l===0)continue;const L=n+f,A=e+l;L>=0&&L<c&&A>=0&&A<M&&t[r(L,A)]===56&&s++}const o=s===0?.15:s>0?.03:.01;if(i()<o){t[T]=0;return}if(i()<.3)if(u===0)t[r(n,e+1)]=56,t[T]=0;else{const E=i()<.5?-1:1;n+E>=0&&n+E<c&&t[r(n+E,e+1)]===0&&(t[r(n+E,e+1)]=56,t[T]=0)}}const Je={23:2,24:2,27:2,29:2,30:2,44:4,57:6,60:12,66:3};function $e(t,n,e,T,c,M,i){e<M-1&&t[(e+1)*c+n]===0&&i()<.15&&(t[(e+1)*c+n]=2)}function ge(t,n,e,T,c,M,i){if(i()<.06){const r=Math.floor(i()*3)-1,u=Math.floor(i()*3)-1,s=n+r,o=e+u;s>=0&&s<c&&o>=0&&o<M&&t[o*c+s]===0&&(t[o*c+s]=15)}}function ti(t,n,e,T,c,M,i){if(i()<.035){const r=Math.floor(i()*3)-1,u=Math.floor(i()*3)-1,s=n+r,o=e+u;s>=0&&s<c&&o>=0&&o<M&&t[o*c+s]===0&&(t[o*c+s]=25)}}function ei(t,n,e,T,c,M,i){if(i()<.02){const r=Math.floor(i()*3)-1,u=-1,s=n+r,o=e+u;s>=0&&s<c&&o>=0&&o<M&&t[o*c+s]===0&&(t[o*c+s]=21)}}function ii(t,n,e,T,c,M,i){if(i()<.08){const r=[31,32,33,34,35,36,37,38],u=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],s=Math.floor(i()*8);for(let o=0;o<8;o++){const E=(s+o)%8,[f,l]=u[E],L=n+f,A=e+l;if(L>=0&&L<c&&A>=0&&A<M&&t[A*c+L]===0){t[A*c+L]=r[E];break}}}}function ni(t,n,e,T,c,M,i){const r=(u,s)=>s*c+u;for(let u=0;u<3;u++){const s=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(s===0&&o===0)continue;const E=n+s,f=e+o;if(E>=0&&E<c&&f>=0&&f<M){const l=t[r(E,f)];if(l===2){if(t[r(E,f)]=7,i()<.08){t[T]=4;return}}else l===43&&(t[r(E,f)]=2)}}if(t[T]!==4){if(i()<.55&&e>0){const u=r(n,e-1);t[u]===0&&(t[u]=42)}if(i()<.25){const u=i()<.5?-1:1;if(n+u>=0&&n+u<c&&e>0){const s=r(n+u,e-1);t[s]===0&&(t[s]=42)}}if(i()<.1){const u=Math.floor(i()*3)-1,s=Math.floor(i()*2)-1,o=n+u,E=e+s;o>=0&&o<c&&E>=0&&E<M&&t[r(o,E)]===0&&(t[r(o,E)]=19)}}}function oi(t,n,e,T,c,M,i){const r=(u,s)=>s*c+u;if(i()<.12){const u=i()*6.28318,s=i()*4+1,o=n+Math.round(Math.cos(u)*s),E=e+Math.round(Math.sin(u)*s);o>=0&&o<c&&E>=0&&E<M&&t[r(o,E)]===0&&(t[r(o,E)]=i()<.6?20:56)}if(i()<.04){const u=i()*6.28318,s=i()*12+3,o=n+Math.round(Math.cos(u)*s),E=e+Math.round(Math.sin(u)*s);if(o>=0&&o<c&&E>=0&&E<M){const f=r(o,E),l=t[f];l===5&&i()<.3?t[f]=26:l===2&&i()<.1?t[f]=51:l===3&&i()<.15||l===0&&i()<.05?t[f]=5:l===43&&i()<.2?t[f]=2:l===45&&i()<.1&&(t[f]=26)}}if(i()<.02)for(let u=0;u<5;u++){const s=Math.floor(i()*5)-2,o=Math.floor(i()*5)-2,E=n+s,f=e+o;if(E>=0&&E<c&&f>=0&&f<M){const l=r(E,f);t[l]===2&&(t[l]=7)}}}function fi(t,n,e,T,c,M,i){const r=(s,o)=>o*c+s;if(i()>.5)return;const u=zt;for(let s=0;s<Zt;s++){const o=i()*6.28318,E=i()*u+1,f=Math.round(Math.cos(o)*E),l=Math.round(Math.sin(o)*E);if(f===0&&l===0)continue;const L=n+f,A=e+l;if(L<0||L>=c||A<0||A>=M)continue;const R=r(L,A),S=t[R];if(S===0||S===60||S===44||S===30||S===24||S===27)continue;const I=f>0?-1:f<0?1:0,P=l>0?-1:l<0?1:0,a=L+I,N=A+P;if(a>=0&&a<c&&N>=0&&N<M){const W=r(a,N);Math.abs(f+I)<=1&&Math.abs(l+P)<=1?t[R]=0:t[W]===0&&(t[W]=S,t[R]=0)}}for(let s=-6;s<=6;s+=2){const o=n+s;if(!(o<0||o>=c))for(let E=-8;E<=2;E+=2){const f=e+E;if(f<0||f>=M)continue;const l=r(o,f),L=t[l];if(!(L===0||L===60)&&Math.abs(s)>1&&i()<.3){const A=s>0?-1:1,R=o+A;R>=0&&R<c&&t[r(R,f)]===0&&(t[r(R,f)]=L,t[l]=0)}}}}function Ei(t,n,e,T,c,M,i){if(e>0&&i()<.2){const r=(e-1)*c+n;t[r]===0&&(t[r]=7)}if(i()<.08){const r=i()<.5?-1:1,u=n+r,s=e-1;u>=0&&u<c&&s>=0&&t[s*c+u]===0&&(t[s*c+u]=7)}}function si(t,n,e,T,c,M,i,r,u,s){const o=h[i];if(r()>o.gravity||e>=M-1)return!1;const E=T+c,f=t[E];if(f===0)return t[E]=i,t[T]=0,u[E]=s,!0;if(o.density!==void 0){const l=h[f];if(l&&l.density!==void 0&&o.density>l.density&&z[f]&rt)return t[E]=i,t[T]=f,u[E]=s,!0}if(i!==3){const l=n>0&&t[E-1]===0,L=n<c-1&&t[E+1]===0;let A=0;if(l&&L?A=r()<.5?-1:1:l?A=-1:L&&(A=1),A!==0)return t[E+A]=i,t[T]=0,u[E+A]=s,!0}return!1}function ci(t,n,e,T,c,M,i,r,u){const s=h[M];if(i()>s.liquid)return!1;const o=i()<.5?-1:1;return n+o>=0&&n+o<c&&t[T+o]===0?(t[T+o]=M,t[T]=0,r[T+o]=u,!0):n-o>=0&&n-o<c&&t[T-o]===0?(t[T-o]=M,t[T]=0,r[T-o]=u,!0):!1}function ri(t){return t>0&&(z[t]&tt)!==0}function Ti(t){return(n,e)=>e*t+n}const li={23:$e,24:ge,27:ti,29:ei,30:ii,44:ni,57:oi,60:fi,66:Ei},ui={9:Re,15:ae,16:Pe,62:Ie,63:Se,64:he,65:Ye},Mi={41:Ge,42:me,46:xe,47:ke,52:Ve},Li={45:ve,49:ye},Ai={5:we,48:pe,51:Ke},Ri={17:qe,18:je,19:Xe,20:Qe,53:ze,56:Ze},ai=nt|et|lt|it|Tt|tt;function Lt(t,n,e,T,c,M,i,r,u,s,o,E,f,l,L,A,R){if(u===0){t[r]=c,t[T]=0,o[r]=E;return}if(l>=0&&u===l){t[r]=c,t[T]=l,o[r]=E;return}const S=s()<.5?-1:1,I=n+S,P=n-S;if(I>=0&&I<M&&t[f(I,e+1)]===0){const a=f(I,e+1);t[a]=c,t[T]=0,o[a]=E;return}if(L&&P>=0&&P<M&&t[f(P,e+1)]===0){const a=f(P,e+1);t[a]=c,t[T]=0,o[a]=E;return}if(A>0&&s()<A){if(I>=0&&I<M&&t[f(I,e)]===0){const a=f(I,e);t[a]=c,t[T]=0,o[a]=E;return}if(R&&P>=0&&P<M&&t[f(P,e)]===0){const a=f(P,e);t[a]=c,t[T]=0,o[a]=E;return}}}function Pi(t,n,e,T,c){const M=Ti(n),{chunkCols:i,active:r,stampGrid:u,tickParity:s}=T;for(let o=e-2;o>=0;o--){const E=o>>x,f=c()<.5;for(let l=0;l<i;l++){const L=f?l:i-1-l;if(!r[E*i+L])continue;const A=L<<x,R=Math.min(A+v,n),S=R-A;for(let I=0;I<S;I++){const P=f?A+I:R-1-I,a=o*n+P,N=t[a];if(N===0||u[a]===s)continue;u[a]=s;const W=z[N];if(W&Dt||W&dt)continue;if(W&ai){W&tt?(li[N]?.(t,P,o,a,n,e,c),T.wakeRadius(P,o,Je[N]??2)):W&nt?N===35||N===34||N===36?le(t,P,o,a,N,n,e,f,c):N===39&&ue(t,a,c):W&et?ui[N]?.(t,P,o,a,n,e,c):W&lt?Mi[N]?.(t,P,o,a,n,e,c):W&it?Li[N]?.(t,P,o,a,n,e,c):W&Tt&&Ai[N]?.(t,P,o,a,n,e,c);continue}const O=Ri[N];if(O){O(t,P,o,a,n,e,c);continue}const U=M(P,o+1),y=o<e-1?t[U]:N;if(N===11){const D=o>0?t[M(P,o-1)]:0;if(y!==0&&y!==2&&y!==11||D!==0&&D!==2&&D!==11){const F=Kt;for(let b=-F;b<=F;b++)for(let d=-F;d<=F;d++)if(d*d+b*b<=F*F){const _=P+d,w=o+b;if(_>=0&&_<n&&w>=0&&w<e){const K=M(_,w),q=t[K];q===2?t[K]=c()<.7?4:0:q!==4&&q!==12&&(t[K]=6)}}continue}if(t[a]!==11)continue;Lt(t,P,o,a,11,n,e,U,y,c,u,s,M,2,!0,1,!0);continue}if(N===22){for(let D=0;D<2;D++){const B=Math.floor(c()*3)-1,F=Math.floor(c()*3)-1;if(B===0&&F===0)continue;const b=P+B,d=o+F;if(b>=0&&b<n&&d>=0&&d<e){const _=t[M(b,d)];if(_===6||_===10||_===19||_===42){const w=qt;for(let K=-w;K<=w;K++)for(let q=-w;q<=w;q++)if(q*q+K*K<=w*w){const Yt=P+q,Nt=o+K;if(Yt>=0&&Yt<n&&Nt>=0&&Nt<e){const yt=M(Yt,Nt),Ot=t[yt];Ot!==4&&Ot!==12&&Ot!==2&&(t[yt]=6)}}break}}}if(t[a]!==22)continue;Lt(t,P,o,a,22,n,e,U,y,c,u,s,M,2,!0,0,!1);continue}if(N===14){for(let D=0;D<2;D++){const B=Math.floor(c()*3)-1,F=Math.floor(c()*3)-1;if(B===0&&F===0)continue;const b=P+B,d=o+F;if(b>=0&&b<n&&d>=0&&d<e){const _=t[M(b,d)];if(_===6||_===10||_===19||_===42){t[a]=7;break}}}if(t[a]!==14||c()<.6)continue;Lt(t,P,o,a,14,n,e,U,y,c,u,s,M,-1,!1,.3,!1);continue}if(N===43){let D=!1;if(c()<.4)for(let B=-1;B<=1&&!D;B++)for(let F=-1;F<=1&&!D;F++){if(B===0&&F===0)continue;const b=P+F,d=o+B;if(b>=0&&b<n&&d>=0&&d<e){const _=t[M(b,d)];(_===6||_===10||_===19||_===42)&&c()<.6?(t[a]=2,D=!0):_===2&&c()<.04&&(t[M(b,d)]=12)}}if(D)continue;if(c()<.25&&y===0)t[U]=43,t[a]=0,u[U]=s;else if(c()<.1){const B=c()<.5?-1:1;if(P+B>=0&&P+B<n&&t[M(P+B,o+1)]===0){const F=M(P+B,o+1);t[F]=43,t[a]=0,u[F]=s}}continue}if(W&bt)continue;let Q=!1;W&Wt&&(Q=si(t,P,o,a,n,e,N,c,u,s)),!Q&&W&rt&&ci(t,P,o,a,n,N,c,u,s)}}}}function Ii(t,n,e,T,c){const{chunkCols:M,chunkRows:i,renderDirty:r}=c;for(let u=0;u<i;u++)for(let s=0;s<M;s++){const o=u*M+s;if(!r[o])continue;r[o]=0;const E=u<<x,f=s<<x,l=Math.min(E+v,e),L=Math.min(f+v,n);for(let A=E;A<l;A++){const R=A*n;for(let S=f;S<L;S++){const I=R+S,P=t[I];P===0?T[I]=g:P===6?T[I]=Ft[S+A&31]:P===10?T[I]=Bt[S+A&63]:P===13?T[I]=_t[S+A&31]:P===59?T[I]=Ct[S+A&31]:T[I]=Y[P]}}}}function mt(t){let n=t|0;return function(){n=n+1831565813|0;let e=Math.imul(n^n>>>15,1|n);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let V=null,p=null,ft=null,Et=null,st=null,j=null,G=new Uint8Array(0),C=0,m=0,vt=!1,At=!1,Rt=[];const k=new Oe;let ct=mt(Date.now()),at=0,Pt=0,X=Ut;function Si(t,n){C=wt,m=pt,G=new Uint8Array(C*m),ft=new OffscreenCanvas(C,m),Et=ft.getContext("2d"),st=Et.createImageData(C,m),j=new Uint32Array(st.data.buffer),j.fill(g),X=Ut;const e=t/X,T=n/X;at=Math.max(0,(C-e)/2),Pt=Math.max(0,m-T),k.init(C,m)}function xt(t,n,e,T){const c=e==="erase"?0:Vt[e];if(c===30){if(t>=0&&t<C&&n>=0&&n<m){const M=n*C+t;G[M]!==4&&G[M]!==23&&G[M]!==30&&G[M]!==60&&(G[M]=30)}k.wakeRadius(t,n,1);return}for(let M=-T;M<=T;M++)for(let i=-T;i<=T;i++)if(i*i+M*M<=T*T){const r=t+i,u=n+M;if(r>=0&&r<C&&u>=0&&u<m){const s=u*C+r,o=h[c]?.spawnRate??.45;(e==="erase"||ct()<o&&G[s]===0)&&(G[s]=c)}}k.wakeRadius(t,n,T+1)}function hi(){if(!p||!V||!Et||!ft||!st||!j)return;Ii(G,C,m,j,k),Et.putImageData(st,0,0);const t=V.width,n=V.height,e=t/X,T=n/X,c=Math.max(0,C-e),M=Math.max(0,m-T),i=Math.max(0,Math.min(at,c)),r=Math.max(0,Math.min(Pt,M));if(p.fillStyle="#1a1a1a",p.fillRect(0,0,t,n),p.imageSmoothingEnabled=!1,p.drawImage(ft,i,r,e,T,0,0,t,n),At){p.strokeStyle="rgba(255, 0, 0, 0.6)",p.lineWidth=2;for(let u=0;u<k.chunkRows;u++)for(let s=0;s<k.chunkCols;s++){if(k.active[u*k.chunkCols+s])continue;const o=(s*v-i)*(t/e),E=(u*v-r)*(n/T),f=v*(t/e),l=v*(n/T);p.strokeRect(o,E,f,l)}}}let Z=0,J=0;const It=1e3/60;let St=0,ht=0;function kt(t){Z===0&&(Z=t);const n=Math.min(t-Z,100);Z=t;for(const e of Rt){const T=e.x-e.prevX,c=e.y-e.prevY,M=Math.max(Math.abs(T),Math.abs(c));if(M===0)xt(e.x,e.y,e.tool,e.brushSize);else for(let i=0;i<=M;i++){const r=i/M,u=Math.round(e.prevX+T*r),s=Math.round(e.prevY+c*r);xt(u,s,e.tool,e.brushSize)}}if(Rt=[],vt||(J+=n,J>=It&&(k.flipTick(),He(G,C,m,k,ct),Pi(G,C,m,k,ct),k.updateActivity(G,ri),J=Math.min(J-It,It))),hi(),St++,t-ht>=500){const e=Math.round(St/((t-ht)/1e3));self.postMessage({type:"fps",data:e}),St=0,ht=t}requestAnimationFrame(kt)}self.onmessage=t=>{const{type:n,data:e}=t.data;switch(n){case"init":V=t.data.canvas,p=V.getContext("2d"),Si(V.width,V.height),Z=0,J=0,requestAnimationFrame(kt);break;case"resize":V&&(V.width=e.width,V.height=e.height);break;case"input":Rt.push({x:e.cellX,y:e.cellY,prevX:e.prevX??e.cellX,prevY:e.prevY??e.cellY,tool:e.tool,brushSize:e.brushSize});break;case"camera":at=e.camX,Pt=e.camY,X=e.zoom;break;case"pause":vt=e.paused;break;case"toggleDebugChunks":At=!At;break;case"reset":G.fill(0),k.wakeAll(),ct=mt(Date.now()),j&&j.fill(g);break;case"save":{const c=9+G.length,M=new ArrayBuffer(c),i=new DataView(M),r=new Uint8Array(M);r[0]=83,r[1]=65,r[2]=78,r[3]=68,r[4]=1,i.setUint16(5,C,!0),i.setUint16(7,m,!0),r.set(G,9),self.postMessage({type:"saveData",data:M},[M]);break}case"load":{const T=e.buffer,c=new DataView(T),M=new Uint8Array(T);if(M[0]!==83||M[1]!==65||M[2]!==78||M[3]!==68)break;let i;if(c.getUint16(4,!0)===C){if(c.getUint16(6,!0)!==m)break;i=8}else{if(M[4]!==1)break;const s=c.getUint16(5,!0),o=c.getUint16(7,!0);if(s!==C||o!==m)break;i=9}G.set(M.subarray(i,i+C*m)),k.wakeAll(),j&&j.fill(g);break}}}})();
