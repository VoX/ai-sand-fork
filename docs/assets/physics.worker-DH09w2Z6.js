(function(){"use strict";const Vt={sand:1,water:2,dirt:3,stone:4,plant:5,fire:6,gas:7,fluff:8,bug:9,plasma:10,nitro:11,glass:12,lightning:13,slime:14,ant:15,alien:16,quark:17,crystal:18,ember:19,static:20,bird:21,gunpowder:22,tap:23,anthill:24,bee:25,flower:26,hive:27,honey:28,nest:29,gun:30,cloud:40,acid:41,lava:42,snow:43,volcano:44,mold:45,mercury:46,void:47,seed:48,rust:49,spore:50,algae:51,poison:52,dust:53,firework:54,bubble:55,glitter:56,star:57,comet:58,blackhole:60,firefly:61,worm:62,fairy:63,fish:64,moth:65,vent:66},pt=1600,Kt=1e3,Ft=4;function z(t,n,e){n/=100,e/=100;const r=n*Math.min(e,1-e),E=M=>{const i=(M+t/30)%12;return e-r*Math.max(Math.min(i-3,9-i,1),-1)};return 255<<24|Math.round(E(4)*255)<<16|Math.round(E(8)*255)<<8|Math.round(E(0)*255)}const Y=new Uint32Array([4279900698,4285450470,4292448330,4281031307,4284900966,4280453922,0,4282693800,4292077301,4290013695,0,4279566137,4293580968,0,4281519514,4279904875,4278255360,4294902015,4294955136,4280303871,4294967108,4293454056,4281348144,4290822336,4281368752,4278245631,4294919372,4282431720,4281377023,4286611616,4283453520,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282703359,4292399304,4278255551,4279506140,4294963424,4278190182,4293814395,4291346616,4283697198,4285834708,4279124407,4289376800,4282216485,4287299723,4287084766,4278216447,4293643911,4290822336,4278247423,4294965629,4294938654,4278190080,4278255551,4286615744,4294936831,4278232575,4287411410,4284512352]),Bt=new Uint32Array(32),dt=new Uint32Array(64),_t=new Uint32Array(32),Ct=new Uint32Array(32);for(let t=0;t<32;t++)Bt[t]=z(10+t,100,50+t/32*20),_t[t]=z(50+t/32*20,100,80+t/32*20),Ct[t]=z(200+t/32*20,100,50+t/32*30);for(let t=0;t<64;t++)dt[t]=z(t<32?280+t:320+(t-32),100,60+t/64*25);const $=4279900698,qt=12,jt=6,Xt=8,Qt=7,Zt=15,zt=10,$t=16,Dt=1,bt=2,ct=4,Jt=8,gt=16,te=32,ee=64,Wt=128,ie=256,mt=512,ne=1024,oe=2048,fe=4096,J=8192,g=16384,rt=32768,Tt=65536,tt=1<<17,et=1<<18,Ht=1<<19,se=1<<20,Ee=1<<21,ce=1<<22,P=[];P[0]=null,P[1]={gravity:.95,density:5,color:Y[1]},P[3]={gravity:.95,density:4,color:Y[3]},P[22]={gravity:.95,density:4,explosive:[6,0],flammable:!0,color:Y[22]},P[43]={gravity:.25,meltOnHeat:2,color:Y[43]},P[49]={gravity:.1,volatile:[.005,3],infectiousHandler:!0,color:Y[49]},P[8]={gravity:.3,flammable:!0,color:Y[8]},P[53]={gravity:.3,flammable:!0,explosive:[2,0],volatile:[.003,1],color:Y[53]},P[56]={gravity:.3,volatile:[.03,0],color:Y[56]},P[2]={gravity:.95,liquid:.5,density:2,color:Y[2]},P[28]={gravity:.15,liquid:.3,density:3,color:Y[28]},P[11]={gravity:.95,liquid:.5,density:3,explosive:[12,1],color:Y[11]},P[14]={gravity:.4,liquid:.3,density:2,spawnRate:.25,meltOnHeat:7,color:Y[14]},P[52]={gravity:.3,liquid:.5,density:2,killsCreatures:!0,corrosiveHandler:!0,color:Y[52]},P[41]={gravity:.95,liquid:.5,density:3,killsCreatures:!0,corrosiveHandler:!0,color:Y[41]},P[42]={gravity:.15,liquid:.3,density:6,heatSource:!0,corrosiveHandler:!0,color:Y[42]},P[46]={gravity:1,liquid:.5,density:8,killsCreatures:!0,corrosiveHandler:!0,color:Y[46]},P[6]={buoyancy:.5,volatile:[.1,0],heatSource:!0,color:Y[6],palette:1},P[7]={buoyancy:1,volatile:[.02,0],flammable:!0,color:Y[7]},P[10]={buoyancy:1,volatile:[.08,0],heatSource:!0,color:Y[10],palette:2},P[59]={buoyancy:.5,volatile:[.08,0],heatSource:!0,color:Y[59],palette:4},P[50]={buoyancy:.4,spawnRate:.35,volatile:[.01,0],infectiousHandler:!0,color:Y[50]},P[40]={buoyancy:.3,spawnerHandler:!0,color:Y[40]},P[54]={buoyancy:.95,fireworkHandler:!0,color:Y[54]},P[55]={buoyancy:.6,bubbleHandler:!0,color:Y[55]},P[58]={buoyancy:1,heatSource:!0,cometHandler:!0,color:Y[58]},P[13]={volatile:[.2,20],heatSource:!0,lightningHandler:!0,color:Y[13],palette:3},P[19]={gravity:.5,volatile:[.05,0],heatSource:!0,color:Y[19]},P[20]={randomWalk:.5,volatile:[.08,0],color:Y[20]},P[17]={randomWalk:.5,spawnRate:.08,volatile:[.03,18],color:Y[17]},P[18]={immobile:!0,volatile:[2e-4,1],color:Y[18]},P[4]={immobile:!0,color:Y[4]},P[12]={immobile:!0,color:Y[12]},P[26]={immobile:!0,flammable:!0,color:Y[26]},P[23]={immobile:!0,spawnerHandler:!0,color:Y[23]},P[24]={immobile:!0,spawnerHandler:!0,color:Y[24]},P[27]={immobile:!0,flammable:!0,spawnerHandler:!0,color:Y[27]},P[29]={immobile:!0,flammable:!0,spawnerHandler:!0,color:Y[29]},P[30]={immobile:!0,spawnerHandler:!0,color:Y[30]},P[44]={immobile:!0,spawnerHandler:!0,color:Y[44]},P[57]={immobile:!0,spawnerHandler:!0,color:Y[57]},P[60]={immobile:!0,spawnerHandler:!0,color:Y[60]},P[66]={immobile:!0,spawnerHandler:!0,color:Y[66]},P[9]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[9]},P[15]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[15]},P[21]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[21]},P[25]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[25]},P[61]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[61]},P[16]={living:!0,spawnRate:.08,creatureHandler:!0,color:Y[16]},P[62]={living:!0,spawnRate:.25,creatureHandler:!0,color:Y[62]},P[63]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[63]},P[64]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[64]},P[65]={living:!0,spawnRate:.15,creatureHandler:!0,color:Y[65]},P[5]={immobile:!0,flammable:!0,growthHandler:!0,color:Y[5]},P[48]={gravity:1,flammable:!0,growthHandler:!0,color:Y[48]},P[51]={flammable:!0,growthHandler:!0,color:Y[51]},P[45]={immobile:!0,spawnRate:.35,volatile:[.008,0],infectiousHandler:!0,color:Y[45]},P[47]={immobile:!0,volatile:[.003,0],killsCreatures:!0,corrosiveHandler:!0,color:Y[47]},P[31]={projectileHandler:!0,color:Y[31]},P[32]={projectileHandler:!0,color:Y[32]},P[33]={projectileHandler:!0,color:Y[33]},P[34]={projectileHandler:!0,color:Y[34]},P[35]={projectileHandler:!0,color:Y[35]},P[36]={projectileHandler:!0,color:Y[36]},P[37]={projectileHandler:!0,color:Y[37]},P[38]={projectileHandler:!0,color:Y[38]},P[39]={projectileHandler:!0,volatile:[.3,0],color:Y[39]};const q=new Uint32Array(67);for(let t=0;t<67;t++){const n=P[t];if(!n)continue;let e=0;n.gravity!==void 0&&(e|=Dt),n.buoyancy!==void 0&&(e|=bt),n.liquid!==void 0&&(e|=ct),n.density!==void 0&&(e|=Jt),n.randomWalk!==void 0&&(e|=gt),n.volatile&&(e|=te),n.meltOnHeat!==void 0&&(e|=ee),n.flammable&&(e|=Wt),n.heatSource&&(e|=ie),n.immobile&&(e|=mt),n.living&&(e|=ne),n.killsCreatures&&(e|=oe),n.explosive&&(e|=fe),n.spawnerHandler&&(e|=J),n.creatureHandler&&(e|=g),n.growthHandler&&(e|=rt),n.corrosiveHandler&&(e|=Tt),n.infectiousHandler&&(e|=tt),n.projectileHandler&&(e|=et),n.lightningHandler&&(e|=Ht),n.fireworkHandler&&(e|=se),n.bubbleHandler&&(e|=Ee),n.cometHandler&&(e|=ce),q[t]=e}const H=32,G=5,re=60;class Te{chunkCols=0;chunkRows=0;cols=0;rows=0;active;sleepCounter;checksum;renderDirty;stampGrid;tickParity=0;init(n,e){this.cols=n,this.rows=e,this.chunkCols=Math.ceil(n/H),this.chunkRows=Math.ceil(e/H);const r=this.chunkCols*this.chunkRows;this.active=new Uint8Array(r).fill(1),this.sleepCounter=new Uint8Array(r),this.checksum=new Int32Array(r),this.renderDirty=new Uint8Array(r).fill(1),this.stampGrid=new Uint8Array(n*e),this.tickParity=0}wakeChunk(n,e){if(n<0||n>=this.chunkCols||e<0||e>=this.chunkRows)return;const r=e*this.chunkCols+n;this.active[r]=1,this.sleepCounter[r]=0}flipTick(){this.tickParity=this.tickParity?0:1}wakeRadius(n,e,r){const E=Math.max(0,n-r>>G),M=Math.min(this.chunkCols-1,n+r>>G),i=Math.max(0,e-r>>G),T=Math.min(this.chunkRows-1,e+r>>G);for(let u=i;u<=T;u++)for(let c=E;c<=M;c++){const o=u*this.chunkCols+c;this.renderDirty[o]=1,this.wakeChunk(c,u)}}wakeNeighbors(n,e){for(let r=-1;r<=1;r++)for(let E=-1;E<=1;E++)this.wakeChunk(n+E,e+r)}updateActivity(n,e){const{chunkCols:r,chunkRows:E,cols:M,rows:i}=this;for(let T=0;T<E;T++)for(let u=0;u<r;u++){const c=T*r+u;if(!this.active[c])continue;const o=this.computeChecksum(n,u,T,M,i);if(o!==this.checksum[c])this.checksum[c]=o,this.sleepCounter[c]=0,this.renderDirty[c]=1,this.wakeNeighbors(u,T);else{const f=this.sleepCounter[c]+1;this.sleepCounter[c]=f>255?255:f,f>=re&&(e&&this.chunkHasMatch(n,u,T,e)?this.sleepCounter[c]=0:this.active[c]=0)}}}wakeAll(){this.active.fill(1),this.sleepCounter.fill(0),this.renderDirty.fill(1)}computeChecksum(n,e,r,E,M){const i=e<<G,T=r<<G,u=Math.min(i+H,E),c=Math.min(T+H,M);let o=0;for(let f=T;f<c;f++){const s=f*E,l=f*137+1|0;for(let a=i;a<u;a++)o=o+n[s+a]*(a+l)|0}return o}chunkHasMatch(n,e,r,E){const M=e<<G,i=r<<G,T=Math.min(M+H,this.cols),u=Math.min(i+H,this.rows);for(let c=i;c<u;c++){const o=c*this.cols;for(let f=M;f<T;f++)if(E(n[o+f]))return!0}return!1}}function le(t,n,e,r,E){const{chunkCols:M,chunkRows:i,renderDirty:T}=E;for(let u=0;u<i;u++)for(let c=0;c<M;c++){const o=u*M+c;if(!T[o])continue;T[o]=0;const f=u<<G,s=c<<G,l=Math.min(f+H,e),a=Math.min(s+H,n);for(let L=f;L<l;L++){const A=L*n;for(let I=s;I<a;I++){const S=A+I,h=t[S];h===0?r[S]=$:h===6?r[S]=Bt[I+L&31]:h===10?r[S]=dt[I+L&63]:h===13?r[S]=_t[I+L&31]:h===59?r[S]=Ct[I+L&31]:r[S]=Y[h]}}}}function it(t){let n=t|0;const e=function(){n=n+1831565813|0;let r=Math.imul(n^n>>>15,1|n);return r=r+Math.imul(r^r>>>7,61|r)^r,((r^r>>>14)>>>0)/4294967296};return e.getState=()=>n,e.setState=r=>{n=r|0},e}const Gt=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],ue=[35,36,37,38,31,32,33,34];function vt(t,n,e,r,E,M,i,T,u,c,o){const f=(l,a)=>a*u+l,s=t[r];if(s===22||s===11)return t[r]=6,t[n]=39,!0;if(s===9||s===15||s===21||s===25||s===14)return t[r]=e,t[n]=39,!0;if(s===2)return o()<.15?t[n]=39:o()<.5||(t[r]=e,t[n]=39),!0;if(s===30){const l=E+i,a=M+T;return l>=0&&l<u&&a>=0&&a<c&&t[f(l,a)]===0&&(t[f(l,a)]=e),t[n]=39,!0}return s===46?(t[n]=ue[e-31],!0):s===5||s===26||s===12||s===8||s===7||s>=31&&s<=38||s===39?(t[r]=e,t[n]=39,!0):s===4||s===3||s===1?(o()<.2||(t[r]=e),t[n]=39,!0):s===0?(t[r]=e,t[n]=39,!0):(t[n]=39,!0)}function Me(t,n,e,r,E,M,i,T,u){const c=E-31,[o,f]=Gt[c];if(f>0||o!==0&&o>0===T)return;const s=n+o,l=e+f;if(s<0||s>=M||l<0||l>=i){t[r]=39;return}const a=l*M+s;vt(t,r,E,a,s,l,o,f,M,i,u)}function ae(t,n,e,r,E,M,i,T,u){const c=E-31,[o,f]=Gt[c];if(o!==0&&o>0===T)return;const s=n+o,l=e+f;if(s<0||s>=M||l<0||l>=i){t[r]=39;return}const a=l*M+s;vt(t,r,E,a,s,l,o,f,M,i,u)}function Le(t,n,e){e()<.3&&(t[n]=0)}function m(t,n,e,r){return t>=0&&t<e&&n>=0&&n<r}function nt(t,n,e,r,E,M,i,T,u,c,o){for(let f=0;f<T;f++){const s=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(s===0&&l===0)continue;const a=n+s,L=e+l;if(!m(a,L,E,M))continue;const A=t[L*E+a];for(let I=0;I<u.length;I++)if(A===u[I])return t[r]=c,!0;if(o){const I=o(A);if(I!==!1)return t[r]=I,!0}}return!1}function lt(t,n){const e=Math.floor(t()*3)-1,r=t()<n?1:Math.floor(t()*3)-1;return[e,r]}const ut=[6,10,13,19];function Ae(t,n,e,r,E,M,i){if(nt(t,n,e,r,E,M,i,2,ut,6,L=>L===16||L===17?0:!1)){if(t[r]===6)for(let L=0;L<4;L++){const A=n+Math.floor(i()*3)-1,I=e+Math.floor(i()*3)-1;m(A,I,E,M)&&t[I*E+A]===0&&i()<.5&&(t[I*E+A]=6)}return}if(i()<.003){t[r]=8;return}if(i()<.4)return;const T=i(),u=i();let c=0,o=0;if(T<.5?(o=-1,c=u<.35?-1:u<.7?1:0):T<.75?(c=u<.5?-2:2,o=u<.4?-1:0):T<.9&&(o=1,c=u<.5?-1:1),c===0&&o===0)return;const f=n+c,s=e+o;if(!m(f,s,E,M))return;const l=s*E+f,a=t[l];a===15||a===9||a===25?(t[l]=21,t[r]=i()<.6?21:5):(a===0||a===8)&&(t[l]=21,t[r]=0)}function Re(t,n,e,r,E,M,i){if(nt(t,n,e,r,E,M,i,2,ut,6))return;const T=i(),u=i();let c=0,o=0;if(T<.3?(o=-1,c=u<.4?-1:u<.8?1:0):T<.5?(o=1,c=u<.4?-1:u<.8?1:0):T<.8&&(c=u<.5?-1:1,o=u<.3?-1:u<.6?1:0),c===0&&o===0)return;const f=n+c,s=e+o;if(!m(f,s,E,M))return;const l=s*E+f,a=t[l];if(a===5){if(i()<.08)for(let L=-1;L<=1;L++)for(let A=-1;A<=1;A++){if(L===0&&A===0)continue;const I=f+A,S=s+L;if(m(I,S,E,M)&&t[S*E+I]===0){t[S*E+I]=26;break}}}else a===0?(t[l]=25,t[r]=0):a===26&&(t[l]=25,t[r]=i()<.1?28:i()<.15?0:26)}function he(t,n,e,r,E,M,i){if(nt(t,n,e,r,E,M,i,2,[6,10,42],6,l=>l===2||l===41||l===21?0:!1))return;if(i()<.15){const l=n+Math.floor(i()*3)-1,a=e+Math.floor(i()*3)-1;m(l,a,E,M)&&t[a*E+l]===0&&(t[a*E+l]=i()<.7?56:20)}if(i()<.5)return;let T=0,u=0;for(let l=0;l<3;l++){const a=Math.floor(i()*9)-4,L=Math.floor(i()*9)-4,A=n+a,I=e+L;if(m(A,I,E,M)&&t[I*E+A]===26){T=Math.sign(a),u=Math.sign(L);break}}if(T===0&&u===0){const l=i();l<.25?(u=-1,T=i()<.5?-1:1):l<.4?(u=1,T=i()<.5?-1:1):l<.7&&(T=i()<.5?-1:1)}if(T===0&&u===0)return;const c=n+T,o=e+u;if(!m(c,o,E,M))return;const f=o*E+c,s=t[f];if(s===0)t[f]=61,t[r]=0;else if(s===26&&i()<.03){const l=n+Math.floor(i()*3)-1,a=e+Math.floor(i()*3)-1;m(l,a,E,M)&&t[a*E+l]===0&&(t[a*E+l]=61)}}function Ie(t,n,e,r,E,M,i){if(nt(t,n,e,r,E,M,i,1,ut,6)||i()<.5)return;const[T,u]=lt(i,.7);if(T===0&&u===0)return;const c=n+T,o=e+u;if(!m(c,o,E,M))return;const f=o*E+c,s=t[f];s===5?(t[f]=9,t[r]=i()<.3?0:3):s===0?(t[f]=9,t[r]=0):s===2&&(t[f]=9,t[r]=2)}function Pe(t,n,e,r,E,M,i){if(i()<.5)return;const T=e>0?t[(e-1)*E+n]:0,u=T===5||T===26||T===3,c=Math.floor(i()*3)-1,o=u?-1:i()<.7?1:Math.floor(i()*3)-1;if(c===0&&o===0)return;const f=n+c,s=e+o;if(!m(f,s,E,M))return;const l=s*E+f,a=t[l];if(a===6||a===10||a===42){t[r]=6;return}if(a===41){t[r]=0;return}if(a===2){t[l]=15,t[r]=2;return}(a===3||a===1||a===5||a===26||a===0)&&(t[l]=15,t[r]=0)}function Se(t,n,e,r,E,M,i){if(i()<.4)return;const[T,u]=lt(i,.3);if(T===0&&u===0)return;const c=n+T,o=e+u;if(!m(c,o,E,M))return;const f=o*E+c,s=t[f];s===0?(t[f]=16,t[r]=i()<.1?14:0):s===9||s===15||s===21||s===25||s===14||s===5||s===26?(t[f]=16,t[r]=14):(s===6||s===10||s===13)&&(t[r]=14)}function Ye(t,n,e,r,E,M,i){if(i()<.4)return;const[T,u]=lt(i,.6);if(T===0&&u===0)return;const c=n+T,o=e+u;if(!m(c,o,E,M))return;const f=o*E+c,s=t[f];if(s===6||s===42||s===41||s===21){t[r]=0;return}s===3||s===1||s===0?(t[f]=62,t[r]=0):s===2&&(t[f]=62,t[r]=2)}function Ne(t,n,e,r,E,M,i){if(i()<.3)return;const T=Math.floor(i()*3)-1,u=i()<.6?-1:Math.floor(i()*3)-1;if(T===0&&u===0)return;const c=n+T,o=e+u;if(!m(c,o,E,M))return;const f=o*E+c,s=t[f];if(s===6||s===42||s===10){t[r]=56;return}s===0?(t[f]=63,t[r]=i()<.15?56:0):s===3||s===1?(t[f]=63,t[r]=26):s===2?(t[f]=63,t[r]=56):s===5?(t[f]=63,t[r]=26):s===4&&(t[r]=i()<.1?56:0)}function Oe(t,n,e,r,E,M,i){let T=!1;if((e<M-1&&t[(e+1)*E+n]===2||e>0&&t[(e-1)*E+n]===2||n>0&&t[e*E+n-1]===2||n<E-1&&t[e*E+n+1]===2)&&(T=!0),!T){t[r]=0;return}if(i()<.4)return;const u=Math.floor(i()*3)-1,c=Math.floor(i()*3)-1;if(u===0&&c===0)return;const o=n+u,f=e+c;if(!m(o,f,E,M))return;const s=f*E+o,l=t[s];(l===2||l===9||l===51||l===62)&&(t[s]=64,t[r]=2)}function Ue(t,n,e,r,E,M,i){if(i()<.3)return;let T=0,u=0;for(let L=0;L<2;L++){const A=Math.floor(i()*9)-4,I=Math.floor(i()*9)-4,S=n+A,h=e+I;if(m(S,h,E,M)){const R=t[h*E+S];if(R===6||R===19||R===61||R===13){T=Math.sign(A),u=Math.sign(I);break}}}const c=T!==0?T:Math.floor(i()*3)-1,o=u!==0?u:i()<.4?-1:Math.floor(i()*3)-1;if(c===0&&o===0)return;const f=n+c,s=e+o;if(!m(f,s,E,M))return;const l=s*E+f,a=t[l];if(a===6||a===19||a===42||a===10){t[r]=6;return}a===0?(t[l]=65,t[r]=0):(a===5||a===26)&&(t[l]=65,t[r]=i()<.3?0:5)}function Fe(t,n,e,r,E,M,i,T,u,c){const o=(s,l)=>l*M+s;if(e===0){t[r]=0;return}if(T()<.03){t[r]=T()<.25?7:T()<.15?19:0;return}for(let s=0;s<3;s++){const l=Math.floor(T()*7)-3,a=Math.floor(T()*7)-3;if(l===0&&a===0)continue;const L=n+l,A=e+a;if(L>=0&&L<M&&A>=0&&A<i){const I=o(L,A),S=t[I];S!==0&&q[S]&Wt&&T()<.4&&(t[I]=6)}}const f=o(n,e-1);if(e>0&&t[f]===0)t[f]=E,t[r]=0,u[f]=c;else{const s=T()<.5?-1:1;if(e>0&&n+s>=0&&n+s<M&&t[o(n+s,e-1)]===0){const l=o(n+s,e-1);t[l]=E,t[r]=0,u[l]=c}}}function Be(t,n,e,r,E,M,i,T,u){const c=(f,s)=>s*E+f;if(e===0){t[r]=0;return}if(i()<.08){const f=i()<.5?-1:1;if(n+f>=0&&n+f<E&&t[c(n+f,e)]===0){const s=c(n+f,e);t[s]=7,t[r]=0,T[s]=u;return}}if(i()<.3)return;const o=c(n,e-1);if(e>0&&t[o]===0)t[o]=7,t[r]=0,T[o]=u;else{const f=i()<.5?-1:1;if(e>0&&n+f>=0&&n+f<E&&t[c(n+f,e-1)]===0){const s=c(n+f,e-1);t[s]=7,t[r]=0,T[s]=u}else if(n+f>=0&&n+f<E&&t[c(n+f,e)]===0){const s=c(n+f,e);t[s]=7,t[r]=0,T[s]=u}}}function de(t,n,e,r,E,M,i,T,u){const c=(f,s)=>s*E+f;if(e===0){t[r]=0;return}if(i()<.08){t[r]=0;return}for(let f=0;f<3;f++){const s=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(s===0&&l===0)continue;const a=n+s,L=e+l;if(a>=0&&a<E&&L>=0&&L<M){const A=t[c(a,L)];A===1&&i()<.5?t[c(a,L)]=10:(A===5||A===8||A===7||A===26)&&i()<.5&&(t[c(a,L)]=6)}}const o=c(n,e-1);if(e>0&&t[o]===0)t[o]=10,t[r]=0,T[o]=u;else{const f=i()<.5?-1:1;if(e>0&&n+f>=0&&n+f<E&&t[c(n+f,e-1)]===0){const s=c(n+f,e-1);t[s]=10,t[r]=0,T[s]=u}}}function _e(t,n,e,r,E,M,i,T,u){const c=(o,f)=>f*E+o;if(i()<.01){t[r]=0;return}for(let o=0;o<3;o++){const f=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1;if(f===0&&s===0)continue;const l=n+f,a=e+s;if(l>=0&&l<E&&a>=0&&a<M){const L=t[c(l,a)];if((L===5||L===26||L===8||L===28||L===3||L===51)&&i()<.35){t[c(l,a)]=45,t[r]=0;break}}}if(t[r]===50&&i()<.4){const o=Math.floor(i()*3)-1,f=i()<.6?-1:i()<.5?0:1,s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M&&t[c(s,l)]===0){const a=c(s,l);t[a]=50,t[r]=0,T[a]=u}}}function Ce(t,n,e,r,E,M,i,T,u){const c=(o,f)=>f*E+o;if(e<M-1&&t[c(n,e+1)]===0&&i()<.04&&(t[c(n,e+1)]=2),i()<.3){const o=i()<.5?-1:1,f=i()<.3?-1:i()<.5?1:0,s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M&&t[c(s,l)]===0){const a=c(s,l);t[a]=40,t[r]=0,T[a]=u}}}function De(t,n,e,r,E,M,i,T,u){const c=(f,s)=>s*E+f,o=[6,19,20,10,56,59];if(e>0&&i()<.95){const f=c(n,e-1);if(t[f]===0)t[f]=54,t[r]=0,T[f]=u;else{t[r]=0;const s=Xt;for(let l=-s;l<=s;l++)for(let a=-s;a<=s;a++)if(a*a+l*l<=s*s&&i()<.5){const L=n+a,A=e+l;L>=0&&L<E&&A>=0&&A<M&&t[c(L,A)]===0&&(t[c(L,A)]=o[Math.floor(i()*o.length)])}}}else{t[r]=0;const f=Qt;for(let s=-f;s<=f;s++)for(let l=-f;l<=f;l++)if(l*l+s*s<=f*f&&i()<.45){const a=n+l,L=e+s;a>=0&&a<E&&L>=0&&L<M&&t[c(a,L)]===0&&(t[c(a,L)]=o[Math.floor(i()*o.length)])}}}function be(t,n,e,r,E,M,i,T,u){const c=(f,s)=>s*E+f;let o=!1;for(let f=0;f<3;f++){const s=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1,a=n+s,L=e+l;if(a>=0&&a<E&&L>=0&&L<M){const A=t[c(a,L)];if(A===2||A===41||A===28||A===52){o=!0;break}}}if(o){if(e>0&&i()<.6){const f=c(n,e-1),s=t[f];if(s===2||s===41||s===28||s===52)t[f]=55,t[r]=s,T[f]=u;else if(s===0){t[r]=0;for(let l=0;l<3;l++){const a=n+Math.floor(i()*3)-1,L=e-1-Math.floor(i()*2);a>=0&&a<E&&L>=0&&L<M&&t[c(a,L)]===0&&(t[c(a,L)]=2)}}}if(i()<.2){const f=i()<.5?-1:1;if(n+f>=0&&n+f<E){const s=c(n+f,e),l=t[s];(l===2||l===41||l===28||l===52)&&(t[s]=55,t[r]=l,T[s]=u)}}}else t[r]=7}function We(t,n,e,r,E,M,i,T,u){const c=(l,a)=>a*E+l,o=i()<.8?-2:-1,f=Math.floor(i()*3)-1;let s=!1;for(let l=Math.abs(o);l>0;l--){const a=e-l,L=n+(l===Math.abs(o)?f:0);if(a>=0&&a<M&&L>=0&&L<E){const A=c(L,a),I=t[A];if(I===0){t[A]=58,t[r]=59,T[A]=u,s=!0;break}else if(I===2){t[A]=7,t[r]=59,s=!0;break}else if(I===5||I===8||I===26){t[A]=59,t[r]=59,s=!0;break}else if(I===1){t[A]=12,t[r]=59,s=!0;break}else{t[r]=0;for(let S=-2;S<=2;S++)for(let h=-2;h<=2;h++){const R=n+h,O=e+S;R>=0&&R<E&&O>=0&&O<M&&t[c(R,O)]===0&&(t[c(R,O)]=i()<.6?59:19)}s=!0;break}}}(!s||i()<.05)&&(t[r]=59)}function me(t,n,e,r,E,M,i,T,u){const c=(f,s)=>s*E+f;if(i()<.2){t[r]=i()<.2?20:0;return}let o=!1;for(let f=1;f<=3&&!o;f++){const s=e+f;if(s>=M)break;const l=c(n,s),a=t[l];if(a===1){t[l]=12,t[r]=0,o=!0;for(let L=0;L<3;L++){let A=n,I=s,S=i()<.5?-1:1;for(let h=0;h<8&&(i()<.3&&(S=i()<.5?-1:1),A+=S,I+=i()<.8?1:0,!(A<0||A>=E||I>=M));h++){const R=c(A,I);if(t[R]===1)t[R]=12;else if(t[R]!==0&&t[R]!==12)break}}}else if(a===2){t[l]=13,t[r]=0,o=!0;for(let L=-3;L<=3;L++){const A=n+L;A>=0&&A<E&&t[c(A,s)]===2&&i()<.7&&(t[c(A,s)]=13)}}else if(a===5||a===8||a===9)t[l]=6,t[r]=0,o=!0;else if(a===11){t[r]=0;const L=Zt;for(let A=-L;A<=L;A++)for(let I=-L;I<=L;I++)if(I*I+A*A<=L*L){const S=n+I,h=s+A;if(S>=0&&S<E&&h>=0&&h<M){const R=c(S,h),O=t[R];O===2?t[R]=i()<.7?4:0:O!==4&&O!==12&&(t[R]=6)}}o=!0}else if(a===4||a===12)t[r]=0,o=!0;else if(a===3)i()<.4&&(t[l]=12),t[r]=0,o=!0;else{if(a===0)continue;t[r]=0,o=!0}}if(!o&&e+1<M&&t[c(n,e+1)]===0){const f=c(n,e+1);if(t[f]=13,t[r]=0,T[f]=u,i()<.15){const s=n+(i()<.5?-1:1);s>=0&&s<E&&t[c(s,e)]===0&&(t[c(s,e)]=13)}}else o||(t[r]=0)}function He(t,n,e,r,E){const{chunkCols:M,active:i,stampGrid:T,tickParity:u}=r;for(let c=0;c<e;c++){const o=c>>G,f=E()<.5;for(let s=0;s<M;s++){const l=f?s:M-1-s;if(!i[o*M+l])continue;const a=l<<G,L=Math.min(a+H,n),A=L-a;for(let I=0;I<A;I++){const S=f?a+I:L-1-I,h=c*n+S,R=t[h];if(R===0||T[h]===u)continue;const O=q[R];if(O&et){R>=31&&R<=38&&R!==35&&R!==34&&R!==36&&R!==39&&Me(t,S,c,h,R,n,e,f,E);continue}if(O&g){switch(R){case 21:Ae(t,S,c,h,n,e,E);break;case 25:Re(t,S,c,h,n,e,E);break;case 61:he(t,S,c,h,n,e,E);break}continue}if(R===6||R===59){Fe(t,S,c,h,R,n,e,E,T,u);continue}if(R===7){Be(t,S,c,h,n,e,E,T,u);continue}if(R===10){de(t,S,c,h,n,e,E,T,u);continue}if(O&tt){R===50&&_e(t,S,c,h,n,e,E,T,u);continue}if(R===40){Ce(t,S,c,h,n,e,E,T,u);continue}if(R===54){De(t,S,c,h,n,e,E,T,u);continue}if(R===55){be(t,S,c,h,n,e,E,T,u);continue}if(R===58){We(t,S,c,h,n,e,E,T,u);continue}if(R===13){me(t,S,c,h,n,e,E,T,u);continue}}}}}function Ge(t,n,e,r,E,M,i){const T=(o,f)=>f*E+o,u=e<M-1?t[T(n,e+1)]:0;let c=!1;for(let o=0;o<3;o++){const f=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1;if(f===0&&s===0)continue;const l=n+f,a=e+s;if(l>=0&&l<E&&a>=0&&a<M){const L=T(l,a),A=t[L];if((A===5||A===3||A===1||A===8||A===26||A===14)&&i()<.3){t[L]=i()<.7?0:7,i()<.4&&(t[r]=0,c=!0);break}if((A===4||A===12||A===18)&&i()<.08){t[L]=0,t[r]=0,c=!0;break}if((A===9||A===15||A===21||A===25)&&i()<.5){t[L]=41;break}}}if(!c)if(u===0)t[T(n,e+1)]=41,t[r]=0;else{const o=i()<.5?-1:1,f=n+o,s=n-o;f>=0&&f<E&&t[T(f,e+1)]===0?(t[T(f,e+1)]=41,t[r]=0):s>=0&&s<E&&t[T(s,e+1)]===0?(t[T(s,e+1)]=41,t[r]=0):f>=0&&f<E&&t[T(f,e)]===0?(t[T(f,e)]=41,t[r]=0):s>=0&&s<E&&t[T(s,e)]===0&&(t[T(s,e)]=41,t[r]=0)}}function ve(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c,u=e<M-1?t[T(n,e+1)]:0;for(let c=0;c<3;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=T(s,l),L=t[a];if(L===2){if(t[a]=i()<.5?4:7,i()<.15){t[r]=4;break}}else L===43?t[a]=2:L===1&&i()<.4?t[a]=12:((L===5||L===8||L===7||L===26||L===22||L===27||L===29)&&i()<.7||(L===9||L===15||L===21||L===25)&&i()<.8)&&(t[a]=6)}}if(i()<.001){t[r]=4;return}if(!(i()>.15))if(u===0)t[T(n,e+1)]=42,t[r]=0;else{const c=i()<.5?-1:1,o=n+c,f=n-c;o>=0&&o<E&&t[T(o,e+1)]===0?(t[T(o,e+1)]=42,t[r]=0):f>=0&&f<E&&t[T(f,e+1)]===0?(t[T(f,e+1)]=42,t[r]=0):o>=0&&o<E&&t[T(o,e)]===0&&i()<.3?(t[T(o,e)]=42,t[r]=0):f>=0&&f<E&&t[T(f,e)]===0&&i()<.3&&(t[T(f,e)]=42,t[r]=0)}}function ke(t,n,e,r,E,M,i){const T=(u,c)=>c*E+u;if(i()<.008){t[r]=0;return}for(let u=0;u<2;u++){const c=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(c===0&&o===0)continue;const f=n+c,s=e+o;if(f>=0&&f<E&&s>=0&&s<M){const l=t[T(f,s)];if(l===6||l===10||l===42||l===41){t[r]=l===41?0:6;break}}}if(!(t[r]===6||t[r]===0)&&i()<.08){const u=Math.floor(i()*3)-1,c=Math.floor(i()*3)-1,o=n+u,f=e+c;if(o>=0&&o<E&&f>=0&&f<M){const s=T(o,f),l=t[s];l===5||l===26||l===8||l===28||l===3?(t[s]=45,i()<.2&&(t[r]=i()<.4?50:7)):(l===9||l===15||l===14)&&i()<.3?t[s]=45:l===0&&i()<.1&&(t[s]=45,t[r]=i()<.3?7:0)}}}function xe(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c,u=e<M-1?t[T(n,e+1)]:0;for(let c=0;c<2;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=t[T(s,l)];(a===9||a===15||a===21||a===25||a===14)&&i()<.5&&(t[T(s,l)]=0)}}if(u===0)t[T(n,e+1)]=46,t[r]=0;else if(u===2||u===41||u===28||u===1||u===3)i()<.7&&(t[T(n,e+1)]=46,t[r]=u);else{const c=i()<.5?-1:1,o=n+c,f=n-c;o>=0&&o<E&&t[T(o,e+1)]===0?(t[T(o,e+1)]=46,t[r]=0):f>=0&&f<E&&t[T(f,e+1)]===0?(t[T(f,e+1)]=46,t[r]=0):o>=0&&o<E&&t[T(o,e)]===0?(t[T(o,e)]=46,t[r]=0):f>=0&&f<E&&t[T(f,e)]===0&&(t[T(f,e)]=46,t[r]=0)}}function ye(t,n,e,r,E,M,i){const T=(u,c)=>c*E+u;if(i()<.003){t[r]=0;return}for(let u=0;u<2;u++){const c=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(c===0&&o===0)continue;const f=n+c,s=e+o;if(f>=0&&f<E&&s>=0&&s<M&&t[T(f,s)]===13){t[r]=20;break}}if(t[r]!==20&&i()<.1){const u=Math.floor(i()*3)-1,c=Math.floor(i()*3)-1,o=n+u,f=e+c;if(o>=0&&o<E&&f>=0&&f<M){const s=T(o,f),l=t[s];if(l!==0&&l!==4&&l!==12&&l!==18&&l!==47&&l!==23&&l!==44&&(t[s]=0,i()<.02)){const a=n+Math.floor(i()*3)-1,L=e+Math.floor(i()*3)-1;a>=0&&a<E&&L>=0&&L<M&&t[T(a,L)]===0&&(t[T(a,L)]=47)}}}}function we(t,n,e,r,E,M,i){const T=(o,f)=>f*E+o,u=e<M-1?t[T(n,e+1)]:0;if(i()<.005){t[r]=3;return}let c=!1;for(let o=0;o<2;o++){const f=Math.floor(i()*3)-1,s=Math.floor(i()*3)-1,l=n+f,a=e+s;if(l>=0&&l<E&&a>=0&&a<M&&t[T(l,a)]===2){c=!0;break}}if(c&&i()<.03){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1,s=n+o,l=e+f;s>=0&&s<E&&l>=0&&l<M&&t[T(s,l)]===4&&(t[T(s,l)]=49)}u===0&&i()<.1&&(t[T(n,e+1)]=49,t[r]=0)}function Ve(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c,u=e<M-1?t[T(n,e+1)]:0;for(let c=0;c<3;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=t[T(s,l)];(a===9||a===15||a===21||a===25||a===14)&&i()<.5||a===51&&i()<.08||a===5&&i()<.05?t[T(s,l)]=52:a===2&&i()<.15&&(t[T(s,l)]=0,i()<.5&&(t[r]=2))}}if(t[r]===52&&!(i()>.3))if(u===0)t[T(n,e+1)]=52,t[r]=0;else{const c=i()<.5?-1:1,o=n+c,f=n-c;o>=0&&o<E&&t[T(o,e+1)]===0?(t[T(o,e+1)]=52,t[r]=0):f>=0&&f<E&&t[T(f,e+1)]===0?(t[T(f,e+1)]=52,t[r]=0):o>=0&&o<E&&t[T(o,e)]===0?(t[T(o,e)]=52,t[r]=0):f>=0&&f<E&&t[T(f,e)]===0&&(t[T(f,e)]=52,t[r]=0)}}function pe(t,n,e,r,E,M,i){const T=(s,l)=>l*E+s;if(i()<.92)return;const u=Math.floor(i()*3)-1,c=i()<.7?-1:Math.floor(i()*3)-1,o=n+u,f=e+c;o>=0&&o<E&&f>=0&&f<M&&t[T(o,f)]===2&&(t[T(o,f)]=i()<.1?26:5)}function Ke(t,n,e,r,E,M,i){const T=(U,F)=>F*E+U,u=e<M-1?t[T(n,e+1)]:0,c=e>0?T(n,e-1):-1,o=c>=0?t[c]:0;if(!(u===2&&o!==2&&i()<.7)){if(u===2&&o===2){t[c]=48,t[r]=2;return}else if(u===0){t[T(n,e+1)]=48,t[r]=0;return}}const f=Math.floor(i()*8),s=[0,1,1,1,0,-1,-1,-1][f],l=[-1,-1,0,1,1,1,0,-1][f],a=n+s,L=e+l;if(a>=0&&a<E&&L>=0&&L<M){const U=t[T(a,L)];if(U===6||U===10||U===42){t[r]=6;return}if((U===9||U===15||U===21)&&i()<.3){t[r]=0;return}}if(i()>.35||!(e<M-1&&(t[T(n,e+1)]===3||t[T(n,e+1)]===2)||o===3||o===2||o===5))return;let I=!1,S=!1;for(let U=0;U<6;U++){const F=Math.floor(i()*13)-6,v=Math.floor(i()*13)-6,X=n+F,D=e+v;if(X>=0&&X<E&&D>=0&&D<M){const d=t[T(X,D)];d===2&&(I=!0),d===57&&(S=!0)}}const h=S?.7:I?.5:.25;if(i()>h)return;const R=S?50:I?30:20;let O=-1;for(let U=1;U<=R&&!(e-U<0);U++){const F=t[T(n,e-U)];if(F===0||F===2){O=e-U;break}if(F!==5&&F!==26&&F!==3&&F!==48)break}if(O>=0){const U=S?.3:I?.15:.1;t[T(n,O)]=i()<U?26:5}const C=e-(O>=0?O:e);if(C>10&&i()<(S?.2:.1)){const U=n+(i()<.5?-1:1),F=e-Math.floor(i()*Math.min(C,15))-5,v=U>=0&&U<E&&F>=0?t[T(U,F)]:-1;(v===0||v===2)&&(t[T(U,F)]=i()<.4?26:5)}}function qe(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c;let u=!1;if((e>0&&t[T(n,e-1)]===2||e<M-1&&t[T(n,e+1)]===2||n>0&&t[T(n-1,e)]===2||n<E-1&&t[T(n+1,e)]===2)&&(u=!0),!u&&i()<.001){t[r]=5;return}if(u&&i()<.015&&e>0){const c=T(n,e-1);t[c]===2&&(t[c]=7)}if(u&&i()<.06){const c=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1,f=n+c,s=e+o;f>=0&&f<E&&s>=0&&s<M&&t[T(f,s)]===2&&(t[T(f,s)]=51)}for(let c=0;c<2;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=t[T(s,l)];if((a===9||a===14)&&i()<.25){t[r]=0;break}}}}function je(t,n,e,r,E,M,i){const T=(s,l)=>l*E+s;if(i()<.03){t[r]=i()<.33?18:i()<.5?19:20;return}const u=Math.floor(i()*3)-1,c=Math.floor(i()*3)-1;if(u===0&&c===0)return;const o=n+u,f=e+c;o>=0&&o<E&&f>=0&&f<M&&t[T(o,f)]===0&&(t[T(o,f)]=17,t[r]=0)}function Xe(t,n,e,r,E,M,i){i()<.002&&(t[r]=1)}function Qe(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c,u=e<M-1?t[T(n,e+1)]:0;if(i()<.05){t[r]=i()<.3?6:0;return}for(let c=0;c<2;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=t[T(s,l)];(a===5||a===8||a===7||a===26)&&i()<.4&&(t[T(s,l)]=6)}}if(u===0)t[T(n,e+1)]=19,t[r]=0;else{const c=i()<.5?-1:1;n+c>=0&&n+c<E&&t[T(n+c,e+1)]===0&&(t[T(n+c,e+1)]=19,t[r]=0)}}function Ze(t,n,e,r,E,M,i){const T=(o,f)=>f*E+o;if(i()<.08){t[r]=0;return}const u=Math.floor(i()*3)-1,c=Math.floor(i()*3)-1;if(u!==0||c!==0){const o=n+u,f=e+c;o>=0&&o<E&&f>=0&&f<M&&t[T(o,f)]===0&&(t[T(o,f)]=20,t[r]=0)}}function ze(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c;let u=!1;for(let c=0;c<2;c++){const o=Math.floor(i()*3)-1,f=Math.floor(i()*3)-1;if(o===0&&f===0)continue;const s=n+o,l=e+f;if(s>=0&&s<E&&l>=0&&l<M){const a=t[T(s,l)];if(a===6||a===10||a===19||a===42){t[r]=6;for(let L=0;L<10;L++){const A=Math.floor(i()*5)-2,I=Math.floor(i()*5)-2,S=n+A,h=e+I;S>=0&&S<E&&h>=0&&h<M&&t[T(S,h)]===53&&i()<.8&&(t[T(S,h)]=6)}u=!0;break}}}if(!u){if(i()<.003){t[r]=1;return}if(i()<.3){const c=Math.floor(i()*3)-1,o=i()<.6?1:i()<.5?0:-1,f=n+c,s=e+o;f>=0&&f<E&&s>=0&&s<M&&t[T(f,s)]===0&&(t[T(f,s)]=53,t[r]=0)}}}function $e(t,n,e,r,E,M,i){const T=(f,s)=>s*E+f,u=e<M-1?t[T(n,e+1)]:0;let c=0;for(let f=0;f<3;f++){const s=Math.floor(i()*3)-1,l=Math.floor(i()*3)-1;if(s===0&&l===0)continue;const a=n+s,L=e+l;a>=0&&a<E&&L>=0&&L<M&&t[T(a,L)]===56&&c++}const o=c===0?.15:c>0?.03:.01;if(i()<o){t[r]=0;return}if(i()<.3)if(u===0)t[T(n,e+1)]=56,t[r]=0;else{const f=i()<.5?-1:1;n+f>=0&&n+f<E&&t[T(n+f,e+1)]===0&&(t[T(n+f,e+1)]=56,t[r]=0)}}const Je={23:2,24:2,27:2,29:2,30:2,44:4,57:6,60:12,66:3};function ge(t,n,e,r,E,M,i){e<M-1&&t[(e+1)*E+n]===0&&i()<.15&&(t[(e+1)*E+n]=2)}function ti(t,n,e,r,E,M,i){if(i()<.06){const T=Math.floor(i()*3)-1,u=Math.floor(i()*3)-1,c=n+T,o=e+u;c>=0&&c<E&&o>=0&&o<M&&t[o*E+c]===0&&(t[o*E+c]=15)}}function ei(t,n,e,r,E,M,i){if(i()<.035){const T=Math.floor(i()*3)-1,u=Math.floor(i()*3)-1,c=n+T,o=e+u;c>=0&&c<E&&o>=0&&o<M&&t[o*E+c]===0&&(t[o*E+c]=25)}}function ii(t,n,e,r,E,M,i){if(i()<.02){const T=Math.floor(i()*3)-1,u=-1,c=n+T,o=e+u;c>=0&&c<E&&o>=0&&o<M&&t[o*E+c]===0&&(t[o*E+c]=21)}}function ni(t,n,e,r,E,M,i){if(i()<.08){const T=[31,32,33,34,35,36,37,38],u=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],c=Math.floor(i()*8);for(let o=0;o<8;o++){const f=(c+o)%8,[s,l]=u[f],a=n+s,L=e+l;if(a>=0&&a<E&&L>=0&&L<M&&t[L*E+a]===0){t[L*E+a]=T[f];break}}}}function oi(t,n,e,r,E,M,i){const T=(u,c)=>c*E+u;for(let u=0;u<3;u++){const c=Math.floor(i()*3)-1,o=Math.floor(i()*3)-1;if(c===0&&o===0)continue;const f=n+c,s=e+o;if(f>=0&&f<E&&s>=0&&s<M){const l=t[T(f,s)];if(l===2){if(t[T(f,s)]=7,i()<.08){t[r]=4;return}}else l===43&&(t[T(f,s)]=2)}}if(t[r]!==4){if(i()<.55&&e>0){const u=T(n,e-1);t[u]===0&&(t[u]=42)}if(i()<.25){const u=i()<.5?-1:1;if(n+u>=0&&n+u<E&&e>0){const c=T(n+u,e-1);t[c]===0&&(t[c]=42)}}if(i()<.1){const u=Math.floor(i()*3)-1,c=Math.floor(i()*2)-1,o=n+u,f=e+c;o>=0&&o<E&&f>=0&&f<M&&t[T(o,f)]===0&&(t[T(o,f)]=19)}}}function fi(t,n,e,r,E,M,i){const T=(u,c)=>c*E+u;if(i()<.12){const u=i()*6.28318,c=i()*4+1,o=n+Math.round(Math.cos(u)*c),f=e+Math.round(Math.sin(u)*c);o>=0&&o<E&&f>=0&&f<M&&t[T(o,f)]===0&&(t[T(o,f)]=i()<.6?20:56)}if(i()<.04){const u=i()*6.28318,c=i()*12+3,o=n+Math.round(Math.cos(u)*c),f=e+Math.round(Math.sin(u)*c);if(o>=0&&o<E&&f>=0&&f<M){const s=T(o,f),l=t[s];l===5&&i()<.3?t[s]=26:l===2&&i()<.1?t[s]=51:l===3&&i()<.15||l===0&&i()<.05?t[s]=5:l===43&&i()<.2?t[s]=2:l===45&&i()<.1&&(t[s]=26)}}if(i()<.02)for(let u=0;u<5;u++){const c=Math.floor(i()*5)-2,o=Math.floor(i()*5)-2,f=n+c,s=e+o;if(f>=0&&f<E&&s>=0&&s<M){const l=T(f,s);t[l]===2&&(t[l]=7)}}}function si(t,n,e,r,E,M,i){const T=(c,o)=>o*E+c;if(i()>.5)return;const u=zt;for(let c=0;c<$t;c++){const o=i()*6.28318,f=i()*u+1,s=Math.round(Math.cos(o)*f),l=Math.round(Math.sin(o)*f);if(s===0&&l===0)continue;const a=n+s,L=e+l;if(a<0||a>=E||L<0||L>=M)continue;const A=T(a,L),I=t[A];if(I===0||I===60||I===44||I===30||I===24||I===27)continue;const S=s>0?-1:s<0?1:0,h=l>0?-1:l<0?1:0,R=a+S,O=L+h;if(R>=0&&R<E&&O>=0&&O<M){const C=T(R,O);Math.abs(s+S)<=1&&Math.abs(l+h)<=1?t[A]=0:t[C]===0&&(t[C]=I,t[A]=0)}}for(let c=-6;c<=6;c+=2){const o=n+c;if(!(o<0||o>=E))for(let f=-8;f<=2;f+=2){const s=e+f;if(s<0||s>=M)continue;const l=T(o,s),a=t[l];if(!(a===0||a===60)&&Math.abs(c)>1&&i()<.3){const L=c>0?-1:1,A=o+L;A>=0&&A<E&&t[T(A,s)]===0&&(t[T(A,s)]=a,t[l]=0)}}}}function Ei(t,n,e,r,E,M,i){if(e>0&&i()<.2){const T=(e-1)*E+n;t[T]===0&&(t[T]=7)}if(i()<.08){const T=i()<.5?-1:1,u=n+T,c=e-1;u>=0&&u<E&&c>=0&&t[c*E+u]===0&&(t[c*E+u]=7)}}function ci(t,n,e,r,E,M,i,T,u,c){const o=P[i];if(T()>o.gravity||e>=M-1)return!1;const f=r+E,s=t[f];if(s===0)return t[f]=i,t[r]=0,u[f]=c,!0;if(o.density!==void 0){const l=P[s];if(l&&l.density!==void 0&&o.density>l.density&&q[s]&ct)return t[f]=i,t[r]=s,u[f]=c,!0}if(i!==3){const l=n>0&&t[f-1]===0,a=n<E-1&&t[f+1]===0;let L=0;if(l&&a?L=T()<.5?-1:1:l?L=-1:a&&(L=1),L!==0)return t[f+L]=i,t[r]=0,u[f+L]=c,!0}return!1}function ri(t,n,e,r,E,M,i,T,u){const c=P[M];if(i()>c.liquid)return!1;const o=i()<.5?-1:1;return n+o>=0&&n+o<E&&t[r+o]===0?(t[r+o]=M,t[r]=0,T[r+o]=u,!0):n-o>=0&&n-o<E&&t[r-o]===0?(t[r-o]=M,t[r]=0,T[r-o]=u,!0):!1}function Ti(t){return t>0&&(q[t]&J)!==0}function li(t){return(n,e)=>e*t+n}const ui={23:ge,24:ti,27:ei,29:ii,30:ni,44:oi,57:fi,60:si,66:Ei},Mi={9:Ie,15:Pe,16:Se,62:Ye,63:Ne,64:Oe,65:Ue},ai={41:Ge,42:ve,46:xe,47:ye,52:Ve},Li={45:ke,49:we},Ai={5:pe,48:Ke,51:qe},Ri={17:je,18:Xe,19:Qe,20:Ze,53:ze,56:$e},hi=et|g|Tt|tt|rt|J;function Mt(t,n,e,r,E,M,i,T,u,c,o,f,s,l,a,L,A){if(u===0){t[T]=E,t[r]=0,o[T]=f;return}if(l>=0&&u===l){t[T]=E,t[r]=l,o[T]=f;return}const I=c()<.5?-1:1,S=n+I,h=n-I;if(S>=0&&S<M&&t[s(S,e+1)]===0){const R=s(S,e+1);t[R]=E,t[r]=0,o[R]=f;return}if(a&&h>=0&&h<M&&t[s(h,e+1)]===0){const R=s(h,e+1);t[R]=E,t[r]=0,o[R]=f;return}if(L>0&&c()<L){if(S>=0&&S<M&&t[s(S,e)]===0){const R=s(S,e);t[R]=E,t[r]=0,o[R]=f;return}if(A&&h>=0&&h<M&&t[s(h,e)]===0){const R=s(h,e);t[R]=E,t[r]=0,o[R]=f;return}}}function Ii(t,n,e,r,E){const M=li(n),{chunkCols:i,active:T,stampGrid:u,tickParity:c}=r;for(let o=e-2;o>=0;o--){const f=o>>G,s=E()<.5;for(let l=0;l<i;l++){const a=s?l:i-1-l;if(!T[f*i+a])continue;const L=a<<G,A=Math.min(L+H,n),I=A-L;for(let S=0;S<I;S++){const h=s?L+S:A-1-S,R=o*n+h,O=t[R];if(O===0||u[R]===c)continue;u[R]=c;const C=q[O];if(C&bt||C&Ht)continue;if(C&hi){C&J?(ui[O]?.(t,h,o,R,n,e,E),r.wakeRadius(h,o,Je[O]??2)):C&et?O===35||O===34||O===36?ae(t,h,o,R,O,n,e,s,E):O===39&&Le(t,R,E):C&g?Mi[O]?.(t,h,o,R,n,e,E):C&Tt?ai[O]?.(t,h,o,R,n,e,E):C&tt?Li[O]?.(t,h,o,R,n,e,E):C&rt&&Ai[O]?.(t,h,o,R,n,e,E);continue}const U=Ri[O];if(U){U(t,h,o,R,n,e,E);continue}const F=M(h,o+1),v=o<e-1?t[F]:O;if(O===11){const D=o>0?t[M(h,o-1)]:0;if(v!==0&&v!==2&&v!==11||D!==0&&D!==2&&D!==11){const B=qt;for(let b=-B;b<=B;b++)for(let W=-B;W<=B;W++)if(W*W+b*b<=B*B){const _=h+W,x=o+b;if(_>=0&&_<n&&x>=0&&x<e){const w=M(_,x),V=t[w];V===2?t[w]=E()<.7?4:0:V!==4&&V!==12&&(t[w]=6)}}continue}if(t[R]!==11)continue;Mt(t,h,o,R,11,n,e,F,v,E,u,c,M,2,!0,1,!0);continue}if(O===22){for(let D=0;D<2;D++){const d=Math.floor(E()*3)-1,B=Math.floor(E()*3)-1;if(d===0&&B===0)continue;const b=h+d,W=o+B;if(b>=0&&b<n&&W>=0&&W<e){const _=t[M(b,W)];if(_===6||_===10||_===19||_===42){const x=jt;for(let w=-x;w<=x;w++)for(let V=-x;V<=x;V++)if(V*V+w*w<=x*x){const Nt=h+V,Ot=o+w;if(Nt>=0&&Nt<n&&Ot>=0&&Ot<e){const wt=M(Nt,Ot),Ut=t[wt];Ut!==4&&Ut!==12&&Ut!==2&&(t[wt]=6)}}break}}}if(t[R]!==22)continue;Mt(t,h,o,R,22,n,e,F,v,E,u,c,M,2,!0,0,!1);continue}if(O===14){for(let D=0;D<2;D++){const d=Math.floor(E()*3)-1,B=Math.floor(E()*3)-1;if(d===0&&B===0)continue;const b=h+d,W=o+B;if(b>=0&&b<n&&W>=0&&W<e){const _=t[M(b,W)];if(_===6||_===10||_===19||_===42){t[R]=7;break}}}if(t[R]!==14||E()<.6)continue;Mt(t,h,o,R,14,n,e,F,v,E,u,c,M,-1,!1,.3,!1);continue}if(O===43){let D=!1;if(E()<.4)for(let d=-1;d<=1&&!D;d++)for(let B=-1;B<=1&&!D;B++){if(d===0&&B===0)continue;const b=h+B,W=o+d;if(b>=0&&b<n&&W>=0&&W<e){const _=t[M(b,W)];(_===6||_===10||_===19||_===42)&&E()<.6?(t[R]=2,D=!0):_===2&&E()<.04&&(t[M(b,W)]=12)}}if(D)continue;if(E()<.25&&v===0)t[F]=43,t[R]=0,u[F]=c;else if(E()<.1){const d=E()<.5?-1:1;if(h+d>=0&&h+d<n&&t[M(h+d,o+1)]===0){const B=M(h+d,o+1);t[B]=43,t[R]=0,u[B]=c}}continue}if(C&mt)continue;let X=!1;C&Dt&&(X=ci(t,h,o,R,n,e,O,E,u,c)),!X&&C&ct&&ri(t,h,o,R,n,O,E,u,c)}}}}const p=[83,65,78,68],at=3,ot=17;class Lt{grid;cols;rows;chunkMap;rand;simStep;constructor(n,e,r){this.cols=n,this.rows=e,this.grid=new Uint8Array(n*e),this.chunkMap=new Te,this.chunkMap.init(n,e),this.rand=it(r??Date.now()),this.simStep=0}step(){this.chunkMap.flipTick(),He(this.grid,this.cols,this.rows,this.chunkMap,this.rand),Ii(this.grid,this.cols,this.rows,this.chunkMap,this.rand),this.chunkMap.updateActivity(this.grid,Ti),this.simStep++}save(){const n=ot+this.grid.length,e=new ArrayBuffer(n),r=new DataView(e),E=new Uint8Array(e);return E[0]=p[0],E[1]=p[1],E[2]=p[2],E[3]=p[3],E[4]=at,r.setUint16(5,this.cols,!0),r.setUint16(7,this.rows,!0),r.setInt32(9,this.rand.getState(),!0),r.setUint32(13,this.simStep,!0),E.set(this.grid,ot),e}static load(n){const e=new DataView(n),r=new Uint8Array(n);if(r[0]!==p[0]||r[1]!==p[1]||r[2]!==p[2]||r[3]!==p[3])throw new Error("Invalid save file: bad magic bytes");const E=r[4];if(E!==at)throw new Error(`Unsupported save format version: ${E} (expected ${at})`);const M=e.getUint16(5,!0),i=e.getUint16(7,!0),T=e.getInt32(9,!0),u=e.getUint32(13,!0),c=new Lt(M,i);return c.rand.setState(T),c.simStep=u,c.grid.set(r.subarray(ot,ot+M*i)),c.chunkMap.wakeAll(),c}reset(n){this.grid.fill(0),this.chunkMap.wakeAll(),this.rand=it(n??Date.now()),this.simStep=0}}let k=null,y=null,ft=null,st=null,Et=null,K=null,N=null,kt=!1,At=!1,Rt=[],ht=0,It=0,j=Ft;function Pi(t,n){N=new Lt(pt,Kt,Date.now()),ft=new OffscreenCanvas(N.cols,N.rows),st=ft.getContext("2d"),Et=st.createImageData(N.cols,N.rows),K=new Uint32Array(Et.data.buffer),K.fill($),j=Ft;const e=t/j,r=n/j;ht=Math.max(0,(N.cols-e)/2),It=Math.max(0,N.rows-r)}function xt(t,n,e,r){if(!N)return;const{grid:E,cols:M,rows:i,rand:T,chunkMap:u}=N,c=e==="erase"?0:Vt[e];if(c===30){if(t>=0&&t<M&&n>=0&&n<i){const o=n*M+t;E[o]!==4&&E[o]!==23&&E[o]!==30&&E[o]!==60&&(E[o]=30)}u.wakeRadius(t,n,1);return}for(let o=-r;o<=r;o++)for(let f=-r;f<=r;f++)if(f*f+o*o<=r*r){const s=t+f,l=n+o;if(s>=0&&s<M&&l>=0&&l<i){const a=l*M+s,L=P[c]?.spawnRate??.45;(e==="erase"||T()<L&&E[a]===0)&&(E[a]=c)}}u.wakeRadius(t,n,r+1)}function Si(){if(!N||!y||!k||!st||!ft||!Et||!K)return;le(N.grid,N.cols,N.rows,K,N.chunkMap),st.putImageData(Et,0,0);const t=k.width,n=k.height,e=t/j,r=n/j,E=Math.max(0,N.cols-e),M=Math.max(0,N.rows-r),i=Math.max(0,Math.min(ht,E)),T=Math.max(0,Math.min(It,M));if(y.fillStyle="#1a1a1a",y.fillRect(0,0,t,n),y.imageSmoothingEnabled=!1,y.drawImage(ft,i,T,e,r,0,0,t,n),At){y.strokeStyle="rgba(255, 0, 0, 0.6)",y.lineWidth=2;for(let u=0;u<N.chunkMap.chunkRows;u++)for(let c=0;c<N.chunkMap.chunkCols;c++){if(N.chunkMap.active[u*N.chunkMap.chunkCols+c])continue;const o=(c*H-i)*(t/e),f=(u*H-T)*(n/r),s=H*(t/e),l=H*(n/r);y.strokeRect(o,f,s,l)}}}let Q=0,Z=0;const Pt=1e3/60;let St=0,Yt=0;function yt(t){Q===0&&(Q=t);const n=Math.min(t-Q,100);Q=t;for(const e of Rt){const r=e.x-e.prevX,E=e.y-e.prevY,M=Math.max(Math.abs(r),Math.abs(E));if(M===0)xt(e.x,e.y,e.tool,e.brushSize);else for(let i=0;i<=M;i++){const T=i/M,u=Math.round(e.prevX+r*T),c=Math.round(e.prevY+E*T);xt(u,c,e.tool,e.brushSize)}}if(Rt=[],!kt&&N&&(Z+=n,Z>=Pt&&(N.step(),Z=Math.min(Z-Pt,Pt))),Si(),St++,t-Yt>=500){const e=Math.round(St/((t-Yt)/1e3));self.postMessage({type:"fps",data:e}),St=0,Yt=t}requestAnimationFrame(yt)}self.onmessage=t=>{const{type:n,data:e}=t.data;switch(n){case"init":k=t.data.canvas,y=k.getContext("2d"),Pi(k.width,k.height),Q=0,Z=0,requestAnimationFrame(yt);break;case"resize":k&&(k.width=e.width,k.height=e.height);break;case"input":Rt.push({x:e.cellX,y:e.cellY,prevX:e.prevX??e.cellX,prevY:e.prevY??e.cellY,tool:e.tool,brushSize:e.brushSize});break;case"camera":ht=e.camX,It=e.camY,j=e.zoom;break;case"pause":kt=e.paused;break;case"toggleDebugChunks":At=!At;break;case"reset":N&&(N.reset(Date.now()),K&&K.fill($));break;case"save":{if(!N)break;const r=N.save();self.postMessage({type:"saveData",data:r},[r]);break}case"load":{if(!N)break;const r=e.buffer,E=new DataView(r),M=new Uint8Array(r);if(M[0]!==83||M[1]!==65||M[2]!==78||M[3]!==68)break;let i;if(E.getUint16(4,!0)===N.cols){if(E.getUint16(6,!0)!==N.rows)break;i=8,N.rand=it(Date.now()),N.simStep=0}else{const u=M[4];if(u===1){const c=E.getUint16(5,!0),o=E.getUint16(7,!0);if(c!==N.cols||o!==N.rows)break;i=9,N.rand=it(Date.now()),N.simStep=0}else if(u===2){const c=E.getUint16(5,!0),o=E.getUint16(7,!0);if(c!==N.cols||o!==N.rows)break;const f=E.getInt32(9,!0);N.rand.setState(f),N.simStep=0,i=13}else if(u===3){const c=E.getUint16(5,!0),o=E.getUint16(7,!0);if(c!==N.cols||o!==N.rows)break;const f=E.getInt32(9,!0);N.rand.setState(f),N.simStep=E.getUint32(13,!0),i=17}else break}N.grid.set(M.subarray(i,i+N.cols*N.rows)),N.chunkMap.wakeAll(),K&&K.fill($);break}}}})();
