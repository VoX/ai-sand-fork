(function(){"use strict";const X={sand:1,water:2,dirt:3,stone:4,plant:5,fire:6,gas:7,fluff:8,bug:9,plasma:10,nitro:11,glass:12,lightning:13,slime:14,ant:15,alien:16,quark:17,crystal:18,ember:19,static:20,bird:21,gunpowder:22,tap:23,anthill:24,bee:25,flower:26,hive:27,honey:28,nest:29,gun:30,cloud:40,acid:41,lava:42,snow:43,volcano:44,mold:45,mercury:46,void:47,seed:48,rust:49,spore:50,algae:51,poison:52,dust:53,firework:54,bubble:55,glitter:56,star:57,comet:58,blackhole:60,firefly:61},_=4;function D(n,t,o){t/=100,o/=100;const s=t*Math.min(o,1-o),u=U=>{const l=(U+n/30)%12;return o-s*Math.max(Math.min(l-3,9-l,1),-1)};return 255<<24|Math.round(u(4)*255)<<16|Math.round(u(8)*255)<<8|Math.round(u(0)*255)}const j=new Uint32Array([4279900698,4285450470,4292448330,4281031307,4284900966,4280453922,0,4287137928,4292077301,4290013695,0,4279566137,4293580968,0,4281519514,4279904875,4278255360,4294902015,4294955136,4280303871,4294967108,4293454056,4281348144,4290822336,4281368752,4278245631,4294919372,4282431720,4281377023,4286611616,4283453520,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282703359,4292399304,4278255551,4279506140,4294963424,4278190182,4293814395,4291346616,4283697198,4285834708,4279124407,4289376800,4282216485,4287299723,4287084766,4278216447,4293643911,4290822336,4278247423,4294965629,4294938654,4278190080,4278255551]),m=new Uint32Array(32),p=new Uint32Array(64),v=new Uint32Array(32),w=new Uint32Array(32);for(let n=0;n<32;n++)m[n]=D(10+n,100,50+n/32*20),v[n]=D(50+n/32*20,100,80+n/32*20),w[n]=D(200+n/32*20,100,50+n/32*30);for(let n=0;n<64;n++)p[n]=D(n<32?280+n:320+(n-32),100,60+n/64*25);const Z=4279900698;let y=null,F=null,W=null,B=new Uint8Array(0),L=0,Y=0,V=!1,C=[];function K(n,t){L=Math.floor(n/_),Y=Math.floor(t/_),B=new Uint8Array(L*Y),F&&(W=F.createImageData(n,t))}function z(n,t,o,s){const u=o==="erase"?0:X[o];if(u===30){if(n>=0&&n<L&&t>=0&&t<Y){const U=t*L+n;B[U]!==4&&B[U]!==23&&B[U]!==30&&B[U]!==60&&(B[U]=30)}return}for(let U=-s;U<=s;U++)for(let l=-s;l<=s;l++)if(l*l+U*U<=s*s){const M=n+l,I=t+U;if(M>=0&&M<L&&I>=0&&I<Y){const R=I*L+M;let a=.3;u===21||u===25||u===61?a=.8:u===15||u===9||u===14?a=.7:u===16||u===17?a=.92:(u===45||u===50)&&(a=.6),(o==="erase"||Math.random()>a)&&(o==="erase"||B[R]!==4&&B[R]!==23&&B[R]!==60)&&(B[R]=u)}}}function J(){const n=B,t=Math.random,o=(s,u)=>u*L+s;for(let s=0;s<Y;s++){const u=t()<.5;for(let U=0;U<L;U++){const l=u?U:L-1-U,M=o(l,s),I=n[M];if(I!==0){if(I>=31&&I<=38){const R=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],a=I-31,[E,i]=R[a];if(i>0||E!==0&&E>0===u)continue;const e=l+E,f=s+i;if(e<0||e>=L||f<0||f>=Y){n[M]=39;continue}const T=o(e,f),c=n[T];if(c===22||c===11){n[T]=6,n[M]=39;continue}if(c===9||c===15||c===21||c===25||c===14){n[T]=I,n[M]=39;continue}if(c===2){if(t()<.15)n[M]=39;else{if(t()<.5)continue;n[T]=I,n[M]=39}continue}if(c===30){const r=e+E,A=f+i;if(r>=0&&r<L&&A>=0&&A<Y){const P=o(r,A);n[P]===0&&(n[P]=I)}n[M]=39;continue}if(c===46){const r=[35,36,37,38,31,32,33,34];n[M]=r[I-31];continue}if(c===5||c===26||c===12||c===8||c===7||c>=31&&c<=38||c===39){n[T]=I,n[M]=39;continue}if(c===4||c===3||c===1){t()<.2||(n[T]=I),n[M]=39;continue}if(c===0){n[T]=I,n[M]=39;continue}n[M]=39;continue}if(I===6||I===59){if(s===0){n[M]=0;continue}if(t()<.1){n[M]=t()<.25?7:t()<.15?19:0;continue}for(let a=0;a<3;a++){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1;if(E===0&&i===0)continue;const e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];(c===5||c===8||c===9||c===7||c===22||c===26||c===27||c===29)&&t()<.5&&(n[T]=6)}}const R=o(l,s-1);if(s>0&&n[R]===0)n[R]=I,n[M]=0;else{const a=t()<.5?-1:1;s>0&&l+a>=0&&l+a<L&&n[o(l+a,s-1)]===0&&(n[o(l+a,s-1)]=I,n[M]=0)}}else if(I===7){if(s===0){n[M]=0;continue}if(t()<.02){n[M]=0;continue}const R=o(l,s-1);if(s>0&&n[R]===0)n[R]=7,n[M]=0;else{const a=t()<.5?-1:1;s>0&&l+a>=0&&l+a<L&&n[o(l+a,s-1)]===0?(n[o(l+a,s-1)]=7,n[M]=0):l+a>=0&&l+a<L&&n[o(l+a,s)]===0&&(n[o(l+a,s)]=7,n[M]=0)}}else if(I===50){if(t()<.01){n[M]=0;continue}for(let R=0;R<3;R++){const a=Math.floor(t()*3)-1,E=Math.floor(t()*3)-1;if(a===0&&E===0)continue;const i=l+a,e=s+E;if(i>=0&&i<L&&e>=0&&e<Y){const f=n[o(i,e)];if((f===5||f===26||f===8||f===28||f===3||f===51)&&t()<.35){n[o(i,e)]=45,n[M]=0;break}}}if(t()<.4){const R=Math.floor(t()*3)-1,a=t()<.6?-1:t()<.5?0:1,E=l+R,i=s+a;E>=0&&E<L&&i>=0&&i<Y&&n[o(E,i)]===0&&(n[o(E,i)]=50,n[M]=0)}}else if(I===40){if(s<Y-1&&n[o(l,s+1)]===0&&t()<.04&&(n[o(l,s+1)]=2),t()<.3){const R=t()<.5?-1:1,a=t()<.3?-1:t()<.5?1:0,E=l+R,i=s+a;E>=0&&E<L&&i>=0&&i<Y&&n[o(E,i)]===0&&(n[o(E,i)]=40,n[M]=0)}}else if(I===54)if(s>0&&t()<.95){const R=o(l,s-1);if(n[R]===0)n[R]=54,n[M]=0;else{n[M]=0;const a=8,E=[6,19,20,10,56,59];for(let i=-a;i<=a;i++)for(let e=-a;e<=a;e++)if(e*e+i*i<=a*a&&t()<.5){const f=l+e,T=s+i;f>=0&&f<L&&T>=0&&T<Y&&n[o(f,T)]===0&&(n[o(f,T)]=E[Math.floor(t()*E.length)])}}}else{n[M]=0;const R=7,a=[6,19,20,10,56,59];for(let E=-R;E<=R;E++)for(let i=-R;i<=R;i++)if(i*i+E*E<=R*R&&t()<.45){const e=l+i,f=s+E;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=a[Math.floor(t()*a.length)])}}else if(I===55){let R=!1;for(let a=0;a<3;a++){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1,e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=n[o(e,f)];if(T===2||T===41||T===28||T===52){R=!0;break}}}if(R){if(s>0&&t()<.6){const a=o(l,s-1),E=n[a];if(E===2||E===41||E===28||E===52)n[a]=55,n[M]=E;else if(E===0){n[M]=0;for(let i=0;i<3;i++){const e=l+Math.floor(t()*3)-1,f=s-1-Math.floor(t()*2);e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=2)}}}if(t()<.2){const a=t()<.5?-1:1;if(l+a>=0&&l+a<L){const E=o(l+a,s),i=n[E];(i===2||i===41||i===28||i===52)&&(n[E]=55,n[M]=i)}}}else n[M]=7}else if(I===58){const R=t()<.8?-2:-1,a=Math.floor(t()*3)-1;let E=!1;for(let i=Math.abs(R);i>0;i--){const e=s-i,f=l+(i===Math.abs(R)?a:0);if(e>=0&&e<Y&&f>=0&&f<L){const T=o(f,e),c=n[T];if(c===0){n[T]=58,n[M]=59,E=!0;break}else if(c===2){n[T]=7,n[M]=59,E=!0;break}else if(c===5||c===8||c===26){n[T]=59,n[M]=59,E=!0;break}else if(c===1){n[T]=12,n[M]=59,E=!0;break}else{n[M]=0;for(let r=-2;r<=2;r++)for(let A=-2;A<=2;A++){const P=l+A,N=s+r;P>=0&&P<L&&N>=0&&N<Y&&n[o(P,N)]===0&&(n[o(P,N)]=t()<.6?59:19)}E=!0;break}}}(!E||t()<.05)&&(n[M]=59)}else if(I===10){if(s===0){n[M]=0;continue}if(t()<.08){n[M]=0;continue}for(let a=0;a<3;a++){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1;if(E===0&&i===0)continue;const e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=n[o(e,f)];T===1&&t()<.5?n[o(e,f)]=10:(T===5||T===8||T===7||T===26)&&t()<.5&&(n[o(e,f)]=6)}}const R=o(l,s-1);if(s>0&&n[R]===0)n[R]=10,n[M]=0;else{const a=t()<.5?-1:1;s>0&&l+a>=0&&l+a<L&&n[o(l+a,s-1)]===0&&(n[o(l+a,s-1)]=10,n[M]=0)}}else if(I===13){if(t()<.2){n[M]=t()<.2?20:0;continue}let R=!1;for(let a=1;a<=3&&!R;a++){const E=s+a;if(E>=Y)break;const i=o(l,E),e=n[i];if(e===1){n[i]=12,n[M]=0,R=!0;for(let f=0;f<3;f++){let T=l,c=E,r=t()<.5?-1:1;for(let A=0;A<8&&(t()<.3&&(r=t()<.5?-1:1),T+=r,c+=t()<.8?1:0,!(T<0||T>=L||c>=Y));A++){const P=o(T,c);if(n[P]===1)n[P]=12;else if(n[P]!==0&&n[P]!==12)break}}}else if(e===2){n[i]=13,n[M]=0,R=!0;for(let f=-3;f<=3;f++){const T=l+f;T>=0&&T<L&&n[o(T,E)]===2&&t()<.7&&(n[o(T,E)]=13)}}else if(e===5||e===8||e===9)n[i]=6,n[M]=0,R=!0;else if(e===11){n[M]=0;const f=15;for(let T=-f;T<=f;T++)for(let c=-f;c<=f;c++)if(c*c+T*T<=f*f){const r=l+c,A=E+T;if(r>=0&&r<L&&A>=0&&A<Y){const P=o(r,A),N=n[P];N===2?n[P]=t()<.7?4:0:N!==4&&N!==12&&(n[P]=6)}}R=!0}else if(e===4||e===12)n[M]=0,R=!0;else if(e===3)t()<.4&&(n[i]=12),n[M]=0,R=!0;else{if(e===0)continue;n[M]=0,R=!0}}if(!R&&s+1<Y&&n[o(l,s+1)]===0){if(n[o(l,s+1)]=13,n[M]=0,t()<.15){const a=l+(t()<.5?-1:1);a>=0&&a<L&&n[o(a,s)]===0&&(n[o(a,s)]=13)}}else R||(n[M]=0)}else if(I===21){let R=!1;for(let c=0;c<2;c++){const r=Math.floor(t()*3)-1,A=Math.floor(t()*3)-1;if(r===0&&A===0)continue;const P=l+r,N=s+A;if(P>=0&&P<L&&N>=0&&N<Y){const S=n[o(P,N)];if(S===6||S===10||S===13||S===19){n[M]=6;for(let x=0;x<4;x++){const h=l+Math.floor(t()*3)-1,d=s+Math.floor(t()*3)-1;h>=0&&h<L&&d>=0&&d<Y&&n[o(h,d)]===0&&t()<.5&&(n[o(h,d)]=6)}R=!0;break}if(S===16||S===17){n[M]=0,R=!0;break}}}if(R)continue;if(t()<.003){n[M]=8;continue}if(t()<.4)continue;const a=t(),E=t();let i=0,e=0;if(a<.5?(e=-1,i=E<.35?-1:E<.7?1:0):a<.75?(i=E<.5?-2:2,e=E<.4?-1:0):a<.9&&(e=1,i=E<.5?-1:1),i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=o(f,T),r=n[c];r===15||r===9||r===25?(n[c]=21,n[M]=t()<.6?21:5):(r===0||r===8)&&(n[c]=21,n[M]=0)}}else if(I===25){let R=!1;for(let c=0;c<2;c++){const r=Math.floor(t()*3)-1,A=Math.floor(t()*3)-1;if(r===0&&A===0)continue;const P=l+r,N=s+A;if(P>=0&&P<L&&N>=0&&N<Y){const S=n[o(P,N)];if(S===6||S===10||S===13||S===19){n[M]=6,R=!0;break}}}if(R)continue;const a=t(),E=t();let i=0,e=0;if(a<.3?(e=-1,i=E<.4?-1:E<.8?1:0):a<.5?(e=1,i=E<.4?-1:E<.8?1:0):a<.8&&(i=E<.5?-1:1,e=E<.3?-1:E<.6?1:0),i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=o(f,T),r=n[c];if(r===5){if(t()<.08)for(let A=-1;A<=1;A++)for(let P=-1;P<=1;P++){if(A===0&&P===0)continue;const N=f+P,S=T+A;if(N>=0&&N<L&&S>=0&&S<Y&&n[o(N,S)]===0){n[o(N,S)]=26;break}}}else r===0?(n[c]=25,n[M]=0):r===26&&(n[c]=25,n[M]=t()<.1?28:t()<.15?0:26)}}else if(I===61){let R=!1;for(let T=0;T<2;T++){const c=Math.floor(t()*3)-1,r=Math.floor(t()*3)-1;if(c===0&&r===0)continue;const A=l+c,P=s+r;if(A>=0&&A<L&&P>=0&&P<Y){const N=n[o(A,P)];if(N===6||N===10||N===42){n[M]=6,R=!0;break}if(N===2||N===41){n[M]=0,R=!0;break}if(N===21){n[M]=0,R=!0;break}}}if(R)continue;if(t()<.15){const T=Math.floor(t()*3)-1,c=Math.floor(t()*3)-1,r=l+T,A=s+c;r>=0&&r<L&&A>=0&&A<Y&&n[o(r,A)]===0&&(n[o(r,A)]=t()<.7?56:20)}if(t()<.5)continue;let a={x:0,y:0};for(let T=0;T<3;T++){const c=Math.floor(t()*9)-4,r=Math.floor(t()*9)-4,A=l+c,P=s+r;if(A>=0&&A<L&&P>=0&&P<Y&&n[o(A,P)]===26){a={x:Math.sign(c),y:Math.sign(r)};break}}let E=0,i=0;if(a.x!==0||a.y!==0)E=a.x,i=a.y;else{const T=t();T<.25?(i=-1,E=t()<.5?-1:1):T<.4?(i=1,E=t()<.5?-1:1):T<.7&&(E=t()<.5?-1:1)}if(E===0&&i===0)continue;const e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];if(c===0)n[T]=61,n[M]=0;else if(c===26&&t()<.03){const r=l+Math.floor(t()*3)-1,A=s+Math.floor(t()*3)-1;r>=0&&r<L&&A>=0&&A<Y&&n[o(r,A)]===0&&(n[o(r,A)]=61)}}}}}}for(let s=Y-2;s>=0;s--){const u=t()<.5;for(let U=0;U<L;U++){const l=u?U:L-1-U,M=o(l,s),I=n[M];if(I===0)continue;const R=o(l,s+1),a=n[R];if(I===35||I===34||I===36){const E=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],i=I-31,[e,f]=E[i];if(e!==0&&e>0===u)continue;const T=l+e,c=s+f;if(T<0||T>=L||c<0||c>=Y){n[M]=39;continue}const r=o(T,c),A=n[r];if(A===22||A===11){n[r]=6,n[M]=39;continue}if(A===9||A===15||A===21||A===25||A===14){n[r]=I,n[M]=39;continue}if(A===2){if(t()<.15)n[M]=39;else{if(t()<.5)continue;n[r]=I,n[M]=39}continue}if(A===30){const P=T+e,N=c+f;P>=0&&P<L&&N>=0&&N<Y&&n[o(P,N)]===0&&(n[o(P,N)]=I),n[M]=39;continue}if(A===46){const P=[35,36,37,38,31,32,33,34];n[M]=P[I-31];continue}if(A===5||A===26||A===12||A===8||A===7||A>=31&&A<=38||A===39){n[r]=I,n[M]=39;continue}if(A===4||A===3||A===1){t()<.2||(n[r]=I),n[M]=39;continue}if(A===0){n[r]=I,n[M]=39;continue}n[M]=39;continue}if(I===39){t()<.3&&(n[M]=0);continue}if(I===23){s<Y-1&&n[R]===0&&t()<.15&&(n[R]=2);continue}if(I===24){if(t()<.06){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1,e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=15)}continue}if(I===27){if(t()<.035){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1,e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=25)}continue}if(I===29){if(t()<.02){const E=Math.floor(t()*3)-1,i=-1,e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=21)}continue}if(I===30){if(t()<.08){const E=[31,32,33,34,35,36,37,38],i=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],e=Math.floor(t()*8);for(let f=0;f<8;f++){const T=(e+f)%8,[c,r]=i[T],A=l+c,P=s+r;if(A>=0&&A<L&&P>=0&&P<Y&&n[o(A,P)]===0){n[o(A,P)]=E[T];break}}}continue}if(I===1)if(a===0)n[R]=1,n[M]=0;else if(a===2||a===41)n[R]=1,n[M]=a;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=1,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0&&(n[o(e,s+1)]=1,n[M]=0)}else if(I===2)if(a===0)n[R]=2,n[M]=0;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=2,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=2,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0?(n[o(i,s)]=2,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0&&(n[o(e,s)]=2,n[M]=0)}else if(I===3)a===0?(n[R]=3,n[M]=0):a===2&&(n[R]=3,n[M]=2);else if(I===8){if(t()<.3&&a===0)n[R]=8,n[M]=0;else if(t()<.15){const E=t()<.5?-1:1;l+E>=0&&l+E<L&&n[o(l+E,s+1)]===0&&(n[o(l+E,s+1)]=8,n[M]=0)}}else if(I===9){for(let T=0;T<2;T++){const c=Math.floor(t()*3)-1,r=Math.floor(t()*3)-1;if(c===0&&r===0)continue;const A=l+c,P=s+r;if(A>=0&&A<L&&P>=0&&P<Y){const N=n[o(A,P)];if(N===6||N===10||N===13||N===19){n[M]=6;break}}}if(n[M]!==9||t()<.5)continue;const E=Math.floor(t()*3)-1,i=t()<.7?1:Math.floor(t()*3)-1;if(E===0&&i===0)continue;const e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];c===5?(n[T]=9,n[M]=t()<.3?0:3):c===0?(n[T]=9,n[M]=0):c===2&&(n[T]=9,n[M]=2)}}else if(I===11){let E=!1;for(let i=0;i<3;i++){const e=Math.floor(t()*3)-1,f=Math.floor(t()*3)-1;if(e===0&&f===0)continue;const T=l+e,c=s+f;if(T>=0&&T<L&&c>=0&&c<Y){const r=n[o(T,c)];if(r===6||r===10||r===19||r===42||r===13||r===59||r===22){for(let P=-12;P<=12;P++)for(let N=-12;N<=12;N++)if(N*N+P*P<=144){const S=l+N,x=s+P;if(S>=0&&S<L&&x>=0&&x<Y){const h=o(S,x),d=n[h];d===2?n[h]=t()<.7?4:0:d!==4&&d!==12&&(n[h]=6)}}E=!0;break}}}if(E||n[M]!==11)continue;if(a===0)n[R]=11,n[M]=0;else if(a===2)n[R]=11,n[M]=2;else{const i=t()<.5?-1:1,e=l+i,f=l-i;e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=11,n[M]=0):f>=0&&f<L&&n[o(f,s+1)]===0?(n[o(f,s+1)]=11,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0?(n[o(e,s)]=11,n[M]=0):f>=0&&f<L&&n[o(f,s)]===0&&(n[o(f,s)]=11,n[M]=0)}}else if(I===14){for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];if(c===6||c===10||c===19||c===42){n[M]=7;break}}}if(n[M]!==14||t()<.6)continue;if(a===0)n[R]=14,n[M]=0;else{const E=t()<.5?-1:1,i=l+E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=14,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0&&t()<.3&&(n[o(i,s)]=14,n[M]=0)}}else if(I===15){let E=!1;for(let c=0;c<2;c++){const r=Math.floor(t()*3)-1,A=Math.floor(t()*3)-1;if(r===0&&A===0)continue;const P=l+r,N=s+A;if(P>=0&&P<L&&N>=0&&N<Y){const S=n[o(P,N)];if(S===6||S===10||S===13||S===19||S===42){n[M]=6,E=!0;break}if(S===2||S===41){n[M]=0,E=!0;break}}}if(E||t()<.5)continue;const i=Math.floor(t()*3)-1,e=t()<.6?1:Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=o(f,T),r=n[c];r===3||r===1||r===0?(n[c]=15,n[M]=0):(r===5||r===26)&&(n[c]=15,n[M]=t()<.5?0:3)}}else if(I===16){if(t()<.5)continue;let E=0,i=0,e=0;for(let A=0;A<4;A++){const P=Math.floor(t()*7)-3,N=Math.floor(t()*7)-3,S=l+P,x=s+N;S>=0&&S<L&&x>=0&&x<Y&&n[o(S,x)]===16&&(E++,i+=P,e+=N)}let f,T;if(E>0){const A=-Math.sign(e),P=Math.sign(i);if(f=A+Math.floor(t()*3)-1,T=P+Math.floor(t()*3)-1,t()<.15){const N=l+Math.floor(t()*3)-1,S=s+Math.floor(t()*3)-1;N>=0&&N<L&&S>=0&&S<Y&&n[o(N,S)]===0&&(n[o(N,S)]=20)}}else f=Math.floor(t()*5)-2,T=Math.floor(t()*5)-2;if(f===0&&T===0)continue;const c=l+f,r=s+T;if(c>=0&&c<L&&r>=0&&r<Y){const A=o(c,r),P=n[A];if(P===0)n[A]=16,n[M]=0;else if(P===16){if(t()<.1)for(let N=0;N<3;N++){const S=l+Math.floor(t()*5)-2,x=s+Math.floor(t()*5)-2;S>=0&&S<L&&x>=0&&x<Y&&n[o(S,x)]===0&&(n[o(S,x)]=t()<.7?20:17)}}else P===9||P===15||P===21||P===25||P===14?(n[A]=16,n[M]=t()<.6?16:20):P===5||P===26?(n[A]=16,n[M]=20):(P===6||P===10||P===13)&&(n[M]=17)}}else if(I===17){if(t()<.03){n[M]=t()<.33?18:t()<.5?19:20;continue}const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1;if(E===0&&i===0)continue;const e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=17,n[M]=0)}else if(I===18)t()<.002&&(n[M]=1);else if(I===19){if(t()<.05){n[M]=t()<.3?6:0;continue}for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];(c===5||c===8||c===7||c===26)&&t()<.4&&(n[o(f,T)]=6)}}if(a===0)n[R]=19,n[M]=0;else{const E=t()<.5?-1:1;l+E>=0&&l+E<L&&n[o(l+E,s+1)]===0&&(n[o(l+E,s+1)]=19,n[M]=0)}}else if(I===20){if(t()<.08){n[M]=0;continue}const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1;if(E!==0||i!==0){const e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=20,n[M]=0)}}else if(I===22){for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];if(c===6||c===10||c===19||c===42){for(let A=-6;A<=6;A++)for(let P=-6;P<=6;P++)if(P*P+A*A<=36){const N=l+P,S=s+A;if(N>=0&&N<L&&S>=0&&S<Y){const x=o(N,S),h=n[x];h!==4&&h!==12&&h!==2&&(n[x]=6)}}break}}}if(n[M]!==22)continue;if(a===0)n[R]=22,n[M]=0;else if(a===2)n[R]=22,n[M]=2;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=22,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0&&(n[o(e,s+1)]=22,n[M]=0)}}else if(I===28){if(t()>.15)continue;if(a===0)n[R]=28,n[M]=0;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=28,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=28,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0&&t()<.3?(n[o(i,s)]=28,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0&&t()<.3&&(n[o(e,s)]=28,n[M]=0)}}else if(I===41){let E=!1;for(let i=0;i<3;i++){const e=Math.floor(t()*3)-1,f=Math.floor(t()*3)-1;if(e===0&&f===0)continue;const T=l+e,c=s+f;if(T>=0&&T<L&&c>=0&&c<Y){const r=o(T,c),A=n[r];if((A===5||A===3||A===1||A===8||A===26||A===14)&&t()<.3){n[r]=t()<.7?0:7,t()<.4&&(n[M]=0,E=!0);break}if((A===4||A===12||A===18)&&t()<.08){n[r]=0,n[M]=0,E=!0;break}if((A===9||A===15||A===21||A===25)&&t()<.5){n[r]=41;break}}}if(E)continue;if(a===0)n[R]=41,n[M]=0;else{const i=t()<.5?-1:1,e=l+i,f=l-i;e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=41,n[M]=0):f>=0&&f<L&&n[o(f,s+1)]===0?(n[o(f,s+1)]=41,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0?(n[o(e,s)]=41,n[M]=0):f>=0&&f<L&&n[o(f,s)]===0&&(n[o(f,s)]=41,n[M]=0)}}else if(I===42){for(let E=0;E<3;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=o(f,T),r=n[c];if(r===2){if(n[c]=t()<.5?4:7,t()<.15){n[M]=4;break}}else r===43?n[c]=2:r===1&&t()<.4?n[c]=12:((r===5||r===8||r===7||r===26||r===22||r===27||r===29)&&t()<.7||(r===9||r===15||r===21||r===25)&&t()<.8)&&(n[c]=6)}}if(t()<.001){n[M]=4;continue}if(t()>.15)continue;if(a===0)n[R]=42,n[M]=0;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=42,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=42,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0&&t()<.3?(n[o(i,s)]=42,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0&&t()<.3&&(n[o(e,s)]=42,n[M]=0)}}else if(I===43){let E=!1;if(t()<.4)for(let i=-1;i<=1&&!E;i++)for(let e=-1;e<=1&&!E;e++){if(i===0&&e===0)continue;const f=l+e,T=s+i;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];(c===6||c===10||c===19||c===42)&&t()<.6?(n[M]=2,E=!0):c===2&&t()<.04&&(n[o(f,T)]=12)}}if(E)continue;if(t()<.25&&a===0)n[R]=43,n[M]=0;else if(t()<.1){const i=t()<.5?-1:1;l+i>=0&&l+i<L&&n[o(l+i,s+1)]===0&&(n[o(l+i,s+1)]=43,n[M]=0)}}else if(I===44){for(let E=0;E<3;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];if(c===2){if(n[o(f,T)]=7,t()<.08){n[M]=4;continue}}else c===43&&(n[o(f,T)]=2)}}if(n[M]===4)continue;if(t()<.55&&s>0){const E=o(l,s-1);n[E]===0&&(n[E]=42)}if(t()<.25){const E=t()<.5?-1:1;if(l+E>=0&&l+E<L&&s>0){const i=o(l+E,s-1);n[i]===0&&(n[i]=42)}}if(t()<.1){const E=Math.floor(t()*3)-1,i=Math.floor(t()*2)-1,e=l+E,f=s+i;e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=19)}}else if(I===45){if(t()<.008){n[M]=0;continue}for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];if(c===6||c===10||c===42||c===41){n[M]=c===41?0:6;break}}}if(n[M]===6||n[M]===0)continue;if(t()<.08){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1,e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];c===5||c===26||c===8||c===28||c===3?(n[T]=45,t()<.2&&(n[M]=t()<.4?50:7)):(c===9||c===15||c===14)&&t()<.3?n[T]=45:c===0&&t()<.1&&(n[T]=45,n[M]=t()<.3?7:0)}}}else if(I===46){for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];(c===9||c===15||c===21||c===25||c===14)&&t()<.5&&(n[o(f,T)]=0)}}if(a===0)n[R]=46,n[M]=0;else if(a===2||a===41||a===28||a===1||a===3)t()<.7&&(n[R]=46,n[M]=a);else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=46,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=46,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0?(n[o(i,s)]=46,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0&&(n[o(e,s)]=46,n[M]=0)}}else if(I===47){if(t()<.003){n[M]=0;continue}for(let E=0;E<2;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y&&n[o(f,T)]===13){n[M]=20;break}}if(n[M]===20)continue;if(t()<.1){const E=Math.floor(t()*3)-1,i=Math.floor(t()*3)-1,e=l+E,f=s+i;if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];if(c!==0&&c!==4&&c!==12&&c!==18&&c!==47&&c!==23&&c!==44&&(n[T]=0,t()<.02)){const r=l+Math.floor(t()*3)-1,A=s+Math.floor(t()*3)-1;r>=0&&r<L&&A>=0&&A<Y&&n[o(r,A)]===0&&(n[o(r,A)]=47)}}}}else if(I===48){if(a===0){n[R]=48,n[M]=0;continue}else if(a===2&&t()<.5){n[R]=48,n[M]=2;continue}const E=Math.floor(t()*8),i=[0,1,1,1,0,-1,-1,-1][E],e=[-1,-1,0,1,1,1,0,-1][E],f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const d=n[o(f,T)];if(d===6||d===10||d===42){n[M]=6;continue}if((d===9||d===15||d===21)&&t()<.3){n[M]=0;continue}}if(t()>.35)continue;const c=s>0?n[o(l,s-1)]:0;if(!(s<Y-1&&(n[R]===3||n[R]===2)||c===3||c===2||c===5))continue;let A=!1,P=!1;for(let d=0;d<6;d++){const O=Math.floor(t()*13)-6,nn=Math.floor(t()*13)-6,H=l+O,k=s+nn;if(H>=0&&H<L&&k>=0&&k<Y){const Q=n[o(H,k)];Q===2&&(A=!0),Q===57&&(P=!0)}}const N=P?.7:A?.5:.25;if(t()>N)continue;const S=P?50:A?30:20;let x=-1;for(let d=1;d<=S&&!(s-d<0);d++){const O=n[o(l,s-d)];if(O===0){x=s-d;break}if(O!==5&&O!==26&&O!==2&&O!==3&&O!==48)break}if(x>=0){const d=P?.3:A?.15:.1;n[o(l,x)]=t()<d?26:5}const h=s-(x>=0?x:s);if(h>10&&t()<(P?.2:.1)){const d=l+(t()<.5?-1:1),O=s-Math.floor(t()*Math.min(h,15))-5;d>=0&&d<L&&O>=0&&n[o(d,O)]===0&&(n[o(d,O)]=t()<.4?26:5)}}else if(I===49){if(t()<.005){n[M]=3;continue}let E=!1;for(let i=0;i<2;i++){const e=Math.floor(t()*3)-1,f=Math.floor(t()*3)-1,T=l+e,c=s+f;if(T>=0&&T<L&&c>=0&&c<Y&&n[o(T,c)]===2){E=!0;break}}if(E&&t()<.03){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1,f=l+i,T=s+e;f>=0&&f<L&&T>=0&&T<Y&&n[o(f,T)]===4&&(n[o(f,T)]=49)}a===0&&t()<.1&&(n[R]=49,n[M]=0)}else if(I===51){let E=!1;if((s>0&&n[o(l,s-1)]===2||s<Y-1&&n[o(l,s+1)]===2||l>0&&n[o(l-1,s)]===2||l<L-1&&n[o(l+1,s)]===2)&&(E=!0),!E&&t()<.008){n[M]=5;continue}if(E&&t()<.01&&s>0){const i=o(l,s-1);n[i]===2&&(n[i]=7)}if(E&&t()<.02){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1,f=l+i,T=s+e;f>=0&&f<L&&T>=0&&T<Y&&n[o(f,T)]===2&&(n[o(f,T)]=51)}for(let i=0;i<2;i++){const e=Math.floor(t()*3)-1,f=Math.floor(t()*3)-1;if(e===0&&f===0)continue;const T=l+e,c=s+f;if(T>=0&&T<L&&c>=0&&c<Y){const r=n[o(T,c)];if((r===9||r===14)&&t()<.25){n[M]=0;break}}}}else if(I===52){for(let E=0;E<3;E++){const i=Math.floor(t()*3)-1,e=Math.floor(t()*3)-1;if(i===0&&e===0)continue;const f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=n[o(f,T)];(c===9||c===15||c===21||c===25||c===14)&&t()<.5||c===51&&t()<.08||c===5&&t()<.05?n[o(f,T)]=52:c===2&&t()<.15&&(n[o(f,T)]=0,t()<.5&&(n[M]=2))}}if(t()>.3)continue;if(a===0)n[R]=52,n[M]=0;else{const E=t()<.5?-1:1,i=l+E,e=l-E;i>=0&&i<L&&n[o(i,s+1)]===0?(n[o(i,s+1)]=52,n[M]=0):e>=0&&e<L&&n[o(e,s+1)]===0?(n[o(e,s+1)]=52,n[M]=0):i>=0&&i<L&&n[o(i,s)]===0?(n[o(i,s)]=52,n[M]=0):e>=0&&e<L&&n[o(e,s)]===0&&(n[o(e,s)]=52,n[M]=0)}}else if(I===53){let E=!1;for(let i=0;i<2;i++){const e=Math.floor(t()*3)-1,f=Math.floor(t()*3)-1;if(e===0&&f===0)continue;const T=l+e,c=s+f;if(T>=0&&T<L&&c>=0&&c<Y){const r=n[o(T,c)];if(r===6||r===10||r===19||r===42){n[M]=6;for(let A=0;A<10;A++){const P=Math.floor(t()*5)-2,N=Math.floor(t()*5)-2,S=l+P,x=s+N;S>=0&&S<L&&x>=0&&x<Y&&n[o(S,x)]===53&&t()<.8&&(n[o(S,x)]=6)}E=!0;break}}}if(E)continue;if(t()<.003){n[M]=1;continue}if(t()<.3){const i=Math.floor(t()*3)-1,e=t()<.6?1:t()<.5?0:-1,f=l+i,T=s+e;f>=0&&f<L&&T>=0&&T<Y&&n[o(f,T)]===0&&(n[o(f,T)]=53,n[M]=0)}}else if(I===56){let E=0;for(let e=0;e<3;e++){const f=Math.floor(t()*3)-1,T=Math.floor(t()*3)-1;if(f===0&&T===0)continue;const c=l+f,r=s+T;c>=0&&c<L&&r>=0&&r<Y&&n[o(c,r)]===56&&E++}const i=E===0?.15:E>0?.03:.01;if(t()<i){n[M]=0;continue}if(t()<.3)if(a===0)n[R]=56,n[M]=0;else{const e=t()<.5?-1:1;l+e>=0&&l+e<L&&n[o(l+e,s+1)]===0&&(n[o(l+e,s+1)]=56,n[M]=0)}}else if(I===57){if(t()<.12){const E=t()*6.28318,i=t()*4+1,e=l+Math.round(Math.cos(E)*i),f=s+Math.round(Math.sin(E)*i);e>=0&&e<L&&f>=0&&f<Y&&n[o(e,f)]===0&&(n[o(e,f)]=t()<.6?20:56)}if(t()<.04){const E=t()*6.28318,i=t()*12+3,e=l+Math.round(Math.cos(E)*i),f=s+Math.round(Math.sin(E)*i);if(e>=0&&e<L&&f>=0&&f<Y){const T=o(e,f),c=n[T];c===5&&t()<.3?n[T]=26:c===2&&t()<.1?n[T]=51:c===3&&t()<.15||c===0&&t()<.05?n[T]=5:c===43&&t()<.2?n[T]=2:c===45&&t()<.1&&(n[T]=26)}}if(t()<.02)for(let E=0;E<5;E++){const i=Math.floor(t()*5)-2,e=Math.floor(t()*5)-2,f=l+i,T=s+e;if(f>=0&&f<L&&T>=0&&T<Y){const c=o(f,T);n[c]===2&&(n[c]=7)}}}else if(I===60){if(t()>.5)continue;const E=10;for(let i=0;i<16;i++){const e=t()*6.28318,f=t()*E+1,T=Math.round(Math.cos(e)*f),c=Math.round(Math.sin(e)*f);if(T===0&&c===0)continue;const r=l+T,A=s+c;if(r<0||r>=L||A<0||A>=Y)continue;const P=o(r,A),N=n[P];if(N===0||N===60||N===44||N===30||N===24||N===27)continue;const S=T>0?-1:T<0?1:0,x=c>0?-1:c<0?1:0,h=r+S,d=A+x;if(h>=0&&h<L&&d>=0&&d<Y){const O=o(h,d);Math.abs(T+S)<=1&&Math.abs(c+x)<=1?n[P]=0:n[O]===0&&(n[O]=N,n[P]=0)}}for(let i=-6;i<=6;i+=2){const e=l+i;if(!(e<0||e>=L))for(let f=-8;f<=2;f+=2){const T=s+f;if(T<0||T>=Y)continue;const c=o(e,T),r=n[c];if(!(r===0||r===60)&&Math.abs(i)>1&&t()<.3){const A=i>0?-1:1,P=e+A;P>=0&&P<L&&n[o(P,T)]===0&&(n[o(P,T)]=r,n[c]=0)}}}}}}}function $(){if(!F||!W||!y)return;const n=B,t=y.width,o=new Uint32Array(W.data.buffer);o.fill(Z);const s=_;for(let u=0;u<Y;u++){const U=u*L,l=u*s*t;for(let M=0;M<L;M++){const I=n[U+M];if(I===0)continue;let R;I===6?R=m[M+u&31]:I===10?R=p[M+u&63]:I===13?R=v[M+u&31]:I===59?R=w[M+u&31]:R=j[I];const a=M*s,E=l+a,i=E+t,e=i+t,f=e+t;o[E]=o[E+1]=o[E+2]=o[E+3]=R,o[i]=o[i+1]=o[i+2]=o[i+3]=R,o[e]=o[e+1]=o[e+2]=o[e+3]=R,o[f]=o[f+1]=o[f+2]=o[f+3]=R}}F.putImageData(W,0,0)}let G=0,b=0;const g=1e3/60;function q(n){G===0&&(G=n);const t=Math.min(n-G,100);G=n;for(const o of C)z(o.x,o.y,o.tool,o.brushSize);C=[],V||(b+=t,b>=g&&(J(),b=Math.min(b-g,g))),$(),requestAnimationFrame(q)}self.onmessage=n=>{const{type:t,data:o}=n.data;switch(t){case"init":y=n.data.canvas,F=y.getContext("2d",{willReadFrequently:!1}),K(y.width,y.height),G=0,b=0,requestAnimationFrame(q);break;case"resize":y&&(y.width=o.width,y.height=o.height,K(o.width,o.height));break;case"input":C.push({x:o.cellX,y:o.cellY,tool:o.tool,brushSize:o.brushSize});break;case"pause":V=o.paused;break;case"reset":B.fill(0);break}}})();
