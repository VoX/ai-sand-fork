(function(){"use strict";const yt={sand:1,water:2,dirt:3,stone:4,plant:5,fire:6,gas:7,fluff:8,bug:9,plasma:10,nitro:11,glass:12,lightning:13,slime:14,ant:15,alien:16,quark:17,crystal:18,ember:19,static:20,bird:21,gunpowder:22,tap:23,anthill:24,bee:25,flower:26,hive:27,honey:28,nest:29,gun:30,cloud:40,acid:41,lava:42,snow:43,volcano:44,mold:45,mercury:46,void:47,seed:48,rust:49,spore:50,algae:51,poison:52,dust:53,firework:54,bubble:55,glitter:56,star:57,comet:58,blackhole:60,firefly:61,worm:62,fairy:63,fish:64,moth:65},kt=1600,Ht=1e3,St=4;function J(t,o,i){o/=100,i/=100;const T=o*Math.min(i,1-i),n=r=>{const f=(r+t/30)%12;return i-T*Math.max(Math.min(f-3,9-f,1),-1)};return 255<<24|Math.round(n(4)*255)<<16|Math.round(n(8)*255)<<8|Math.round(n(0)*255)}const F=new Uint32Array([4279900698,4285450470,4292448330,4281031307,4284900966,4280453922,0,4287137928,4292077301,4290013695,0,4279566137,4293580968,0,4281519514,4279904875,4278255360,4294902015,4294955136,4280303871,4294967108,4293454056,4281348144,4290822336,4281368752,4278245631,4294919372,4282431720,4281377023,4286611616,4283453520,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282712063,4282703359,4292399304,4278255551,4279506140,4294963424,4278190182,4293814395,4291346616,4283697198,4285834708,4279124407,4289376800,4282216485,4287299723,4287084766,4278216447,4293643911,4290822336,4278247423,4294965629,4294938654,4278190080,4278255551,4286615744,4294936831,4278232575,4287411410]),ht=new Uint32Array(32),Yt=new Uint32Array(64),Nt=new Uint32Array(32),Ot=new Uint32Array(32);for(let t=0;t<32;t++)ht[t]=J(10+t,100,50+t/32*20),Nt[t]=J(50+t/32*20,100,80+t/32*20),Ot[t]=J(200+t/32*20,100,50+t/32*30);for(let t=0;t<64;t++)Yt[t]=J(t<32?280+t:320+(t-32),100,60+t/64*25);const $=4279900698,Ut=1,Bt=2,Tt=4,vt=8,dt=16,Vt=32,pt=64,Kt=128,wt=256,Ft=512,qt=1024,jt=2048,Qt=4096,g=8192,tt=16384,st=32768,rt=65536,et=1<<17,it=1<<18,bt=1<<19,Xt=1<<20,zt=1<<21,Zt=1<<22,B=[];B[0]=null,B[1]={gravity:.95,density:5,color:F[1]},B[3]={gravity:.95,density:4,color:F[3]},B[22]={gravity:.95,density:4,explosive:[6,0],flammable:!0,color:F[22]},B[43]={gravity:.25,meltOnHeat:2,color:F[43]},B[49]={gravity:.1,volatile:[.005,3],infectiousHandler:!0,color:F[49]},B[8]={gravity:.3,flammable:!0,color:F[8]},B[53]={gravity:.3,flammable:!0,explosive:[2,0],volatile:[.003,1],color:F[53]},B[56]={gravity:.3,volatile:[.03,0],color:F[56]},B[2]={gravity:.95,liquid:.5,density:2,color:F[2]},B[28]={gravity:.15,liquid:.3,density:3,color:F[28]},B[11]={gravity:.95,liquid:.5,density:3,explosive:[12,1],color:F[11]},B[14]={gravity:.4,liquid:.3,density:2,meltOnHeat:7,color:F[14]},B[52]={gravity:.3,liquid:.5,density:2,killsCreatures:!0,corrosiveHandler:!0,color:F[52]},B[41]={gravity:.95,liquid:.5,density:3,killsCreatures:!0,corrosiveHandler:!0,color:F[41]},B[42]={gravity:.15,liquid:.3,density:6,heatSource:!0,corrosiveHandler:!0,color:F[42]},B[46]={gravity:1,liquid:.5,density:8,killsCreatures:!0,corrosiveHandler:!0,color:F[46]},B[6]={buoyancy:.5,volatile:[.1,0],heatSource:!0,color:F[6],palette:1},B[7]={buoyancy:1,volatile:[.02,0],flammable:!0,color:F[7]},B[10]={buoyancy:1,volatile:[.08,0],heatSource:!0,color:F[10],palette:2},B[59]={buoyancy:.5,volatile:[.08,0],heatSource:!0,color:F[59],palette:4},B[50]={buoyancy:.4,volatile:[.01,0],infectiousHandler:!0,color:F[50]},B[40]={buoyancy:.3,spawnerHandler:!0,color:F[40]},B[54]={buoyancy:.95,fireworkHandler:!0,color:F[54]},B[55]={buoyancy:.6,bubbleHandler:!0,color:F[55]},B[58]={buoyancy:1,heatSource:!0,cometHandler:!0,color:F[58]},B[13]={volatile:[.2,20],heatSource:!0,lightningHandler:!0,color:F[13],palette:3},B[19]={gravity:.5,volatile:[.05,0],heatSource:!0,color:F[19]},B[20]={randomWalk:.5,volatile:[.08,0],color:F[20]},B[17]={randomWalk:.5,volatile:[.03,18],color:F[17]},B[18]={immobile:!0,volatile:[2e-4,1],color:F[18]},B[4]={immobile:!0,color:F[4]},B[12]={immobile:!0,color:F[12]},B[26]={immobile:!0,flammable:!0,color:F[26]},B[23]={immobile:!0,spawnerHandler:!0,color:F[23]},B[24]={immobile:!0,spawnerHandler:!0,color:F[24]},B[27]={immobile:!0,flammable:!0,spawnerHandler:!0,color:F[27]},B[29]={immobile:!0,flammable:!0,spawnerHandler:!0,color:F[29]},B[30]={immobile:!0,spawnerHandler:!0,color:F[30]},B[44]={immobile:!0,spawnerHandler:!0,color:F[44]},B[57]={immobile:!0,spawnerHandler:!0,color:F[57]},B[60]={immobile:!0,spawnerHandler:!0,color:F[60]},B[9]={living:!0,creatureHandler:!0,color:F[9]},B[15]={living:!0,creatureHandler:!0,color:F[15]},B[21]={living:!0,creatureHandler:!0,color:F[21]},B[25]={living:!0,creatureHandler:!0,color:F[25]},B[61]={living:!0,creatureHandler:!0,color:F[61]},B[16]={living:!0,creatureHandler:!0,color:F[16]},B[62]={living:!0,creatureHandler:!0,color:F[62]},B[63]={living:!0,creatureHandler:!0,color:F[63]},B[64]={living:!0,creatureHandler:!0,color:F[64]},B[65]={living:!0,creatureHandler:!0,color:F[65]},B[5]={immobile:!0,flammable:!0,growthHandler:!0,color:F[5]},B[48]={gravity:1,flammable:!0,growthHandler:!0,color:F[48]},B[51]={flammable:!0,growthHandler:!0,color:F[51]},B[45]={immobile:!0,volatile:[.008,0],infectiousHandler:!0,color:F[45]},B[47]={immobile:!0,volatile:[.003,0],killsCreatures:!0,corrosiveHandler:!0,color:F[47]},B[31]={projectileHandler:!0,color:F[31]},B[32]={projectileHandler:!0,color:F[32]},B[33]={projectileHandler:!0,color:F[33]},B[34]={projectileHandler:!0,color:F[34]},B[35]={projectileHandler:!0,color:F[35]},B[36]={projectileHandler:!0,color:F[36]},B[37]={projectileHandler:!0,color:F[37]},B[38]={projectileHandler:!0,color:F[38]},B[39]={projectileHandler:!0,volatile:[.3,0],color:F[39]};const X=new Uint32Array(66);for(let t=0;t<66;t++){const o=B[t];if(!o)continue;let i=0;o.gravity!==void 0&&(i|=Ut),o.buoyancy!==void 0&&(i|=Bt),o.liquid!==void 0&&(i|=Tt),o.density!==void 0&&(i|=vt),o.randomWalk!==void 0&&(i|=dt),o.volatile&&(i|=Vt),o.meltOnHeat!==void 0&&(i|=pt),o.flammable&&(i|=Kt),o.heatSource&&(i|=wt),o.immobile&&(i|=Ft),o.living&&(i|=qt),o.killsCreatures&&(i|=jt),o.explosive&&(i|=Qt),o.spawnerHandler&&(i|=g),o.creatureHandler&&(i|=tt),o.growthHandler&&(i|=st),o.corrosiveHandler&&(i|=rt),o.infectiousHandler&&(i|=et),o.projectileHandler&&(i|=it),o.lightningHandler&&(i|=bt),o.fireworkHandler&&(i|=Xt),o.bubbleHandler&&(i|=zt),o.cometHandler&&(i|=Zt),X[t]=i}const Wt=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],_t=[35,36,37,38,31,32,33,34];function Jt(t,o,i,T,n,r,f,s,l){const E=(b,x)=>x*r+b,e=n-31,[c,u]=Wt[e];if(u>0||c!==0&&c>0===s)return;const L=o+c,M=i+u;if(L<0||L>=r||M<0||M>=f){t[T]=39;return}const a=E(L,M),P=t[a];if(P===22||P===11){t[a]=6,t[T]=39;return}if(P===9||P===15||P===21||P===25||P===14){t[a]=n,t[T]=39;return}if(P===2){if(l()<.15)t[T]=39;else{if(l()<.5)return;t[a]=n,t[T]=39}return}if(P===30){const b=L+c,x=M+u;if(b>=0&&b<r&&x>=0&&x<f){const A=E(b,x);t[A]===0&&(t[A]=n)}t[T]=39;return}if(P===46){t[T]=_t[n-31];return}if(P===5||P===26||P===12||P===8||P===7||P>=31&&P<=38||P===39){t[a]=n,t[T]=39;return}if(P===4||P===3||P===1){l()<.2||(t[a]=n),t[T]=39;return}if(P===0){t[a]=n,t[T]=39;return}t[T]=39}function $t(t,o,i,T,n,r,f,s,l){const E=(b,x)=>x*r+b,e=n-31,[c,u]=Wt[e];if(c!==0&&c>0===s)return;const L=o+c,M=i+u;if(L<0||L>=r||M<0||M>=f){t[T]=39;return}const a=E(L,M),P=t[a];if(P===22||P===11){t[a]=6,t[T]=39;return}if(P===9||P===15||P===21||P===25||P===14){t[a]=n,t[T]=39;return}if(P===2){if(l()<.15)t[T]=39;else{if(l()<.5)return;t[a]=n,t[T]=39}return}if(P===30){const b=L+c,x=M+u;b>=0&&b<r&&x>=0&&x<f&&t[E(b,x)]===0&&(t[E(b,x)]=n),t[T]=39;return}if(P===46){t[T]=_t[n-31];return}if(P===5||P===26||P===12||P===8||P===7||P>=31&&P<=38||P===39){t[a]=n,t[T]=39;return}if(P===4||P===3||P===1){l()<.2||(t[a]=n),t[T]=39;return}if(P===0){t[a]=n,t[T]=39;return}t[T]=39}function gt(t,o,i){i()<.3&&(t[o]=0)}function y(t,o,i,T){return t>=0&&t<i&&o>=0&&o<T}function nt(t,o,i,T,n,r,f,s,l,E,e){for(let c=0;c<s;c++){const u=Math.floor(f()*3)-1,L=Math.floor(f()*3)-1;if(u===0&&L===0)continue;const M=o+u,a=i+L;if(!y(M,a,n,r))continue;const P=t[a*n+M];for(let b=0;b<l.length;b++)if(P===l[b])return t[T]=E,!0;if(e){const b=e(P);if(b!==!1)return t[T]=b,!0}}return!1}function lt(t,o){const i=Math.floor(t()*3)-1,T=t()<o?1:Math.floor(t()*3)-1;return[i,T]}const ut=[6,10,13,19];function te(t,o,i,T,n,r,f){if(nt(t,o,i,T,n,r,f,2,ut,6,a=>a===16||a===17?0:!1)){if(t[T]===6)for(let a=0;a<4;a++){const P=o+Math.floor(f()*3)-1,b=i+Math.floor(f()*3)-1;y(P,b,n,r)&&t[b*n+P]===0&&f()<.5&&(t[b*n+P]=6)}return}if(f()<.003){t[T]=8;return}if(f()<.4)return;const s=f(),l=f();let E=0,e=0;if(s<.5?(e=-1,E=l<.35?-1:l<.7?1:0):s<.75?(E=l<.5?-2:2,e=l<.4?-1:0):s<.9&&(e=1,E=l<.5?-1:1),E===0&&e===0)return;const c=o+E,u=i+e;if(!y(c,u,n,r))return;const L=u*n+c,M=t[L];M===15||M===9||M===25?(t[L]=21,t[T]=f()<.6?21:5):(M===0||M===8)&&(t[L]=21,t[T]=0)}function ee(t,o,i,T,n,r,f){if(nt(t,o,i,T,n,r,f,2,ut,6))return;const s=f(),l=f();let E=0,e=0;if(s<.3?(e=-1,E=l<.4?-1:l<.8?1:0):s<.5?(e=1,E=l<.4?-1:l<.8?1:0):s<.8&&(E=l<.5?-1:1,e=l<.3?-1:l<.6?1:0),E===0&&e===0)return;const c=o+E,u=i+e;if(!y(c,u,n,r))return;const L=u*n+c,M=t[L];if(M===5){if(f()<.08)for(let a=-1;a<=1;a++)for(let P=-1;P<=1;P++){if(a===0&&P===0)continue;const b=c+P,x=u+a;if(y(b,x,n,r)&&t[x*n+b]===0){t[x*n+b]=26;break}}}else M===0?(t[L]=25,t[T]=0):M===26&&(t[L]=25,t[T]=f()<.1?28:f()<.15?0:26)}function ie(t,o,i,T,n,r,f){if(nt(t,o,i,T,n,r,f,2,[6,10,42],6,L=>L===2||L===41||L===21?0:!1))return;if(f()<.15){const L=o+Math.floor(f()*3)-1,M=i+Math.floor(f()*3)-1;y(L,M,n,r)&&t[M*n+L]===0&&(t[M*n+L]=f()<.7?56:20)}if(f()<.5)return;let s=0,l=0;for(let L=0;L<3;L++){const M=Math.floor(f()*9)-4,a=Math.floor(f()*9)-4,P=o+M,b=i+a;if(y(P,b,n,r)&&t[b*n+P]===26){s=Math.sign(M),l=Math.sign(a);break}}if(s===0&&l===0){const L=f();L<.25?(l=-1,s=f()<.5?-1:1):L<.4?(l=1,s=f()<.5?-1:1):L<.7&&(s=f()<.5?-1:1)}if(s===0&&l===0)return;const E=o+s,e=i+l;if(!y(E,e,n,r))return;const c=e*n+E,u=t[c];if(u===0)t[c]=61,t[T]=0;else if(u===26&&f()<.03){const L=o+Math.floor(f()*3)-1,M=i+Math.floor(f()*3)-1;y(L,M,n,r)&&t[M*n+L]===0&&(t[M*n+L]=61)}}function ne(t,o,i,T,n,r,f){if(nt(t,o,i,T,n,r,f,1,ut,6)||f()<.5)return;const[s,l]=lt(f,.7);if(s===0&&l===0)return;const E=o+s,e=i+l;if(!y(E,e,n,r))return;const c=e*n+E,u=t[c];u===5?(t[c]=9,t[T]=f()<.3?0:3):u===0?(t[c]=9,t[T]=0):u===2&&(t[c]=9,t[T]=2)}function oe(t,o,i,T,n,r,f){if(f()<.5)return;const s=i>0?t[(i-1)*n+o]:0,l=s===5||s===26||s===3,E=Math.floor(f()*3)-1,e=l?-1:f()<.7?1:Math.floor(f()*3)-1;if(E===0&&e===0)return;const c=o+E,u=i+e;if(!y(c,u,n,r))return;const L=u*n+c,M=t[L];if(M===6||M===10||M===42){t[T]=6;return}if(M===41){t[T]=0;return}if(M===2){t[L]=15,t[T]=2;return}(M===3||M===1||M===5||M===26||M===0)&&(t[L]=15,t[T]=0)}function fe(t,o,i,T,n,r,f){if(f()<.4)return;const[s,l]=lt(f,.3);if(s===0&&l===0)return;const E=o+s,e=i+l;if(!y(E,e,n,r))return;const c=e*n+E,u=t[c];u===0?(t[c]=16,t[T]=f()<.1?14:0):u===9||u===15||u===21||u===25||u===14||u===5||u===26?(t[c]=16,t[T]=14):(u===6||u===10||u===13)&&(t[T]=14)}function Ee(t,o,i,T,n,r,f){if(f()<.4)return;const[s,l]=lt(f,.6);if(s===0&&l===0)return;const E=o+s,e=i+l;if(!y(E,e,n,r))return;const c=e*n+E,u=t[c];if(u===6||u===42||u===41||u===21){t[T]=0;return}u===3||u===1||u===0?(t[c]=62,t[T]=0):u===2&&(t[c]=62,t[T]=2)}function ce(t,o,i,T,n,r,f){if(f()<.3)return;const s=Math.floor(f()*3)-1,l=f()<.6?-1:Math.floor(f()*3)-1;if(s===0&&l===0)return;const E=o+s,e=i+l;if(!y(E,e,n,r))return;const c=e*n+E,u=t[c];if(u===6||u===42||u===10){t[T]=56;return}u===0?(t[c]=63,t[T]=f()<.15?56:0):u===3||u===1?(t[c]=63,t[T]=26):u===2?(t[c]=63,t[T]=56):u===5?(t[c]=63,t[T]=26):u===4&&(t[T]=f()<.1?56:0)}function Te(t,o,i,T,n,r,f){let s=!1;if((i<r-1&&t[(i+1)*n+o]===2||i>0&&t[(i-1)*n+o]===2||o>0&&t[i*n+o-1]===2||o<n-1&&t[i*n+o+1]===2)&&(s=!0),!s){t[T]=0;return}if(f()<.4)return;const l=Math.floor(f()*3)-1,E=Math.floor(f()*3)-1;if(l===0&&E===0)return;const e=o+l,c=i+E;if(!y(e,c,n,r))return;const u=c*n+e,L=t[u];(L===2||L===9||L===51||L===62)&&(t[u]=64,t[T]=2)}function se(t,o,i,T,n,r,f){if(f()<.3)return;let s=0,l=0;for(let a=0;a<2;a++){const P=Math.floor(f()*9)-4,b=Math.floor(f()*9)-4,x=o+P,A=i+b;if(y(x,A,n,r)){const R=t[A*n+x];if(R===6||R===19||R===61||R===13){s=Math.sign(P),l=Math.sign(b);break}}}const E=s!==0?s:Math.floor(f()*3)-1,e=l!==0?l:f()<.4?-1:Math.floor(f()*3)-1;if(E===0&&e===0)return;const c=o+E,u=i+e;if(!y(c,u,n,r))return;const L=u*n+c,M=t[L];if(M===6||M===19||M===42||M===10){t[T]=6;return}M===0?(t[L]=65,t[T]=0):(M===5||M===26)&&(t[L]=65,t[T]=f()<.3?0:5)}const p=64,V=6,re=60;class le{chunkCols=0;chunkRows=0;cols=0;rows=0;active;sleepCounter;checksum;renderDirty;stampGrid;tickParity=0;init(o,i){this.cols=o,this.rows=i,this.chunkCols=Math.ceil(o/p),this.chunkRows=Math.ceil(i/p);const T=this.chunkCols*this.chunkRows;this.active=new Uint8Array(T).fill(1),this.sleepCounter=new Uint8Array(T),this.checksum=new Int32Array(T),this.renderDirty=new Uint8Array(T).fill(1),this.stampGrid=new Uint8Array(o*i),this.tickParity=0}wakeChunk(o,i){if(o<0||o>=this.chunkCols||i<0||i>=this.chunkRows)return;const T=i*this.chunkCols+o;this.active[T]=1,this.sleepCounter[T]=0}flipTick(){this.tickParity=this.tickParity?0:1}wakeRadius(o,i,T){const n=Math.max(0,o-T>>V),r=Math.min(this.chunkCols-1,o+T>>V),f=Math.max(0,i-T>>V),s=Math.min(this.chunkRows-1,i+T>>V);for(let l=f;l<=s;l++)for(let E=n;E<=r;E++){const e=l*this.chunkCols+E;this.renderDirty[e]=1,this.wakeChunk(E,l)}}wakeNeighbors(o,i){for(let T=-1;T<=1;T++)for(let n=-1;n<=1;n++)this.wakeChunk(o+n,i+T)}updateActivity(o,i){const{chunkCols:T,chunkRows:n,cols:r,rows:f}=this;for(let s=0;s<n;s++)for(let l=0;l<T;l++){const E=s*T+l;if(!this.active[E])continue;const e=this.computeChecksum(o,l,s,r,f);if(e!==this.checksum[E])this.checksum[E]=e,this.sleepCounter[E]=0,this.renderDirty[E]=1,this.wakeNeighbors(l,s);else{const c=this.sleepCounter[E]+1;this.sleepCounter[E]=c>255?255:c,c>=re&&(i&&this.chunkHasMatch(o,l,s,i)?this.sleepCounter[E]=0:this.active[E]=0)}}}wakeAll(){this.active.fill(1),this.sleepCounter.fill(0),this.renderDirty.fill(1)}computeChecksum(o,i,T,n,r){const f=i<<V,s=T<<V,l=Math.min(f+p,n),E=Math.min(s+p,r);let e=0;for(let c=s;c<E;c++){const u=c*n,L=c*137+1|0;for(let M=f;M<l;M++)e=e+o[u+M]*(M+L)|0}return e}chunkHasMatch(o,i,T,n){const r=i<<V,f=T<<V,s=Math.min(r+p,this.cols),l=Math.min(f+p,this.rows);for(let E=f;E<l;E++){const e=E*this.cols;for(let c=r;c<s;c++)if(n(o[e+c]))return!0}return!1}}function ue(t,o,i,T,n){const r=(e,c)=>c*o+e,{chunkCols:f,active:s,stampGrid:l,tickParity:E}=T;for(let e=0;e<i;e++){const c=e>>V,u=n()<.5;for(let L=0;L<f;L++){const M=u?L:f-1-L;if(!s[c*f+M])continue;const a=M<<V,P=Math.min(a+p,o),b=P-a;for(let x=0;x<b;x++){const A=u?a+x:P-1-x,R=e*o+A,W=t[R];if(W===0||l[R]===E)continue;const C=X[W];if(C&it){W>=31&&W<=38&&W!==35&&W!==34&&W!==36&&W!==39&&Jt(t,A,e,R,W,o,i,u,n);continue}if(C&tt){switch(W){case 21:te(t,A,e,R,o,i,n);break;case 25:ee(t,A,e,R,o,i,n);break;case 61:ie(t,A,e,R,o,i,n);break}continue}if(W===6||W===59){if(e===0){t[R]=0;continue}if(n()<.1){t[R]=n()<.25?7:n()<.15?19:0;continue}for(let S=0;S<3;S++){const N=Math.floor(n()*3)-1,O=Math.floor(n()*3)-1;if(N===0&&O===0)continue;const I=A+N,Y=e+O;if(I>=0&&I<o&&Y>=0&&Y<i){const U=r(I,Y),_=t[U];(_===5||_===8||_===9||_===7||_===22||_===26||_===27||_===29)&&n()<.5&&(t[U]=6)}}const h=r(A,e-1);if(e>0&&t[h]===0)t[h]=W,t[R]=0,l[h]=E;else{const S=n()<.5?-1:1;if(e>0&&A+S>=0&&A+S<o&&t[r(A+S,e-1)]===0){const N=r(A+S,e-1);t[N]=W,t[R]=0,l[N]=E}}continue}if(W===7){if(e===0){t[R]=0;continue}const h=r(A,e-1);if(e>0&&t[h]===0)t[h]=7,t[R]=0,l[h]=E;else{const S=n()<.5?-1:1;if(e>0&&A+S>=0&&A+S<o&&t[r(A+S,e-1)]===0){const N=r(A+S,e-1);t[N]=7,t[R]=0,l[N]=E}else if(A+S>=0&&A+S<o&&t[r(A+S,e)]===0){const N=r(A+S,e);t[N]=7,t[R]=0,l[N]=E}}continue}if(W===10){if(e===0){t[R]=0;continue}if(n()<.08){t[R]=0;continue}for(let S=0;S<3;S++){const N=Math.floor(n()*3)-1,O=Math.floor(n()*3)-1;if(N===0&&O===0)continue;const I=A+N,Y=e+O;if(I>=0&&I<o&&Y>=0&&Y<i){const U=t[r(I,Y)];U===1&&n()<.5?t[r(I,Y)]=10:(U===5||U===8||U===7||U===26)&&n()<.5&&(t[r(I,Y)]=6)}}const h=r(A,e-1);if(e>0&&t[h]===0)t[h]=10,t[R]=0,l[h]=E;else{const S=n()<.5?-1:1;if(e>0&&A+S>=0&&A+S<o&&t[r(A+S,e-1)]===0){const N=r(A+S,e-1);t[N]=10,t[R]=0,l[N]=E}}continue}if(C&et){if(W===50){if(n()<.01){t[R]=0;continue}for(let h=0;h<3;h++){const S=Math.floor(n()*3)-1,N=Math.floor(n()*3)-1;if(S===0&&N===0)continue;const O=A+S,I=e+N;if(O>=0&&O<o&&I>=0&&I<i){const Y=t[r(O,I)];if((Y===5||Y===26||Y===8||Y===28||Y===3||Y===51)&&n()<.35){t[r(O,I)]=45,t[R]=0;break}}}if(t[R]!==50)continue;if(n()<.4){const h=Math.floor(n()*3)-1,S=n()<.6?-1:n()<.5?0:1,N=A+h,O=e+S;if(N>=0&&N<o&&O>=0&&O<i&&t[r(N,O)]===0){const I=r(N,O);t[I]=50,t[R]=0,l[I]=E}}}continue}if(W===40){if(e<i-1&&t[r(A,e+1)]===0&&n()<.04&&(t[r(A,e+1)]=2),n()<.3){const h=n()<.5?-1:1,S=n()<.3?-1:n()<.5?1:0,N=A+h,O=e+S;if(N>=0&&N<o&&O>=0&&O<i&&t[r(N,O)]===0){const I=r(N,O);t[I]=40,t[R]=0,l[I]=E}}continue}if(W===54){if(e>0&&n()<.95){const h=r(A,e-1);if(t[h]===0)t[h]=54,t[R]=0,l[h]=E;else{t[R]=0;const S=8,N=[6,19,20,10,56,59];for(let O=-S;O<=S;O++)for(let I=-S;I<=S;I++)if(I*I+O*O<=S*S&&n()<.5){const Y=A+I,U=e+O;Y>=0&&Y<o&&U>=0&&U<i&&t[r(Y,U)]===0&&(t[r(Y,U)]=N[Math.floor(n()*N.length)])}}}else{t[R]=0;const h=7,S=[6,19,20,10,56,59];for(let N=-h;N<=h;N++)for(let O=-h;O<=h;O++)if(O*O+N*N<=h*h&&n()<.45){const I=A+O,Y=e+N;I>=0&&I<o&&Y>=0&&Y<i&&t[r(I,Y)]===0&&(t[r(I,Y)]=S[Math.floor(n()*S.length)])}}continue}if(W===55){let h=!1;for(let S=0;S<3;S++){const N=Math.floor(n()*3)-1,O=Math.floor(n()*3)-1,I=A+N,Y=e+O;if(I>=0&&I<o&&Y>=0&&Y<i){const U=t[r(I,Y)];if(U===2||U===41||U===28||U===52){h=!0;break}}}if(h){if(e>0&&n()<.6){const S=r(A,e-1),N=t[S];if(N===2||N===41||N===28||N===52)t[S]=55,t[R]=N,l[S]=E;else if(N===0){t[R]=0;for(let O=0;O<3;O++){const I=A+Math.floor(n()*3)-1,Y=e-1-Math.floor(n()*2);I>=0&&I<o&&Y>=0&&Y<i&&t[r(I,Y)]===0&&(t[r(I,Y)]=2)}}}if(n()<.2){const S=n()<.5?-1:1;if(A+S>=0&&A+S<o){const N=r(A+S,e),O=t[N];(O===2||O===41||O===28||O===52)&&(t[N]=55,t[R]=O,l[N]=E)}}}else t[R]=7;continue}if(W===58){const h=n()<.8?-2:-1,S=Math.floor(n()*3)-1;let N=!1;for(let O=Math.abs(h);O>0;O--){const I=e-O,Y=A+(O===Math.abs(h)?S:0);if(I>=0&&I<i&&Y>=0&&Y<o){const U=r(Y,I),_=t[U];if(_===0){t[U]=58,t[R]=59,l[U]=E,N=!0;break}else if(_===2){t[U]=7,t[R]=59,N=!0;break}else if(_===5||_===8||_===26){t[U]=59,t[R]=59,N=!0;break}else if(_===1){t[U]=12,t[R]=59,N=!0;break}else{t[R]=0;for(let G=-2;G<=2;G++)for(let d=-2;d<=2;d++){const D=A+d,m=e+G;D>=0&&D<o&&m>=0&&m<i&&t[r(D,m)]===0&&(t[r(D,m)]=n()<.6?59:19)}N=!0;break}}}(!N||n()<.05)&&(t[R]=59);continue}if(W===13){if(n()<.2){t[R]=n()<.2?20:0;continue}let h=!1;for(let S=1;S<=3&&!h;S++){const N=e+S;if(N>=i)break;const O=r(A,N),I=t[O];if(I===1){t[O]=12,t[R]=0,h=!0;for(let Y=0;Y<3;Y++){let U=A,_=N,G=n()<.5?-1:1;for(let d=0;d<8&&(n()<.3&&(G=n()<.5?-1:1),U+=G,_+=n()<.8?1:0,!(U<0||U>=o||_>=i));d++){const D=r(U,_);if(t[D]===1)t[D]=12;else if(t[D]!==0&&t[D]!==12)break}}}else if(I===2){t[O]=13,t[R]=0,h=!0;for(let Y=-3;Y<=3;Y++){const U=A+Y;U>=0&&U<o&&t[r(U,N)]===2&&n()<.7&&(t[r(U,N)]=13)}}else if(I===5||I===8||I===9)t[O]=6,t[R]=0,h=!0;else if(I===11){t[R]=0;const Y=15;for(let U=-Y;U<=Y;U++)for(let _=-Y;_<=Y;_++)if(_*_+U*U<=Y*Y){const G=A+_,d=N+U;if(G>=0&&G<o&&d>=0&&d<i){const D=r(G,d),m=t[D];m===2?t[D]=n()<.7?4:0:m!==4&&m!==12&&(t[D]=6)}}h=!0}else if(I===4||I===12)t[R]=0,h=!0;else if(I===3)n()<.4&&(t[O]=12),t[R]=0,h=!0;else{if(I===0)continue;t[R]=0,h=!0}}if(!h&&e+1<i&&t[r(A,e+1)]===0){const S=r(A,e+1);if(t[S]=13,t[R]=0,l[S]=E,n()<.15){const N=A+(n()<.5?-1:1);N>=0&&N<o&&t[r(N,e)]===0&&(t[r(N,e)]=13)}}else h||(t[R]=0);continue}}}}}function Le(t,o,i,T,n,r,f){const s=(e,c)=>c*n+e,l=i<r-1?t[s(o,i+1)]:0;let E=!1;for(let e=0;e<3;e++){const c=Math.floor(f()*3)-1,u=Math.floor(f()*3)-1;if(c===0&&u===0)continue;const L=o+c,M=i+u;if(L>=0&&L<n&&M>=0&&M<r){const a=s(L,M),P=t[a];if((P===5||P===3||P===1||P===8||P===26||P===14)&&f()<.3){t[a]=f()<.7?0:7,f()<.4&&(t[T]=0,E=!0);break}if((P===4||P===12||P===18)&&f()<.08){t[a]=0,t[T]=0,E=!0;break}if((P===9||P===15||P===21||P===25)&&f()<.5){t[a]=41;break}}}if(!E)if(l===0)t[s(o,i+1)]=41,t[T]=0;else{const e=f()<.5?-1:1,c=o+e,u=o-e;c>=0&&c<n&&t[s(c,i+1)]===0?(t[s(c,i+1)]=41,t[T]=0):u>=0&&u<n&&t[s(u,i+1)]===0?(t[s(u,i+1)]=41,t[T]=0):c>=0&&c<n&&t[s(c,i)]===0?(t[s(c,i)]=41,t[T]=0):u>=0&&u<n&&t[s(u,i)]===0&&(t[s(u,i)]=41,t[T]=0)}}function Me(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E,l=i<r-1?t[s(o,i+1)]:0;for(let E=0;E<3;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=s(u,L),a=t[M];if(a===2){if(t[M]=f()<.5?4:7,f()<.15){t[T]=4;break}}else a===43?t[M]=2:a===1&&f()<.4?t[M]=12:((a===5||a===8||a===7||a===26||a===22||a===27||a===29)&&f()<.7||(a===9||a===15||a===21||a===25)&&f()<.8)&&(t[M]=6)}}if(f()<.001){t[T]=4;return}if(!(f()>.15))if(l===0)t[s(o,i+1)]=42,t[T]=0;else{const E=f()<.5?-1:1,e=o+E,c=o-E;e>=0&&e<n&&t[s(e,i+1)]===0?(t[s(e,i+1)]=42,t[T]=0):c>=0&&c<n&&t[s(c,i+1)]===0?(t[s(c,i+1)]=42,t[T]=0):e>=0&&e<n&&t[s(e,i)]===0&&f()<.3?(t[s(e,i)]=42,t[T]=0):c>=0&&c<n&&t[s(c,i)]===0&&f()<.3&&(t[s(c,i)]=42,t[T]=0)}}function Ae(t,o,i,T,n,r,f){const s=(l,E)=>E*n+l;if(f()<.008){t[T]=0;return}for(let l=0;l<2;l++){const E=Math.floor(f()*3)-1,e=Math.floor(f()*3)-1;if(E===0&&e===0)continue;const c=o+E,u=i+e;if(c>=0&&c<n&&u>=0&&u<r){const L=t[s(c,u)];if(L===6||L===10||L===42||L===41){t[T]=L===41?0:6;break}}}if(!(t[T]===6||t[T]===0)&&f()<.08){const l=Math.floor(f()*3)-1,E=Math.floor(f()*3)-1,e=o+l,c=i+E;if(e>=0&&e<n&&c>=0&&c<r){const u=s(e,c),L=t[u];L===5||L===26||L===8||L===28||L===3?(t[u]=45,f()<.2&&(t[T]=f()<.4?50:7)):(L===9||L===15||L===14)&&f()<.3?t[u]=45:L===0&&f()<.1&&(t[u]=45,t[T]=f()<.3?7:0)}}}function Re(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E,l=i<r-1?t[s(o,i+1)]:0;for(let E=0;E<2;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=t[s(u,L)];(M===9||M===15||M===21||M===25||M===14)&&f()<.5&&(t[s(u,L)]=0)}}if(l===0)t[s(o,i+1)]=46,t[T]=0;else if(l===2||l===41||l===28||l===1||l===3)f()<.7&&(t[s(o,i+1)]=46,t[T]=l);else{const E=f()<.5?-1:1,e=o+E,c=o-E;e>=0&&e<n&&t[s(e,i+1)]===0?(t[s(e,i+1)]=46,t[T]=0):c>=0&&c<n&&t[s(c,i+1)]===0?(t[s(c,i+1)]=46,t[T]=0):e>=0&&e<n&&t[s(e,i)]===0?(t[s(e,i)]=46,t[T]=0):c>=0&&c<n&&t[s(c,i)]===0&&(t[s(c,i)]=46,t[T]=0)}}function ae(t,o,i,T,n,r,f){const s=(l,E)=>E*n+l;if(f()<.003){t[T]=0;return}for(let l=0;l<2;l++){const E=Math.floor(f()*3)-1,e=Math.floor(f()*3)-1;if(E===0&&e===0)continue;const c=o+E,u=i+e;if(c>=0&&c<n&&u>=0&&u<r&&t[s(c,u)]===13){t[T]=20;break}}if(t[T]!==20&&f()<.1){const l=Math.floor(f()*3)-1,E=Math.floor(f()*3)-1,e=o+l,c=i+E;if(e>=0&&e<n&&c>=0&&c<r){const u=s(e,c),L=t[u];if(L!==0&&L!==4&&L!==12&&L!==18&&L!==47&&L!==23&&L!==44&&(t[u]=0,f()<.02)){const M=o+Math.floor(f()*3)-1,a=i+Math.floor(f()*3)-1;M>=0&&M<n&&a>=0&&a<r&&t[s(M,a)]===0&&(t[s(M,a)]=47)}}}}function Pe(t,o,i,T,n,r,f){const s=(e,c)=>c*n+e,l=i<r-1?t[s(o,i+1)]:0;if(f()<.005){t[T]=3;return}let E=!1;for(let e=0;e<2;e++){const c=Math.floor(f()*3)-1,u=Math.floor(f()*3)-1,L=o+c,M=i+u;if(L>=0&&L<n&&M>=0&&M<r&&t[s(L,M)]===2){E=!0;break}}if(E&&f()<.03){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1,u=o+e,L=i+c;u>=0&&u<n&&L>=0&&L<r&&t[s(u,L)]===4&&(t[s(u,L)]=49)}l===0&&f()<.1&&(t[s(o,i+1)]=49,t[T]=0)}function Ie(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E,l=i<r-1?t[s(o,i+1)]:0;for(let E=0;E<3;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=t[s(u,L)];(M===9||M===15||M===21||M===25||M===14)&&f()<.5||M===51&&f()<.08||M===5&&f()<.05?t[s(u,L)]=52:M===2&&f()<.15&&(t[s(u,L)]=0,f()<.5&&(t[T]=2))}}if(t[T]===52&&!(f()>.3))if(l===0)t[s(o,i+1)]=52,t[T]=0;else{const E=f()<.5?-1:1,e=o+E,c=o-E;e>=0&&e<n&&t[s(e,i+1)]===0?(t[s(e,i+1)]=52,t[T]=0):c>=0&&c<n&&t[s(c,i+1)]===0?(t[s(c,i+1)]=52,t[T]=0):e>=0&&e<n&&t[s(e,i)]===0?(t[s(e,i)]=52,t[T]=0):c>=0&&c<n&&t[s(c,i)]===0&&(t[s(c,i)]=52,t[T]=0)}}function Se(t,o,i,T,n,r,f){const s=(u,L)=>L*n+u;if(f()<.92)return;const l=Math.floor(f()*3)-1,E=f()<.7?-1:Math.floor(f()*3)-1,e=o+l,c=i+E;e>=0&&e<n&&c>=0&&c<r&&t[s(e,c)]===2&&(t[s(e,c)]=f()<.1?26:5)}function he(t,o,i,T,n,r,f){const s=(h,S)=>S*n+h,l=i<r-1?t[s(o,i+1)]:0,E=i>0?s(o,i-1):-1,e=E>=0?t[E]:0;if(!(l===2&&e!==2&&f()<.7)){if(l===2&&e===2){t[E]=48,t[T]=2;return}else if(l===0){t[s(o,i+1)]=48,t[T]=0;return}}const c=Math.floor(f()*8),u=[0,1,1,1,0,-1,-1,-1][c],L=[-1,-1,0,1,1,1,0,-1][c],M=o+u,a=i+L;if(M>=0&&M<n&&a>=0&&a<r){const h=t[s(M,a)];if(h===6||h===10||h===42){t[T]=6;return}if((h===9||h===15||h===21)&&f()<.3){t[T]=0;return}}if(f()>.35||!(i<r-1&&(t[s(o,i+1)]===3||t[s(o,i+1)]===2)||e===3||e===2||e===5))return;let b=!1,x=!1;for(let h=0;h<6;h++){const S=Math.floor(f()*13)-6,N=Math.floor(f()*13)-6,O=o+S,I=i+N;if(O>=0&&O<n&&I>=0&&I<r){const Y=t[s(O,I)];Y===2&&(b=!0),Y===57&&(x=!0)}}const A=x?.7:b?.5:.25;if(f()>A)return;const R=x?50:b?30:20;let W=-1;for(let h=1;h<=R&&!(i-h<0);h++){const S=t[s(o,i-h)];if(S===0||S===2){W=i-h;break}if(S!==5&&S!==26&&S!==3&&S!==48)break}if(W>=0){const h=x?.3:b?.15:.1;t[s(o,W)]=f()<h?26:5}const C=i-(W>=0?W:i);if(C>10&&f()<(x?.2:.1)){const h=o+(f()<.5?-1:1),S=i-Math.floor(f()*Math.min(C,15))-5,N=h>=0&&h<n&&S>=0?t[s(h,S)]:-1;(N===0||N===2)&&(t[s(h,S)]=f()<.4?26:5)}}function Ye(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E;let l=!1;if((i>0&&t[s(o,i-1)]===2||i<r-1&&t[s(o,i+1)]===2||o>0&&t[s(o-1,i)]===2||o<n-1&&t[s(o+1,i)]===2)&&(l=!0),!l&&f()<.001){t[T]=5;return}if(l&&f()<.015&&i>0){const E=s(o,i-1);t[E]===2&&(t[E]=7)}if(l&&f()<.06){const E=Math.floor(f()*3)-1,e=Math.floor(f()*3)-1,c=o+E,u=i+e;c>=0&&c<n&&u>=0&&u<r&&t[s(c,u)]===2&&(t[s(c,u)]=51)}for(let E=0;E<2;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=t[s(u,L)];if((M===9||M===14)&&f()<.25){t[T]=0;break}}}}function Ne(t,o,i,T,n,r,f){const s=(u,L)=>L*n+u;if(f()<.03){t[T]=f()<.33?18:f()<.5?19:20;return}const l=Math.floor(f()*3)-1,E=Math.floor(f()*3)-1;if(l===0&&E===0)return;const e=o+l,c=i+E;e>=0&&e<n&&c>=0&&c<r&&t[s(e,c)]===0&&(t[s(e,c)]=17,t[T]=0)}function Oe(t,o,i,T,n,r,f){f()<.002&&(t[T]=1)}function Ue(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E,l=i<r-1?t[s(o,i+1)]:0;if(f()<.05){t[T]=f()<.3?6:0;return}for(let E=0;E<2;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=t[s(u,L)];(M===5||M===8||M===7||M===26)&&f()<.4&&(t[s(u,L)]=6)}}if(l===0)t[s(o,i+1)]=19,t[T]=0;else{const E=f()<.5?-1:1;o+E>=0&&o+E<n&&t[s(o+E,i+1)]===0&&(t[s(o+E,i+1)]=19,t[T]=0)}}function Be(t,o,i,T,n,r,f){const s=(e,c)=>c*n+e;if(f()<.08){t[T]=0;return}const l=Math.floor(f()*3)-1,E=Math.floor(f()*3)-1;if(l!==0||E!==0){const e=o+l,c=i+E;e>=0&&e<n&&c>=0&&c<r&&t[s(e,c)]===0&&(t[s(e,c)]=20,t[T]=0)}}function Fe(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E;let l=!1;for(let E=0;E<2;E++){const e=Math.floor(f()*3)-1,c=Math.floor(f()*3)-1;if(e===0&&c===0)continue;const u=o+e,L=i+c;if(u>=0&&u<n&&L>=0&&L<r){const M=t[s(u,L)];if(M===6||M===10||M===19||M===42){t[T]=6;for(let a=0;a<10;a++){const P=Math.floor(f()*5)-2,b=Math.floor(f()*5)-2,x=o+P,A=i+b;x>=0&&x<n&&A>=0&&A<r&&t[s(x,A)]===53&&f()<.8&&(t[s(x,A)]=6)}l=!0;break}}}if(!l){if(f()<.003){t[T]=1;return}if(f()<.3){const E=Math.floor(f()*3)-1,e=f()<.6?1:f()<.5?0:-1,c=o+E,u=i+e;c>=0&&c<n&&u>=0&&u<r&&t[s(c,u)]===0&&(t[s(c,u)]=53,t[T]=0)}}}function be(t,o,i,T,n,r,f){const s=(c,u)=>u*n+c,l=i<r-1?t[s(o,i+1)]:0;let E=0;for(let c=0;c<3;c++){const u=Math.floor(f()*3)-1,L=Math.floor(f()*3)-1;if(u===0&&L===0)continue;const M=o+u,a=i+L;M>=0&&M<n&&a>=0&&a<r&&t[s(M,a)]===56&&E++}const e=E===0?.15:E>0?.03:.01;if(f()<e){t[T]=0;return}if(f()<.3)if(l===0)t[s(o,i+1)]=56,t[T]=0;else{const c=f()<.5?-1:1;o+c>=0&&o+c<n&&t[s(o+c,i+1)]===0&&(t[s(o+c,i+1)]=56,t[T]=0)}}const We={23:2,24:2,27:2,29:2,30:2,44:4,57:6,60:12};function _e(t,o,i,T,n,r,f){i<r-1&&t[(i+1)*n+o]===0&&f()<.15&&(t[(i+1)*n+o]=2)}function xe(t,o,i,T,n,r,f){if(f()<.06){const s=Math.floor(f()*3)-1,l=Math.floor(f()*3)-1,E=o+s,e=i+l;E>=0&&E<n&&e>=0&&e<r&&t[e*n+E]===0&&(t[e*n+E]=15)}}function Ge(t,o,i,T,n,r,f){if(f()<.035){const s=Math.floor(f()*3)-1,l=Math.floor(f()*3)-1,E=o+s,e=i+l;E>=0&&E<n&&e>=0&&e<r&&t[e*n+E]===0&&(t[e*n+E]=25)}}function De(t,o,i,T,n,r,f){if(f()<.02){const s=Math.floor(f()*3)-1,l=-1,E=o+s,e=i+l;E>=0&&E<n&&e>=0&&e<r&&t[e*n+E]===0&&(t[e*n+E]=21)}}function Ce(t,o,i,T,n,r,f){if(f()<.08){const s=[31,32,33,34,35,36,37,38],l=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],E=Math.floor(f()*8);for(let e=0;e<8;e++){const c=(E+e)%8,[u,L]=l[c],M=o+u,a=i+L;if(M>=0&&M<n&&a>=0&&a<r&&t[a*n+M]===0){t[a*n+M]=s[c];break}}}}function me(t,o,i,T,n,r,f){const s=(l,E)=>E*n+l;for(let l=0;l<3;l++){const E=Math.floor(f()*3)-1,e=Math.floor(f()*3)-1;if(E===0&&e===0)continue;const c=o+E,u=i+e;if(c>=0&&c<n&&u>=0&&u<r){const L=t[s(c,u)];if(L===2){if(t[s(c,u)]=7,f()<.08){t[T]=4;return}}else L===43&&(t[s(c,u)]=2)}}if(t[T]!==4){if(f()<.55&&i>0){const l=s(o,i-1);t[l]===0&&(t[l]=42)}if(f()<.25){const l=f()<.5?-1:1;if(o+l>=0&&o+l<n&&i>0){const E=s(o+l,i-1);t[E]===0&&(t[E]=42)}}if(f()<.1){const l=Math.floor(f()*3)-1,E=Math.floor(f()*2)-1,e=o+l,c=i+E;e>=0&&e<n&&c>=0&&c<r&&t[s(e,c)]===0&&(t[s(e,c)]=19)}}}function ye(t,o,i,T,n,r,f){const s=(l,E)=>E*n+l;if(f()<.12){const l=f()*6.28318,E=f()*4+1,e=o+Math.round(Math.cos(l)*E),c=i+Math.round(Math.sin(l)*E);e>=0&&e<n&&c>=0&&c<r&&t[s(e,c)]===0&&(t[s(e,c)]=f()<.6?20:56)}if(f()<.04){const l=f()*6.28318,E=f()*12+3,e=o+Math.round(Math.cos(l)*E),c=i+Math.round(Math.sin(l)*E);if(e>=0&&e<n&&c>=0&&c<r){const u=s(e,c),L=t[u];L===5&&f()<.3?t[u]=26:L===2&&f()<.1?t[u]=51:L===3&&f()<.15||L===0&&f()<.05?t[u]=5:L===43&&f()<.2?t[u]=2:L===45&&f()<.1&&(t[u]=26)}}if(f()<.02)for(let l=0;l<5;l++){const E=Math.floor(f()*5)-2,e=Math.floor(f()*5)-2,c=o+E,u=i+e;if(c>=0&&c<n&&u>=0&&u<r){const L=s(c,u);t[L]===2&&(t[L]=7)}}}function ke(t,o,i,T,n,r,f){const s=(E,e)=>e*n+E;if(f()>.5)return;const l=10;for(let E=0;E<16;E++){const e=f()*6.28318,c=f()*l+1,u=Math.round(Math.cos(e)*c),L=Math.round(Math.sin(e)*c);if(u===0&&L===0)continue;const M=o+u,a=i+L;if(M<0||M>=n||a<0||a>=r)continue;const P=s(M,a),b=t[P];if(b===0||b===60||b===44||b===30||b===24||b===27)continue;const x=u>0?-1:u<0?1:0,A=L>0?-1:L<0?1:0,R=M+x,W=a+A;if(R>=0&&R<n&&W>=0&&W<r){const C=s(R,W);Math.abs(u+x)<=1&&Math.abs(L+A)<=1?t[P]=0:t[C]===0&&(t[C]=b,t[P]=0)}}for(let E=-6;E<=6;E+=2){const e=o+E;if(!(e<0||e>=n))for(let c=-8;c<=2;c+=2){const u=i+c;if(u<0||u>=r)continue;const L=s(e,u),M=t[L];if(!(M===0||M===60)&&Math.abs(E)>1&&f()<.3){const a=E>0?-1:1,P=e+a;P>=0&&P<n&&t[s(P,u)]===0&&(t[s(P,u)]=M,t[L]=0)}}}}function He(t,o,i,T,n,r,f,s,l,E){const e=B[f];if(s()>e.gravity||i>=r-1)return!1;const c=T+n,u=t[c];if(u===0)return t[c]=f,t[T]=0,l[c]=E,!0;if(e.density!==void 0){const L=B[u];if(L&&L.density!==void 0&&e.density>L.density&&X[u]&Tt)return t[c]=f,t[T]=u,l[c]=E,!0}if(f!==3){const L=o>0&&t[c-1]===0,M=o<n-1&&t[c+1]===0;let a=0;if(L&&M?a=s()<.5?-1:1:L?a=-1:M&&(a=1),a!==0)return t[c+a]=f,t[T]=0,l[c+a]=E,!0}return!1}function ve(t,o,i,T,n,r,f,s,l){const E=B[r];if(f()>E.liquid)return!1;const e=f()<.5?-1:1;return o+e>=0&&o+e<n&&t[T+e]===0?(t[T+e]=r,t[T]=0,s[T+e]=l,!0):o-e>=0&&o-e<n&&t[T-e]===0?(t[T-e]=r,t[T]=0,s[T-e]=l,!0):!1}const de=it|tt|rt|et|st|g;function Ve(t,o,i,T,n){const r=(e,c)=>c*o+e,{chunkCols:f,active:s,stampGrid:l,tickParity:E}=T;for(let e=i-2;e>=0;e--){const c=e>>V,u=n()<.5;for(let L=0;L<f;L++){const M=u?L:f-1-L;if(!s[c*f+M])continue;const a=M<<V,P=Math.min(a+p,o),b=P-a;for(let x=0;x<b;x++){const A=u?a+x:P-1-x,R=e*o+A,W=t[R];if(W===0||l[R]===E)continue;l[R]=E;const C=X[W];if(C&Bt||C&bt)continue;if(C&de){if(C&g){switch(W){case 23:_e(t,A,e,R,o,i,n);break;case 24:xe(t,A,e,R,o,i,n);break;case 27:Ge(t,A,e,R,o,i,n);break;case 29:De(t,A,e,R,o,i,n);break;case 30:Ce(t,A,e,R,o,i,n);break;case 44:me(t,A,e,R,o,i,n);break;case 57:ye(t,A,e,R,o,i,n);break;case 60:ke(t,A,e,R,o,i,n);break}T.wakeRadius(A,e,We[W]??2)}else if(C&it)W===35||W===34||W===36?$t(t,A,e,R,W,o,i,u,n):W===39&&gt(t,R,n);else if(C&tt)switch(W){case 9:ne(t,A,e,R,o,i,n);break;case 15:oe(t,A,e,R,o,i,n);break;case 16:fe(t,A,e,R,o,i,n);break;case 62:Ee(t,A,e,R,o,i,n);break;case 63:ce(t,A,e,R,o,i,n);break;case 64:Te(t,A,e,R,o,i,n);break;case 65:se(t,A,e,R,o,i,n);break}else if(C&rt)switch(W){case 41:Le(t,A,e,R,o,i,n);break;case 42:Me(t,A,e,R,o,i,n);break;case 46:Re(t,A,e,R,o,i,n);break;case 47:ae(t,A,e,R,o,i,n);break;case 52:Ie(t,A,e,R,o,i,n);break}else if(C&et)switch(W){case 45:Ae(t,A,e,R,o,i,n);break;case 49:Pe(t,A,e,R,o,i,n);break}else if(C&st)switch(W){case 5:Se(t,A,e,R,o,i,n);break;case 48:he(t,A,e,R,o,i,n);break;case 51:Ye(t,A,e,R,o,i,n);break}continue}if(W===17){Ne(t,A,e,R,o,i,n);continue}if(W===18){Oe(t,A,e,R,o,i,n);continue}if(W===19){Ue(t,A,e,R,o,i,n);continue}if(W===20){Be(t,A,e,R,o,i,n);continue}if(W===53){Fe(t,A,e,R,o,i,n);continue}if(W===56){be(t,A,e,R,o,i,n);continue}const h=r(A,e+1),S=e<i-1?t[h]:W;if(W===11){const O=e>0?t[r(A,e-1)]:0;if(S!==0&&S!==2&&S!==11||O!==0&&O!==2&&O!==11){for(let U=-12;U<=12;U++)for(let _=-12;_<=12;_++)if(_*_+U*U<=144){const G=A+_,d=e+U;if(G>=0&&G<o&&d>=0&&d<i){const D=r(G,d),m=t[D];m===2?t[D]=n()<.7?4:0:m!==4&&m!==12&&(t[D]=6)}}continue}if(t[R]!==11)continue;if(S===0)t[h]=11,t[R]=0,l[h]=E;else if(S===2)t[h]=11,t[R]=2,l[h]=E;else{const Y=n()<.5?-1:1,U=A+Y,_=A-Y;if(U>=0&&U<o&&t[r(U,e+1)]===0){const G=r(U,e+1);t[G]=11,t[R]=0,l[G]=E}else if(_>=0&&_<o&&t[r(_,e+1)]===0){const G=r(_,e+1);t[G]=11,t[R]=0,l[G]=E}else if(U>=0&&U<o&&t[r(U,e)]===0){const G=r(U,e);t[G]=11,t[R]=0,l[G]=E}else if(_>=0&&_<o&&t[r(_,e)]===0){const G=r(_,e);t[G]=11,t[R]=0,l[G]=E}}continue}if(W===22){for(let O=0;O<2;O++){const I=Math.floor(n()*3)-1,Y=Math.floor(n()*3)-1;if(I===0&&Y===0)continue;const U=A+I,_=e+Y;if(U>=0&&U<o&&_>=0&&_<i){const G=t[r(U,_)];if(G===6||G===10||G===19||G===42){for(let D=-6;D<=6;D++)for(let m=-6;m<=6;m++)if(m*m+D*D<=36){const at=A+m,Pt=e+D;if(at>=0&&at<o&&Pt>=0&&Pt<i){const mt=r(at,Pt),It=t[mt];It!==4&&It!==12&&It!==2&&(t[mt]=6)}}break}}}if(t[R]!==22)continue;if(S===0)t[h]=22,t[R]=0,l[h]=E;else if(S===2)t[h]=22,t[R]=2,l[h]=E;else{const O=n()<.5?-1:1,I=A+O,Y=A-O;if(I>=0&&I<o&&t[r(I,e+1)]===0){const U=r(I,e+1);t[U]=22,t[R]=0,l[U]=E}else if(Y>=0&&Y<o&&t[r(Y,e+1)]===0){const U=r(Y,e+1);t[U]=22,t[R]=0,l[U]=E}}continue}if(W===14){for(let O=0;O<2;O++){const I=Math.floor(n()*3)-1,Y=Math.floor(n()*3)-1;if(I===0&&Y===0)continue;const U=A+I,_=e+Y;if(U>=0&&U<o&&_>=0&&_<i){const G=t[r(U,_)];if(G===6||G===10||G===19||G===42){t[R]=7;break}}}if(t[R]!==14||n()<.6)continue;if(S===0)t[h]=14,t[R]=0,l[h]=E;else{const O=n()<.5?-1:1,I=A+O;if(I>=0&&I<o&&t[r(I,e+1)]===0){const Y=r(I,e+1);t[Y]=14,t[R]=0,l[Y]=E}else if(I>=0&&I<o&&t[r(I,e)]===0&&n()<.3){const Y=r(I,e);t[Y]=14,t[R]=0,l[Y]=E}}continue}if(W===43){let O=!1;if(n()<.4)for(let I=-1;I<=1&&!O;I++)for(let Y=-1;Y<=1&&!O;Y++){if(I===0&&Y===0)continue;const U=A+Y,_=e+I;if(U>=0&&U<o&&_>=0&&_<i){const G=t[r(U,_)];(G===6||G===10||G===19||G===42)&&n()<.6?(t[R]=2,O=!0):G===2&&n()<.04&&(t[r(U,_)]=12)}}if(O)continue;if(n()<.25&&S===0)t[h]=43,t[R]=0,l[h]=E;else if(n()<.1){const I=n()<.5?-1:1;if(A+I>=0&&A+I<o&&t[r(A+I,e+1)]===0){const Y=r(A+I,e+1);t[Y]=43,t[R]=0,l[Y]=E}}continue}if(C&Ft)continue;let N=!1;C&Ut&&(N=He(t,A,e,R,o,i,W,n,l,E)),!N&&C&Tt&&ve(t,A,e,R,o,W,n,l,E)}}}}function pe(t,o,i,T,n){const{chunkCols:r,chunkRows:f,renderDirty:s}=n;for(let l=0;l<f;l++)for(let E=0;E<r;E++){const e=l*r+E;if(!s[e])continue;s[e]=0;const c=l<<V,u=E<<V,L=Math.min(c+p,i),M=Math.min(u+p,o);for(let a=c;a<L;a++){const P=a*o;for(let b=u;b<M;b++){const x=P+b,A=t[x];A===0?T[x]=$:A===6?T[x]=ht[b+a&31]:A===10?T[x]=Yt[b+a&63]:A===13?T[x]=Nt[b+a&31]:A===59?T[x]=Ot[b+a&31]:T[x]=F[A]}}}}function Ke(t){return t>0&&(X[t]&g)!==0}function xt(t){let o=t|0;return function(){o=o+1831565813|0;let i=Math.imul(o^o>>>15,1|o);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}let K=null,j=null,ot=null,ft=null,Et=null,q=null,H=new Uint8Array(0),k=0,v=0,Gt=!1,Lt=[];const w=new le;let ct=xt(Date.now()),Mt=0,At=0,Q=St;function we(t,o){k=kt,v=Ht,H=new Uint8Array(k*v),ot=new OffscreenCanvas(k,v),ft=ot.getContext("2d"),Et=ft.createImageData(k,v),q=new Uint32Array(Et.data.buffer),q.fill($),Q=St;const i=t/Q,T=o/Q;Mt=Math.max(0,(k-i)/2),At=Math.max(0,v-T),w.init(k,v)}function Dt(t,o,i,T){const n=i==="erase"?0:yt[i];if(n===30){if(t>=0&&t<k&&o>=0&&o<v){const r=o*k+t;H[r]!==4&&H[r]!==23&&H[r]!==30&&H[r]!==60&&(H[r]=30)}w.wakeRadius(t,o,1);return}for(let r=-T;r<=T;r++)for(let f=-T;f<=T;f++)if(f*f+r*r<=T*T){const s=t+f,l=o+r;if(s>=0&&s<k&&l>=0&&l<v){const E=l*k+s;let e=.55;n===21||n===25||n===61?e=.85:n===15||n===9||n===14?e=.75:n===16||n===17?e=.92:(n===45||n===50)&&(e=.65),(i==="erase"||ct()>e&&H[E]===0)&&(H[E]=n)}}w.wakeRadius(t,o,T+1)}function qe(){if(!j||!K||!ft||!ot||!Et||!q)return;pe(H,k,v,q,w),ft.putImageData(Et,0,0);const t=K.width,o=K.height,i=t/Q,T=o/Q,n=Math.max(0,k-i),r=Math.max(0,v-T),f=Math.max(0,Math.min(Mt,n)),s=Math.max(0,Math.min(At,r));j.fillStyle="#1a1a1a",j.fillRect(0,0,t,o),j.imageSmoothingEnabled=!1,j.drawImage(ot,f,s,i,T,0,0,t,o)}let z=0,Z=0;const Rt=1e3/60;function Ct(t){z===0&&(z=t);const o=Math.min(t-z,100);z=t;for(const i of Lt){const T=i.x-i.prevX,n=i.y-i.prevY,r=Math.max(Math.abs(T),Math.abs(n));if(r===0)Dt(i.x,i.y,i.tool,i.brushSize);else for(let f=0;f<=r;f++){const s=f/r,l=Math.round(i.prevX+T*s),E=Math.round(i.prevY+n*s);Dt(l,E,i.tool,i.brushSize)}}Lt=[],Gt||(Z+=o,Z>=Rt&&(w.flipTick(),ue(H,k,v,w,ct),Ve(H,k,v,w,ct),w.updateActivity(H,Ke),Z=Math.min(Z-Rt,Rt))),qe(),requestAnimationFrame(Ct)}self.onmessage=t=>{const{type:o,data:i}=t.data;switch(o){case"init":K=t.data.canvas,j=K.getContext("2d"),we(K.width,K.height),z=0,Z=0,requestAnimationFrame(Ct);break;case"resize":K&&(K.width=i.width,K.height=i.height);break;case"input":Lt.push({x:i.cellX,y:i.cellY,prevX:i.prevX??i.cellX,prevY:i.prevY??i.cellY,tool:i.tool,brushSize:i.brushSize});break;case"camera":Mt=i.camX,At=i.camY,Q=i.zoom;break;case"pause":Gt=i.paused;break;case"reset":H.fill(0),w.wakeAll(),ct=xt(Date.now()),q&&q.fill($);break;case"save":{const n=8+H.length,r=new ArrayBuffer(n),f=new DataView(r),s=new Uint8Array(r);s[0]=83,s[1]=65,s[2]=78,s[3]=68,f.setUint16(4,k,!0),f.setUint16(6,v,!0),s.set(H,8),self.postMessage({type:"saveData",data:r},[r]);break}case"load":{const T=i.buffer,n=new DataView(T),r=new Uint8Array(T);if(r[0]!==83||r[1]!==65||r[2]!==78||r[3]!==68)break;const f=n.getUint16(4,!0),s=n.getUint16(6,!0);if(f!==k||s!==v)break;const l=8;H.set(r.subarray(l,l+k*v)),w.wakeAll(),q&&q.fill($);break}}}})();
